---
title: "Final Project"
subtitle: "EPIB 677, Winter 2020, McGill University"
author: "Zharmaine Ante, Demy Dam, Ornella Wafo Noubissie" 
date: "`r Sys.Date()`"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

```{r include = FALSE}
## ---- Setup ------------------------------------------------------------------
knitr::opts_chunk$set(
  echo = TRUE,           # show code
  warning = FALSE,       # don't show warnings
  message = FALSE,       # don't show messages (less serious warnings)
  cache = FALSE,         # set to TRUE to save results from last compilation
  fig.align = "center",  # center figures
  fig.asp = 1,           # fig.aspect ratio
  fig.width = 4          # fig width
)
```

# Abstract (1 page)

# Introduction (1 page)

# Analysis Plan (2 pages)

**State the methods used**

**Explain why those methods were chosen**


# Descriptive and Univariate Analyses (3 pages)

**Basic descriptive analyses:** means, medians, percentages, etc. 

**Graphics:** histograms, scatter plots, etc. 
You do not need to be complete here, aim for including the descriptive results which best set up the inferential analyses which are to follow.

## Data Cleaning

```{r, echo = F}
# Loading packages
library(dplyr)
```

**Hong Kong line list of COVID-19**

```{r, echo = F}
# Read in the COVID-19 line list from HK
linelist <- read.csv("Hong Kong Line List.csv", header = T)
# summary(linelist)

# Create binary variables to prepare for aggregationn
linelist <- linelist %>%
              mutate(
                Male = ifelse(Gender == "M", 1, 0),
                # Age.0.14 = ifelse(Age >= 0 & Age < 15, 1, 0),
                # Age.15.24 = ifelse(Age >= 15 & Age < 25, 1, 0),
                # Age.25.64 = ifelse(Age >= 25 & Age < 65, 1, 0),
                # Age.65 = ifelse(Age >= 65, 1, 0),
                Cases = 1,
                Deaths = ifelse(linelist$Outcomes == "Deceased", 1, 0),
                Imported = ifelse(linelist$Case.classification == "Imported", 1, 0), # Note: disregarded other categories
                Resident = ifelse(linelist$HK.residents == "HK resident", 1, 0), # Note: there were 2 unknowns
                Proxy = ifelse(linelist$Proxy == "Yes", 1, 0) # Note: hospital location used as proxy
              )

# Rearrange dataframe to prepare for aggregation
linelist <- linelist %>%
              select(Case.ID, Region, District, Male, Age, # Age.0.14, Age.15.24, Age.25.64, Age.65,
                     Cases, Deaths, Proxy, Imported, Resident)

# Aggregate dataframe by Region, District, Gender
linelist.agg <- linelist %>%
                  group_by(Region, District) %>%
                  summarise(Cases = sum(Cases),
                            Deaths = sum(Deaths),
                            # P.age.0.14 = sum(Age.0.14)/sum(Cases),
                            # P.age.15.24 = sum(Age.15.24)/sum(Cases),
                            # P.age.25.64 = sum(Age.25.64)/sum(Cases),
                            # P.age.65 = sum(Age.65)/sum(Cases),
                            Age = mean(Age),
                            P.male = sum(Male)/sum(Cases),
                            Proxy = sum(Proxy),
                            Imported = sum(Imported),
                            Resident = sum(Resident))

# Summary of cleaned and aggregated data
summary(linelist.agg)
```

**Hong Kong covariates dataset**

```{r, echo = F}
# Updated covariates dataset
Covariates <- read.csv("Hong Kong Covariates V2.csv")
```

**Merging case dataset with covariates dataset**

```{r, echo = F}
# Merging the datasets by district
data <- merge(x = linelist.agg, y = Covariates, by = "District")
summary(data)
```

## Boxplots by district and region

```{r, echo = F}
library(ggplot2)
library(gridExtra)
library(ggthemes)
library(pander)

#Plots of variables by Region


# create graphing function
HK.district.boxplots <- function(df, na.rm = TRUE, ...){
  
  # create for loop to produce ggplot2 graphs 
  for (i in seq_along(names(df[,3:ncol(df)]))) { 
    
    # create plot for each district in df 
    plot <- 
      ggplot(df,
             aes(Region, df[,i],group = District, colour = Region)) + 
      
      geom_boxplot(size=6, notch = T) +
      
      theme_pander() +
      theme(legend.position="none") + 
      labs(y="Value")+
      
      ggtitle(paste(names(Covariates[i]), '\n', 
                    "By Region \n",
                    sep=''))

    # print plots to screen
    print(plot)
  }
}

# run graphing function on long df
HK.district.boxplots(Covariates)
```

## Boxplot by region

```{r, echo = F}


# create graphing function
HK.region.boxplots <- function(df, na.rm = TRUE, ...){
  
  # create for loop to produce ggplot2 graphs 
  for (i in seq_along(names(df[,3:ncol(df)]))) { 
    
    # create plot for each district in df 
    plot <- 
      ggplot(df,
             aes( x=Region, y=df[,i], fill = Region)) + 
      
      geom_boxplot(size=1, notch = F) +
      
      theme_pander() +
      theme(legend.position="none") + 
      labs(y="Value")
      
      ggtitle(paste(names(covariates[i]), '\n', 
                    "By Region \n",
                    sep=''))

    # print plots to screen
    print(plot)
  }
}

# run graphing function on long df
HK.region.boxplots(covariates)


```

## Histograms

```{r, echo = F}

# create graphing function
HK.histogram <- function(df, na.rm = TRUE, ...){
  
  # create for loop to produce ggplot2 graphs 
  for (i in seq_along(names(df[,3:ncol(df)]))) { 
    
    # create plot for each district in df 
    plot <- ggplot(df, aes(df[,i])) + 
      geom_bar(position="dodge", aes(fill=Region, size=2) )+
      #facet_wrap(~Region)
      theme_pander() +
      theme(legend.position="none") + 
      labs(y="Value", x= paste(names(Covariates[i])))+
      
      ggtitle(paste(names(Covariates[i]), '\n', 
                    "By Region \n",
                    sep=''))
    # print plots to screen
    print(plot)
  }
}

# run graphing function on long df
HK.histogram(Covariates)
```

## Exploratory analysis
```{r}
# Histograms
library(ggplot2)
library(gridExtra)
library(tidyr)
hist.data <- subset(data, select = c(District, Cases, Male.Count, Female.Count, Area_km2,
                                       Monthly.income..HKD., Pct_0.14, Pct_15.24, Pct_25.64, Pct_65.))
hist.data$TotalPop <- hist.data$Male.Count + hist.data$Female.Count
hist.data$Rate <- (hist.data$Cases/hist.data$TotalPop)*100000
hist.data$PropMale <- (hist.data$Male.Count/hist.data$TotalPop)*100
hist.data$PropFemale <- (hist.data$Female.Count/hist.data$TotalPop)*100
hist.data$PopDensity <- hist.data$TotalPop/hist.data$Area_km2

hist.data %>% 
  select(Cases, Rate, PopDensity, PropMale, PropFemale, 
         Pct_0.14, Pct_15.24, Pct_25.64, Pct_65., Monthly.income..HKD.) %>%
  gather() %>%                             
  ggplot(aes(value)) +                     
    facet_wrap(~key, scales = "free") +    
    geom_histogram(bins = 5) +
    xlab("") + ylab("Frequency")

# More data manipulation
## 1) New age categories: 0-24, 25-64, 65+, re-calculate total population and pop density
data$Pct_0.24 = data$Pct_0.14 + data$Pct_15.24
data$Total.Population = data$Male.Count + data$Female.Count
data$Pop.Density = data$Total.Population/data$Area_km2

# Calculate expected cases and SIR using standardization
tot.case = sum(data$Cases)
tot.pop = sum(data$Total.Population)
ave.rate = tot.case/tot.pop
data$Expected = ave.rate*data$Total.Population
data$SIR = data$Cases/data$Expected

# Histogram of SIR and new covariates
sir <- ggplot(data = data, aes(SIR)) + geom_histogram() +
  ylab("Frequency")
age1 <- ggplot(data = data, aes(Pct_0.24)) + geom_histogram() + ylab("Frequency") + 
  xlab("% of 0-24 yrs old")
age2 <- ggplot(data = data, aes(Pct_25.64)) + geom_histogram() + ylab("Frequency") +
  xlab("% of 25-64 yrs old")
age3 <- ggplot(data = data, aes(Pct_65.)) + geom_histogram() + ylab("Frequency") +
  xlab("% of 65+ yrs old")
income <- ggplot(data = data, aes(log(Monthly.income..HKD.))) + geom_histogram() +
  ylab("Frequency") + xlab("Log of Monthly income (HKD)")
postsec <- ggplot(data = data, aes(log(Pct_Sec.Educ))) + geom_histogram() +
  ylab("Frequency") + xlab("Log of % with Post-Secondary Education")
grid.arrange(sir, age1, age2, age3, income, postsec, ncol = 3)
```

## Mapping of the outcome and covariates
```{r}
# Coordinates by district
HKcoords <- read.csv("HK_coords.csv", header = T)
HKcoords <- HKcoords[order(HKcoords$District), ]
data$Lat <- HKcoords$Lat
data$Long <- HKcoords$Long

# Creating maps for exploratory analysis
library(spdep)
library(rgdal)
library(maptools)
library(sp)
library(RColorBrewer)
library(classInt)

# Adding variables in shapefile
shp_HK = readOGR("shp_HK/Hong_Kong_18_Districts.shp", stringsAsFactors = FALSE)
shp_HK = shp_HK[order(shp_HK$ENAME),]
shp_HK$Lat = data$Lat
shp_HK$Long = data$Long
shp_HK$Cases = data$Cases
shp_HK$Expected = data$Expected
shp_HK$SIR = data$SIR
shp_HK$Rate = (data$Cases/data$Total.Population)*100000
shp_HK$TotalPop = data$Total.Population
shp_HK$PopDens = data$Pop.Density
shp_HK$PropMale = data$Male.Count/data$Total.Population
shp_HK$PropFemale = data$Female.Count/data$Total.Population
shp_HK$Prop0_24 = data$Pct_0.24/100
shp_HK$Prop25_64 = data$Pct_25.64/100
shp_HK$Prop65 = data$Pct_65./100
shp_HK$Income = data$Monthly.income..HKD.
shp_HK$Housing = as.numeric(data$No..households)
shp_HK$HospBeds = data$Num_beds
shp_HK$SecEduc = data$Pct_Sec.Educ/100
shp_HK$PostSec = data$Pct_PostSec.w..degree/100
shp_HK$PropLabor = data$Count.Labor.force/data$Total.Population

# Converting shapefile data to dataframe object
# merge the "fortified" data with the data from our spatial object
shp_HK$id = rownames(shp_HK@data)
shp = fortify(shp_HK)
shp_HK.df = merge(shp, shp_HK@data, by = "id")

####### MAPS OF RESPONSE AND COVARIATES, BY DISTRIC #########

# Total COVID-19 cases (as continuous variable)
ggplot(data = shp_HK.df, aes(x = long, y = lat, group = group), colour = "black", fill = NA) +
  geom_polygon(data = shp_HK.df, aes(fill = Cases)) + 
  ggtitle("Total COVID-19 cases, by district") +
  scale_fill_continuous(high = "#132B43", low = "#56B1F7") +
  theme(legend.title = element_blank(),
        legend.justification=c(1,0), 
        legend.position=c(1,0),
        plot.title = element_text(hjust = 0.5),
        axis.text = element_blank(),
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_blank(), 
        panel.background = element_blank())

# Total COVID-19 cases (as discrete variable)
brks <-classIntervals(shp_HK$Cases, n=5, style="quantile")
brks <- brks$brks
shp_HK.df$CasesCat[shp_HK.df$Cases < 10] = 0
shp_HK.df$CasesCat[shp_HK.df$Cases >= 10 & shp_HK.df$Cases < 15] = 1
shp_HK.df$CasesCat[shp_HK.df$Cases >= 15 & shp_HK.df$Cases < 20] = 2
shp_HK.df$CasesCat[shp_HK.df$Cases >= 20 & shp_HK.df$Cases < 43] = 3
shp_HK.df$CasesCat[shp_HK.df$Cases >= 43] = 4
shp_HK.df$CasesCat = factor(shp_HK.df$CasesCat, levels = 0:4, labels = c("<10", "10-14", "15-19", "20-42", ">42"))

plota =
  ggplot(data = shp_HK.df, aes(x = long, y = lat, group = group), colour = "black", fill = NA) +
  geom_polygon(data = shp_HK.df, aes(fill = CasesCat)) + 
  scale_fill_brewer(palette = "YlOrRd") +
  ggtitle("Total COVID-19 cases") +
  theme(legend.title = element_blank(),
        legend.justification=c(1,0), 
        legend.position=c(1,0),
        plot.title = element_text(hjust = 0.5),
        axis.text = element_blank(),
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_blank(), 
        panel.background = element_blank())

# Rate per 100,000
brks <-classIntervals(shp_HK$Rate, n=5, style="quantile")
brks <- brks$brks
shp_HK.df$RateCat[shp_HK.df$Rate < brks[2]] = 0
shp_HK.df$RateCat[shp_HK.df$Rate >= brks[2] & shp_HK.df$Rate < brks[3]] = 1
shp_HK.df$RateCat[shp_HK.df$Rate >= brks[3] & shp_HK.df$Rate < brks[4]] = 2
shp_HK.df$RateCat[shp_HK.df$Rate >= brks[4] & shp_HK.df$Rate < brks[5]] = 3
shp_HK.df$RateCat[shp_HK.df$Rate >= brks[5]] = 4
shp_HK.df$RateCat = factor(shp_HK.df$RateCat, levels = 0:4, labels = c("<2.5", "2.5-3.2", "3.2-4.5", "4.5-13.6", ">13.6"))

plota2 =
  ggplot(data = shp_HK.df, aes(x = long, y = lat, group = group), colour = "black", fill = NA) +
  geom_polygon(data = shp_HK.df, aes(fill = RateCat)) + 
  scale_fill_brewer(palette = "YlOrRd") +
  ggtitle("Rate of COVID-19 per 100,000") +
  theme(legend.title = element_blank(),
        legend.justification=c(1,0), 
        legend.position=c(1,0),
        plot.title = element_text(hjust = 0.5),
        axis.text = element_blank(),
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_blank(), 
        panel.background = element_blank())

grid.arrange(plota, plota2)

# SIR 
plota3 =
  ggplot(data = shp_HK.df, aes(x = long, y = lat, group = group), colour = "black", fill = NA) +
  geom_polygon(data = shp_HK.df, aes(fill = SIR)) + 
  scale_fill_continuous(high = "#132B43", low = "#56B1F7") +
  ggtitle("Standardized Incidence Ratio") +
  theme(legend.title = element_blank(),
        legend.justification=c(1,0), 
        legend.position=c(1,0),
        plot.title = element_text(hjust = 0.5),
        axis.text = element_blank(),
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_blank(), 
        panel.background = element_blank())

grid.arrange(plota2, plota3, ncol = 2)

# Population density
plotb = 
  ggplot(data = shp_HK.df, aes(x = long, y = lat, group = group), colour = "black", fill = NA) +
  geom_polygon(data = shp_HK.df, aes(fill = PopDens)) + 
  ggtitle("Population density") +
  scale_fill_continuous(high = "#132B43", low = "#56B1F7") +
  theme(legend.title = element_blank(),
        legend.justification=c(1,0), 
        legend.position=c(1,0),
        plot.title = element_text(hjust = 0.5),
        axis.text = element_blank(),
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_blank(), 
        panel.background = element_blank())

# Male population
plotc = 
  ggplot(data = shp_HK.df, aes(x = long, y = lat, group = group), colour = "black", fill = NA) +
  geom_polygon(data = shp_HK.df, aes(fill = PropMale)) + 
  ggtitle("Proportion of males") +
  scale_fill_continuous(high = "#132B43", low = "#56B1F7") +
  theme(legend.title = element_blank(),
        legend.justification=c(1,0), 
        legend.position=c(1,0),
        plot.title = element_text(hjust = 0.5),
        axis.text = element_blank(),
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_blank(), 
        panel.background = element_blank())

# Female population
plotd = 
  ggplot(data = shp_HK.df, aes(x = long, y = lat, group = group), colour = "black", fill = NA) +
  geom_polygon(data = shp_HK.df, aes(fill = PropFemale)) + 
  ggtitle("Proportion of females") +
  scale_fill_continuous(high = "#132B43", low = "#56B1F7") +
  theme(legend.title = element_blank(),
        legend.justification=c(1,0), 
        legend.position=c(1,0),
        plot.title = element_text(hjust = 0.5),
        axis.text = element_blank(),
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_blank(), 
        panel.background = element_blank())

# Older population
plote = 
  ggplot(data = shp_HK.df, aes(x = long, y = lat, group = group), colour = "black", fill = NA) +
  geom_polygon(data = shp_HK.df, aes(fill = Prop65)) + 
  ggtitle("Proportion of 65 and above") +
  scale_fill_continuous(high = "#132B43", low = "#56B1F7") +
  theme(legend.title = element_blank(),
        legend.justification=c(1,0), 
        legend.position=c(1,0),
        plot.title = element_text(hjust = 0.5),
        axis.text = element_blank(),
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_blank(), 
        panel.background = element_blank())

# Younger population
plotf =
  ggplot(data = shp_HK.df, aes(x = long, y = lat, group = group), colour = "black", fill = NA) +
  geom_polygon(data = shp_HK.df, aes(fill = Prop15_24)) + 
  ggtitle("Proportion of 15-24 years old") +
  scale_fill_continuous(high = "#132B43", low = "#56B1F7") +
  theme(legend.title = element_blank(),
        legend.justification=c(1,0), 
        legend.position=c(1,0),
        plot.title = element_text(hjust = 0.5),
        axis.text = element_blank(),
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_blank(), 
        panel.background = element_blank())

grid.arrange(plota2, plotb, plotc, plotd, plote, plotf)

# Population of 0-14 years old 
plotg =
  ggplot(data = shp_HK.df, aes(x = long, y = lat, group = group), colour = "black", fill = NA) +
  geom_polygon(data = shp_HK.df, aes(fill = Prop0_14)) + 
  ggtitle("Proportion of 0-14 years old") +
  scale_fill_continuous(high = "#132B43", low = "#56B1F7") +
  theme(legend.title = element_blank(),
        legend.justification=c(1,0), 
        legend.position=c(1,0),
        plot.title = element_text(hjust = 0.5),
        axis.text = element_blank(),
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_blank(), 
        panel.background = element_blank())

# Population of 25-64 years old
ploth =
  ggplot(data = shp_HK.df, aes(x = long, y = lat, group = group), colour = "black", fill = NA) +
  geom_polygon(data = shp_HK.df, aes(fill = Prop25_64)) + 
  ggtitle("Proportion of 25-64 years old") +
  scale_fill_continuous(high = "#132B43", low = "#56B1F7") +
  theme(legend.title = element_blank(),
        legend.justification=c(1,0), 
        legend.position=c(1,0),
        plot.title = element_text(hjust = 0.5),
        axis.text = element_blank(),
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_blank(), 
        panel.background = element_blank())

# Proportion of Post-Sec Educ
ploti =
  ggplot(data = shp_HK.df, aes(x = long, y = lat, group = group), colour = "black", fill = NA) +
  geom_polygon(data = shp_HK.df, aes(fill = PostSec)) + 
  ggtitle("Proportion with Post-Secondary Education") +
  scale_fill_continuous(high = "#132B43", low = "#56B1F7") +
  theme(legend.title = element_blank(),
        legend.justification=c(1,0), 
        legend.position=c(1,0),
        plot.title = element_text(hjust = 0.5),
        axis.text = element_blank(),
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_blank(), 
        panel.background = element_blank())

# Proportion of Secondary education and higher
plotj =
  ggplot(data = shp_HK.df, aes(x = long, y = lat, group = group), colour = "black", fill = NA) +
  geom_polygon(data = shp_HK.df, aes(fill = SecEduc)) + 
  ggtitle("Proportion with Secondary Education and higher") +
  scale_fill_continuous(high = "#132B43", low = "#56B1F7") +
  theme(legend.title = element_blank(),
        legend.justification=c(1,0), 
        legend.position=c(1,0),
        plot.title = element_text(hjust = 0.5),
        axis.text = element_blank(),
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_blank(), 
        panel.background = element_blank())

# Number of housing units
plotk =
  ggplot(data = shp_HK.df, aes(x = long, y = lat, group = group), colour = "black", fill = NA) +
  geom_polygon(data = shp_HK.df, aes(fill = Housing)) + 
  ggtitle("Number of Households") +
  scale_fill_continuous(high = "#132B43", low = "#56B1F7") +
  theme(legend.title = element_blank(),
        legend.justification=c(1,0), 
        legend.position=c(1,0),
        plot.title = element_text(hjust = 0.5),
        axis.text = element_blank(),
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_blank(), 
        panel.background = element_blank())

# Average number of beds per hospital
plotl =
  ggplot(data = shp_HK.df, aes(x = long, y = lat, group = group), colour = "black", fill = NA) +
  geom_polygon(data = shp_HK.df, aes(fill = HospBeds)) + 
  ggtitle("Average number of beds per hospital") +
  scale_fill_continuous(high = "#132B43", low = "#56B1F7") +
  theme(legend.title = element_blank(),
        legend.justification=c(1,0), 
        legend.position=c(1,0),
        plot.title = element_text(hjust = 0.5),
        axis.text = element_blank(),
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_blank(), 
        panel.background = element_blank())

grid.arrange(plotg, ploth, ploti, plotj, plotk, plotl, ncol = 2)
```

## Spatial autocorrelation test
```{r}
############################# Build neighborhood object #############################
coords <- as.matrix(subset(HKcoords, select = c(Long, Lat)))
IDs <- shp_HK$ENAME

# 1) Having contiguous boundary point
HK.nb <- poly2nb(shp_HK, row.names = IDs)
summary(HK.nb)

# 2) Having 3 nearest neighbors
HK.nb3 <- knn2nb(knearneigh(coords, k = 3, longlat = TRUE), row.names = IDs, sym = T)
summary(HK.nb3)

# 3) Having 5 nearest neighbors
HK.nb5 <- knn2nb(knearneigh(coords, k = 5, longlat = TRUE), row.names = IDs, sym = T)

## Plot neighbourhood structure
plot(shp_HK, border="grey", main="Neighbors based on contiguous border", cex.main = 0.5)
plot(HK.nb, coords, add=TRUE)

par(mfrow = c(1,2))
plot(shp_HK, border="grey", main="K = 3 nearest neighbors")
plot(HK.nb3, coords, add=TRUE)

plot(shp_HK, border="grey", main="K = 5 nearest neighbors")
plot(HK.nb5, coords, add=TRUE)
par(mfrow = c(1,1))

## Converting nb objects to weight list
HK.wnb <-  nb2listw(HK.nb, style = "B", zero.policy = T)
HK.wnb3 <- nb2listw(HK.nb3, style = "B")
HK.wnb5 <- nb2listw(HK.nb5, style = "B")

## Moran test for SIR
#Test 1: SIR for COVID-19, neighbors based on contiguous boundary
moran.sir1 <- moran.test(data$SIR, HK.wnb, zero.policy = T)
moran.sir1

#Test 2: SIR, k = 3 nearest neighbors
moran.sir2 <- moran.test(data$SIR, HK.wnb3)
moran.sir2

#Test 3: SIR, k = 5 nearest neighbors
moran.sir3 <- moran.test(data$SIR, HK.wnb5)
moran.sir3

## Moran test for residuals
newdata <- subset(data, select = c(Cases, Expected, Total.Population, Male.Count, Female.Count,
                                   Pop.Density, Num_hosp, Num_beds, Count.Labor.force, 
                                   Monthly.income..HKD., No..households, Pct_0.24, Pct_25.64,
                                   Pct_65., Pct_Sec.Educ, Pct_PostSec.w..degree))

# Some data manipulation
newdata$PropMale <- newdata$Male.Count/newdata$Total.Population
newdata$PropFemale <- newdata$Female.Count/newdata$Total.Population
newdata$PropLabor <- newdata$Count.Labor.force/newdata$Total.Population
newdata$Pct_0.24 <- newdata$Pct_0.24/100
newdata$Pct_25.64 <- newdata$Pct_25.64/100
newdata$Pct_65. <- newdata$Pct_65./100
newdata$Pct_PostSec.w..degree <- newdata$Pct_PostSec.w..degree/100
newdata$Pct_Sec.Educ <- newdata$Pct_Sec.Educ/100

poi.fit1 <- glm(Cases ~ Pop.Density + offset(log(Expected)), data = newdata, family = poisson(link="log"))
poi.fit2 <- glm(Cases ~ PropFemale + offset(log(Expected)), data = newdata, family = poisson(link="log"))
poi.fit3 <- glm(Cases ~ Pct_0.24 + Pct_25.64 + Pct_65. + offset(log(Expected)), 
                data = newdata, family = poisson(link="log"))
poi.fit4 <- glm(Cases ~ Pop.Density + PropFemale+ Pct_0.24 + Pct_25.64 + Pct_65. + offset(log(Expected)), 
                data = newdata, family = poisson(link="log"))

#Test 4: Residuals, neighbors based on continguous boundary
moran.lm1 <- lm.morantest(poi.fit1, HK.wnb, zero.policy = T)
moran.lm2 <- lm.morantest(poi.fit2, HK.wnb, zero.policy = T)
moran.lm3 <- lm.morantest(poi.fit3, HK.wnb, zero.policy = T)
moran.lm4 <- lm.morantest(poi.fit4, HK.wnb, zero.policy = T)

moran.lm1
moran.lm2
moran.lm3
moran.lm4
```

# Summary of Inferential Results (3 pages)

# Conclusion (1 page)

# Appendix
