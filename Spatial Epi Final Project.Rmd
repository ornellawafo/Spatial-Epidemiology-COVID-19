---
title: "Final Project"
subtitle: "EPIB 677, Winter 2020, McGill University"
author: "Zharmaine Ante, Demy Dam, Ornella Wafo Noubissie" 
date: "`r Sys.Date()`"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

```{r include = FALSE}
## ---- Setup ------------------------------------------------------------------
knitr::opts_chunk$set(
  echo = TRUE,           # show code
  warning = FALSE,       # don't show warnings
  message = FALSE,       # don't show messages (less serious warnings)
  cache = FALSE,         # set to TRUE to save results from last compilation
  fig.align = "center",  # center figures
  fig.asp = 1,           # fig.aspect ratio
  fig.width = 4          # fig width
)
```

# Abstract (1 page)

# Introduction (1 page)

# Analysis Plan (2 pages)

**State the methods used**

**Explain why those methods were chosen**


# Descriptive and Univariate Analyses (3 pages)

**Basic descriptive analyses:** means, medians, percentages, etc. 

**Graphics:** histograms, scatter plots, etc. 
You do not need to be complete here, aim for including the descriptive results which best set up the inferential analyses which are to follow.

## Data Cleaning

```{r, echo = F}
# Loading packages
library(dplyr)
library(tidyr)

# Creating maps for exploratory analysis
library(spdep)
library(rgdal)
library(maptools)
library(sp)
library(RColorBrewer)
library(classInt)

# Creating graphs
library(ggplot2)
library(gridExtra)
library(ggthemes)
library(pander)

#Models
library(CARBayes)
library(nimble)
```

**Hong Kong line list of COVID-19**

```{r, echo = F}
# Read in the COVID-19 line list from HK
Linelist <- read.csv("Hong Kong Line List.csv", header = T)

# Create binary variables to prepare for aggregationn
linelist <- Linelist %>%
              mutate(
                Male = ifelse(Gender == "M", 1, 0),
                # Age.0.14 = ifelse(Age >= 0 & Age < 15, 1, 0),
                # Age.15.24 = ifelse(Age >= 15 & Age < 25, 1, 0),
                # Age.25.64 = ifelse(Age >= 25 & Age < 65, 1, 0),
                # Age.65 = ifelse(Age >= 65, 1, 0),
                Cases = 1,
                Deaths = ifelse(Linelist$Outcomes == "Deceased", 1, 0),
                Imported = ifelse(Linelist$Case.classification == "Imported", 1, 0), # Note: disregarded other categories
                Resident = ifelse(Linelist$HK.residents == "HK resident", 1, 0), # Note: there were 2 unknowns
                Proxy = ifelse(Linelist$Proxy == "Yes", 1, 0) # Note: hospital location used as proxy
              )

# Rearrange dataframe to prepare for aggregation
linelist <- linelist %>%
              select(Case.ID, Region, District, Male, Age, # Age.0.14, Age.15.24, Age.25.64, Age.65,
                     Cases, Deaths, Proxy, Imported, Resident)

# Aggregate dataframe by Region, District, Gender
linelist.agg <- linelist %>%
                  group_by(Region, District) %>%
                  summarise(Cases = sum(Cases),
                            Deaths = sum(Deaths),
                            # P.age.0.14 = sum(Age.0.14)/sum(Cases),
                            # P.age.15.24 = sum(Age.15.24)/sum(Cases),
                            # P.age.25.64 = sum(Age.25.64)/sum(Cases),
                            # P.age.65 = sum(Age.65)/sum(Cases),
                            Age = mean(Age),
                            P.male = sum(Male)/sum(Cases),
                            Proxy = sum(Proxy),
                            Imported = sum(Imported),
                            Resident = sum(Resident))

# Summary of cleaned and aggregated data
summary(linelist.agg)
```

**Hong Kong covariates dataset**

```{r, echo = F}
# Updated covariates dataset
Covariates <- read.csv("Hong Kong Covariates V2.csv")
head(Covariates)
summary(Covariates)

#Version 1
Covariates.v1 <- read.csv("Hong Kong Covariates.csv")
head(Covariates.v1)
summary(Covariates.v1)
```

**Merging case dataset with covariates dataset**

```{r, echo = F}
# Merging the datasets by district
data <- merge(x = linelist.agg, y = Covariates, by = "District")
summary(data)
```

## Boxplots by district and region

```{r, echo = F}
#Plots of variables by Region

# create graphing function
HK.district.boxplots <- function(df, na.rm = TRUE, ...){
  
  # create for loop to produce ggplot2 graphs 
  for (i in seq_along(names(df[,3:ncol(df)]))) { 
    
    # create plot for each district in df 
    plot <- 
      ggplot(df,
             aes(Region, df[,i],group = District, colour = Region)) + 
      
      geom_boxplot(size=6, notch = T) +
      
      theme_pander() +
      theme(legend.position="none") + 
      labs(y="Value")+
      
      ggtitle(paste(names(Covariates[i]), '\n', 
                    "By Region \n",
                    sep=''))

    # print plots to screen
    print(plot)
  }
}

# run graphing function on long df
HK.district.boxplots(Covariates)
```

## Boxplot by region

```{r, echo = F}
# create graphing function
HK.region.boxplots <- function(df, na.rm = TRUE, ...){
  
  # create for loop to produce ggplot2 graphs 
  for (i in seq_along(names(df[,3:ncol(df)]))) { 
    
    # create plot for each district in df 
    plot <- 
      ggplot(df,
             aes( x=Region, y=df[,i], fill = Region)) + 
      
      geom_boxplot(size=1, notch = F) +
      
      theme_pander() +
      theme(legend.position="none") + 
      labs(y="Value")
      
      ggtitle(paste(names(covariates[i]), '\n', 
                    "By Region \n",
                    sep=''))

    # print plots to screen
    print(plot)
  }
}

# run graphing function on long df
HK.region.boxplots(covariates)


```

## Histograms

```{r, echo = F}

# create graphing function
HK.histogram <- function(df, na.rm = TRUE, ...){
  
  # create for loop to produce ggplot2 graphs 
  for (i in seq_along(names(df[,3:ncol(df)]))) { 
    
    # create plot for each district in df 
    plot <- ggplot(df, aes(df[,i])) + 
      geom_bar(position="dodge", aes(fill=Region, size=2) )+
      #facet_wrap(~Region)
      theme_pander() +
      theme(legend.position="none") + 
      labs(y="Value", x= paste(names(Covariates[i])))+
      
      ggtitle(paste(names(Covariates[i]), '\n', 
                    "By Region \n",
                    sep=''))
    # print plots to screen
    print(plot)
  }
}

# run graphing function on long df
HK.histogram(Covariates)
```

## Exploratory analysis

```{r More data manipulation}

## 1) New age categories: 0-24, 25-64, 65+, 
data$Pct_0.24 = data$Pct_0.14 + data$Pct_15.24
data$Prop_0.24 = data$Pct_0.24/100
data$Prop_25.64 = data$Pct_25.64/100
data$Prop_65 = data$Pct_65/100

## 2) Re-calculate population-level variables, based on female and male counts
data$Total_pop = data$Male_count + data$Female_count
data$Pop_density = data$Total_pop/data$Area_km2
data$Prop_labor = data$Count_labor/data$Total_pop
data$Prop_male = data$Male_count/data$Total_pop
data$Prop_female = data$Female_count/data$Total_pop

## 3) Log-transformation of monthly income and education variables
data$Prop_sec = data$Pct_Sec/100
data$Prop_postsec = data$Pct_PostSec/100
data$Log_income = log(data$Monthly_income)
data$Log_sec = log(data$Prop_sec)
data$Log_postsec = log(data$Prop_postsec)

## 4) Calculate expected cases and SIR using standardization method
tot.case = sum(data$Cases)
tot.pop = sum(data$Total_pop)
ave.rate = tot.case/tot.pop
data$Expected = ave.rate*data$Total_pop
data$SIR = data$Cases/data$Expected

```


```{r Histograms of selected variables}


######### Histograms #########

library(tidyr)
library(dplyr)

data %>% 
 select(Cases, Pop_density, Prop_male, 
         Pct_0.24, Pct_15.24, Pct_25.64, Pct_65, 
         Log_income, Prop_labor, Prop_male_labor, Num_household,
         Log_sec, Log_postsec, Num_hosp, Num_beds) %>% ## select variables to plot
  gather() %>%                             
  ggplot(aes(value)) +                     
    facet_wrap(~key, scales = "free") +    
    geom_histogram(bins = 5) +
    xlab("") + ylab("Frequency")

# Histogram of SIR and new covariates ----------------------------------------------------------
sir <- ggplot(data = data, aes(SIR)) + geom_histogram() +
        ylab("Frequency")
age1 <- ggplot(data = data, aes(Prop_0.24)) + geom_histogram() + ylab("Frequency") + 
          xlab("Prop of 0-24 yrs old")
age2 <- ggplot(data = data, aes(Prop_25.64)) + geom_histogram() + ylab("Frequency") +
          xlab("Prop of 25-64 yrs old")
age3 <- ggplot(data = data, aes(Prop_65)) + geom_histogram() + ylab("Frequency") +
          xlab("Prop of 65+ yrs old")
income <- ggplot(data = data, aes(Log_income)) + geom_histogram() +
            ylab("Frequency") + xlab("Log(Monthly income)")
postsec <- ggplot(data = data, aes(Log_postsec)) + geom_histogram() +
            ylab("Frequency") + xlab("Log(Prop with Post-Secondary Education)")
grid.arrange(sir, age1, age2, age3, income, postsec, ncol = 3)
```

## Mapping of the outcome and covariates

```{r}
# Coordinates by district -----------------------------------------------------------------------
HKcoords <- read.csv("HK_coords.csv", header = T)
HKcoords <- HKcoords[order(HKcoords$District), ]
data$Lat <- HKcoords$Lat
data$Long <- HKcoords$Long


# Adding variables in shapefile -----------------------------------------------------------------
shp_HK = readOGR("shp_HK/Hong_Kong_18_Districts.shp", stringsAsFactors = FALSE)
shp_HK = shp_HK[order(shp_HK$ENAME),]
shp_HK$Lat = data$Lat
shp_HK$Long = data$Long
shp_HK$Cases = data$Cases
shp_HK$Expected = data$Expected
shp_HK$SIR = data$SIR
shp_HK$Rate = (data$Cases/data$Total_pop)*100000
shp_HK$TotalPop = data$Total_pop
shp_HK$PopDens = data$Pop_density
shp_HK$PropMale = data$Prop_male
shp_HK$PropFemale = data$Prop_female
shp_HK$Prop0_24 = data$Prop_0.24
shp_HK$Prop25_64 = data$Prop_25.64
shp_HK$Prop65 = data$Prop_65
shp_HK$Income = data$Monthly_income
shp_HK$Housing = data$Num_household
shp_HK$Hosp = data$N.Hospital
shp_HK$HospBeds = data$Num_beds
shp_HK$SecEduc = data$Prop_sec
shp_HK$PostSec = data$Prop_postsec
shp_HK$PropLabor = data$Prop_labor
shp_HK$PropMaleLabor = data$Pct.Male.Labor


# Converting shapefile data to dataframe object -------------------------------------------------

# merge the "fortified" data with the data from our spatial object
shp_HK$id = rownames(shp_HK@data)
shp = fortify(shp_HK)
shp_HK.df = merge(shp, shp_HK@data, by = "id")

####### MAPS OF RESPONSE AND COVARIATES, BY DISTRIC #########

# Total COVID-19 cases (as continuous variable) -------------------------------------------------
ggplot(data = shp_HK.df, aes(x = long, y = lat, group = group), colour = "black", fill = NA) +
  geom_polygon(data = shp_HK.df, aes(fill = Cases)) + 
  ggtitle("Total COVID-19 cases, by district") +
  scale_fill_continuous(high = "#132B43", low = "#56B1F7") +
  theme(legend.title = element_blank(),
        legend.justification=c(1,0), 
        legend.position=c(1,0),
        plot.title = element_text(hjust = 0.5),
        axis.text = element_blank(),
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_blank(), 
        panel.background = element_blank()) +
    coord_fixed(1.3)


# Total COVID-19 cases (as discrete variable) ---------------------------------------------------
brks <-classIntervals(shp_HK$Cases, n=5, style="quantile")
brks <- brks$brks
shp_HK.df$CasesCat[shp_HK.df$Cases < 10] = 0
shp_HK.df$CasesCat[shp_HK.df$Cases >= 10 & shp_HK.df$Cases < 15] = 1
shp_HK.df$CasesCat[shp_HK.df$Cases >= 15 & shp_HK.df$Cases < 20] = 2
shp_HK.df$CasesCat[shp_HK.df$Cases >= 20 & shp_HK.df$Cases < 43] = 3
shp_HK.df$CasesCat[shp_HK.df$Cases >= 43] = 4
shp_HK.df$CasesCat = factor(shp_HK.df$CasesCat, levels = 0:4, labels = c("<10", "10-14", "15-19", "20-42", ">42"))


# Total cases -----------------------------------------------------------------------------------
plota =
  ggplot(data = shp_HK.df, aes(x = long, y = lat, group = group), colour = "black", fill = NA) +
  geom_polygon(data = shp_HK.df, aes(fill = CasesCat)) + 
  scale_fill_brewer(palette = "YlOrRd") +
  ggtitle("Total COVID-19 cases") +
  theme(legend.title = element_blank(),
        legend.justification=c(1,0), 
        legend.position=c(1,0),
        plot.title = element_text(hjust = 0.5),
        axis.text = element_blank(),
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_blank(), 
        panel.background = element_blank()) +
    coord_fixed(1.3)


# COVID-19 rate per 100,000  - creating breaks --------------------------------------------------------------------
brks <-classIntervals(shp_HK$Rate, n=5, style="quantile")
brks <- brks$brks
shp_HK.df$RateCat[shp_HK.df$Rate < brks[2]] = 0
shp_HK.df$RateCat[shp_HK.df$Rate >= brks[2] & shp_HK.df$Rate < brks[3]] = 1
shp_HK.df$RateCat[shp_HK.df$Rate >= brks[3] & shp_HK.df$Rate < brks[4]] = 2
shp_HK.df$RateCat[shp_HK.df$Rate >= brks[4] & shp_HK.df$Rate < brks[5]] = 3
shp_HK.df$RateCat[shp_HK.df$Rate >= brks[5]] = 4
shp_HK.df$RateCat = factor(shp_HK.df$RateCat, levels = 0:4, labels = c("<2.5", "2.5-3.2", "3.2-4.5", "4.5-13.6", ">13.6"))



# Plot of Rate ------------------------------------------------------------------------------------------
plota2 =
  ggplot(data = shp_HK.df, aes(x = long, y = lat, group = group), colour = "black", fill = NA) +
  geom_polygon(data = shp_HK.df, aes(fill = RateCat)) + 
  scale_fill_brewer(palette = "YlOrRd") +
  ggtitle("Rate of COVID-19 per 100,000") +
  theme(legend.title = element_blank(),
        legend.justification=c(1,0), 
        legend.position=c(1,0),
        plot.title = element_text(hjust = 0.5),
        axis.text = element_blank(),
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_blank(), 
        panel.background = element_blank()) +
    coord_fixed(1.3)

grid.arrange(plota, plota2)


# Plot of SIR -------------------------------------------------------------------------------------------
plota3 =
  ggplot(data = shp_HK.df, aes(x = long, y = lat, group = group), colour = "black", fill = NA) +
  geom_polygon(data = shp_HK.df, aes(fill = SIR)) + 
  scale_fill_continuous(high = "#132B43", low = "#56B1F7") +
  ggtitle("Standardized Incidence Ratio") +
  theme(legend.title = element_blank(),
        legend.justification=c(1,0), 
        legend.position=c(1,0),
        plot.title = element_text(hjust = 0.5),
        axis.text = element_blank(),
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_blank(), 
        panel.background = element_blank()) +
    coord_fixed(1.3)

grid.arrange(plota2, plota3, ncol = 2)


# Plot of Population density ----------------------------------------------------------------------------
plotb = 
  ggplot(data = shp_HK.df, aes(x = long, y = lat, group = group), colour = "black", fill = NA) +
  geom_polygon(data = shp_HK.df, aes(fill = PopDens)) + 
  ggtitle("Population density") +
  scale_fill_continuous(high = "#132B43", low = "#56B1F7") +
  theme(legend.title = element_blank(),
        legend.justification=c(1,0), 
        legend.position=c(1,0),
        plot.title = element_text(hjust = 0.5),
        axis.text = element_blank(),
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_blank(), 
        panel.background = element_blank()) +
    coord_fixed(1.3)


# Plot of Male population -------------------------------------------------------------------------------
plotc = 
  ggplot(data = shp_HK.df, aes(x = long, y = lat, group = group), colour = "black", fill = NA) +
  geom_polygon(data = shp_HK.df, aes(fill = PropMale)) + 
  ggtitle("Proportion of males") +
  scale_fill_continuous(high = "#132B43", low = "#56B1F7") +
  theme(legend.title = element_blank(),
        legend.justification=c(1,0), 
        legend.position=c(1,0),
        plot.title = element_text(hjust = 0.5),
        axis.text = element_blank(),
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_blank(), 
        panel.background = element_blank()) +
    coord_fixed(1.3)


# Plot of Female population ------------------------------------------------------------------------------
plotd = 
  ggplot(data = shp_HK.df, aes(x = long, y = lat, group = group), colour = "black", fill = NA) +
  geom_polygon(data = shp_HK.df, aes(fill = PropFemale)) + 
  ggtitle("Proportion of females") +
  scale_fill_continuous(high = "#132B43", low = "#56B1F7") +
  theme(legend.title = element_blank(),
        legend.justification=c(1,0), 
        legend.position=c(1,0),
        plot.title = element_text(hjust = 0.5),
        axis.text = element_blank(),
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_blank(), 
        panel.background = element_blank()) +
    coord_fixed(1.3)


# Plot of Population of 65+ -----------------------------------------------------------------------------
plote = 
  ggplot(data = shp_HK.df, aes(x = long, y = lat, group = group), colour = "black", fill = NA) +
  geom_polygon(data = shp_HK.df, aes(fill = Prop65)) + 
  ggtitle("Proportion of 65 and above") +
  scale_fill_continuous(high = "#132B43", low = "#56B1F7") +
  theme(legend.title = element_blank(),
        legend.justification=c(1,0), 
        legend.position=c(1,0),
        plot.title = element_text(hjust = 0.5),
        axis.text = element_blank(),
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_blank(), 
        panel.background = element_blank()) +
    coord_fixed(1.3)


# Plot of Population of 0-24 ---------------------------------------------------------------------------
plotf =
  ggplot(data = shp_HK.df, aes(x = long, y = lat, group = group), colour = "black", fill = NA) +
  geom_polygon(data = shp_HK.df, aes(fill = Prop0_24)) + 
  ggtitle("Proportion of 15-24 years old") +
  scale_fill_continuous(high = "#132B43", low = "#56B1F7") +
  theme(legend.title = element_blank(),
        legend.justification=c(1,0), 
        legend.position=c(1,0),
        plot.title = element_text(hjust = 0.5),
        axis.text = element_blank(),
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_blank(), 
        panel.background = element_blank()) +
    coord_fixed(1.3)

grid.arrange(plota2, plotb, plotc, plotd, plote, plotf)


plotg =
  ggplot(data = shp_HK.df, aes(x = long, y = lat, group = group), colour = "black", fill = NA) +
  geom_polygon(data = shp_HK.df, aes(fill = Prop0_24)) + 
  ggtitle("Proportion of 0-14 years old") +
  scale_fill_continuous(high = "#132B43", low = "#56B1F7") +
  theme(legend.title = element_blank(),
        legend.justification=c(1,0), 
        legend.position=c(1,0),
        plot.title = element_text(hjust = 0.5),
        axis.text = element_blank(),
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_blank(), 
        panel.background = element_blank())


# Population of 25-64 years old


# Population of 0-14 years old ------------------------------------------------------------------
# plotg =
#   ggplot(data = shp_HK.df, aes(x = long, y = lat, group = group), colour = "black", fill = NA) +
#   geom_polygon(data = shp_HK.df, aes(fill = Prop0_14)) + 
#   ggtitle("Proportion of 0-14 years old") +
#   scale_fill_continuous(high = "#132B43", low = "#56B1F7") +
#   theme(legend.title = element_blank(),
#         legend.justification=c(1,0), 
#         legend.position=c(1,0),
#         plot.title = element_text(hjust = 0.5),
#         axis.text = element_blank(),
#         axis.line = element_blank(),
#         axis.ticks = element_blank(),
#         panel.border = element_blank(),
#         panel.grid = element_blank(),
#         axis.title = element_blank(), 
#         panel.background = element_blank()) +
#     coord_fixed(1.3)


# Plot of Population of 25-64 years old ----------------------------------------------------------------

ploth =
  ggplot(data = shp_HK.df, aes(x = long, y = lat, group = group), colour = "black", fill = NA) +
  geom_polygon(data = shp_HK.df, aes(fill = Prop25_64)) + 
  ggtitle("Proportion of 25-64 years old") +
  scale_fill_continuous(high = "#132B43", low = "#56B1F7") +
  theme(legend.title = element_blank(),
        legend.justification=c(1,0), 
        legend.position=c(1,0),
        plot.title = element_text(hjust = 0.5),
        axis.text = element_blank(),
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_blank(), 
        panel.background = element_blank()) +
    coord_fixed(1.3)


# Plot of Proportion of Post-Sec Educ ------------------------------------------------------------------
ploti =
  ggplot(data = shp_HK.df, aes(x = long, y = lat, group = group), colour = "black", fill = NA) +
  geom_polygon(data = shp_HK.df, aes(fill = PostSec)) + 
  ggtitle("Proportion with Post-Secondary Education") +
  scale_fill_continuous(high = "#132B43", low = "#56B1F7") +
  theme(legend.title = element_blank(),
        legend.justification=c(1,0), 
        legend.position=c(1,0),
        plot.title = element_text(hjust = 0.5),
        axis.text = element_blank(),
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_blank(), 
        panel.background = element_blank()) +
    coord_fixed(1.3)


# Plot of Proportion of secondary education and higher -------------------------------------------------
plotj =
  ggplot(data = shp_HK.df, aes(x = long, y = lat, group = group), colour = "black", fill = NA) +
  geom_polygon(data = shp_HK.df, aes(fill = SecEduc)) + 
  ggtitle("Proportion with Secondary Education and higher") +
  scale_fill_continuous(high = "#132B43", low = "#56B1F7") +
  theme(legend.title = element_blank(),
        legend.justification=c(1,0), 
        legend.position=c(1,0),
        plot.title = element_text(hjust = 0.5),
        axis.text = element_blank(),
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_blank(), 
        panel.background = element_blank()) +
    coord_fixed(1.3)


# Plot of Number of housing units ----------------------------------------------------------------------
plotk =
  ggplot(data = shp_HK.df, aes(x = long, y = lat, group = group), colour = "black", fill = NA) +
  geom_polygon(data = shp_HK.df, aes(fill = Housing)) + 
  ggtitle("Number of Households") +
  scale_fill_continuous(high = "#132B43", low = "#56B1F7") +
  theme(legend.title = element_blank(),
        legend.justification=c(1,0), 
        legend.position=c(1,0),
        plot.title = element_text(hjust = 0.5),
        axis.text = element_blank(),
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_blank(), 
        panel.background = element_blank()) +
    coord_fixed(1.3)


# Plot of Average number of beds per hospital ---------------------------------------------------------
plotl =
  ggplot(data = shp_HK.df, aes(x = long, y = lat, group = group), colour = "black", fill = NA) +
  geom_polygon(data = shp_HK.df, aes(fill = HospBeds)) + 
  ggtitle("Average number of beds per hospital") +
  scale_fill_continuous(high = "#132B43", low = "#56B1F7") +
  theme(legend.title = element_blank(),
        legend.justification=c(1,0), 
        legend.position=c(1,0),
        plot.title = element_text(hjust = 0.5),
        axis.text = element_blank(),
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_blank(), 
        panel.background = element_blank()) +
    coord_fixed(1.3)


# Plot of Income ----------------------------------------------------------------------------------------
plotn =
  ggplot(data = shp_HK.df, aes(x = long, y = lat, group = group), colour = "black", fill = NA) +
  geom_polygon(data = shp_HK.df, aes(fill = Income)) + 
  ggtitle("Monthly Income") +
  scale_fill_continuous(high = "#132B43", low = "#56B1F7") +
  theme(legend.title = element_blank(),
        legend.justification=c(1,0), 
        legend.position=c(1,0),
        plot.title = element_text(hjust = 0.5),
        axis.text = element_blank(),
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_blank(), 
        panel.background = element_blank()) +
    coord_fixed(1.3)



# Plot of Proportion labor ----------------------------------------------------------------------------
plotm =
  ggplot(data = shp_HK.df, aes(x = long, y = lat, group = group), colour = "black", fill = NA) +
  geom_polygon(data = shp_HK.df, aes(fill = PropLabor)) + 
  ggtitle("Proportion of Pop. in Labor Force") +
  scale_fill_continuous(high = "#132B43", low = "#56B1F7") +
  theme(legend.title = element_blank(),
        legend.justification=c(1,0), 
        legend.position=c(1,0),
        plot.title = element_text(hjust = 0.5),
        axis.text = element_blank(),
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_blank(), 
        panel.background = element_blank())


grid.arrange(plotg, ploth, ploti, plotj, plotk, plotl, plotm,plotn,  ncol = 2)


grid.arrange(plotg, ploth, ploti, plotj, plotk, plotl, plotm, plotn,  ncol = 2)

```

## Spatial autocorrelation test

```{r}
############################# Build neighborhood object #############################
coords <- as.matrix(subset(HKcoords, select = c(Long, Lat)))
IDs <- shp_HK$ENAME

# 1) Having contiguous boundary point
HK.nb <- poly2nb(shp_HK, row.names = IDs)
summary(HK.nb)

# 2) Having 3 nearest neighbors
HK.nb3 <- knn2nb(knearneigh(coords, k = 3, longlat = TRUE), row.names = IDs, sym = T)
summary(HK.nb3)

# 3) Having 5 nearest neighbors
HK.nb5 <- knn2nb(knearneigh(coords, k = 5, longlat = TRUE), row.names = IDs, sym = T)

## Plot neighbourhood structure -------------------------------------------------------------------
plot(shp_HK, border="grey", main="Neighbors based on contiguous border", cex.main = 0.5)
plot(HK.nb, coords, add=TRUE)

plot(shp_HK, border="grey", main="K = 3 nearest neighbors")
plot(HK.nb3, coords, add=TRUE)

plot(shp_HK, border="grey", main="K = 5 nearest neighbors")
plot(HK.nb5, coords, add=TRUE)

############################# Convert neighborhood object to weight list #############################
HK.wnb <-  nb2listw(HK.nb, style = "B", zero.policy = T)
HK.wnb3 <- nb2listw(HK.nb3, style = "B")
HK.wnb5 <- nb2listw(HK.nb5, style = "B")

############################# Moran Test for Spatial Autocorrelation #############################

# A) Moran test for SIR
moran.sir1 <- moran.test(data$SIR, HK.wnb, zero.policy = T)
moran.sir2 <- moran.test(data$SIR, HK.wnb3)
moran.sir3 <- moran.test(data$SIR, HK.wnb5)

### Results
moran.sir1
moran.sir2
moran.sir3

# B) Moran test for residuals
poi.fit1 <- glm(Cases ~ Pop_density + offset(log(Expected)), 
                data = data, family = poisson(link="log"))
poi.fit2 <- glm(Cases ~ Prop_female + offset(log(Expected)), 
                data = data, family = poisson(link="log"))
poi.fit3 <- glm(Cases ~ Prop_0.24 + Prop_25.64 + Prop_65 + offset(log(Expected)), 
                data = data, family = poisson(link="log"))
#poi.fit4 <- glm(Cases ~ Pop_density + Prop_female + Prop_0.24 + Prop_25.64 + Prop_65 + offset(log(Expected)), 
#                data = newdata, family = poisson(link="log"))

moran.lm1 <- lm.morantest(poi.fit1, HK.wnb, zero.policy = T)
moran.lm2 <- lm.morantest(poi.fit2, HK.wnb, zero.policy = T)
moran.lm3 <- lm.morantest(poi.fit3, HK.wnb, zero.policy = T)
# moran.lm4 <- lm.morantest(poi.fit4, HK.wnb, zero.policy = T)

### Results
moran.lm1
moran.lm2
moran.lm3
# moran.lm4
```


## Model

Cleaning up data and creating neighborhood structures for nimble

```{r}
# Clean dataset and keep only variables we want to include in nimble regressions ----------------
data.clean <- data %>%
  select(District,
         # Region = Region.x,
         Cases,
         Expected,
         SIR,
         # Deaths,
         # Mean.age = Age,
         # Prop.male = P.male,
         Area_km2,
         Pop_density,
         Prop_labor,
         Prop_female_labor,
         Num_hosp,
         Num_beds,
         Num_household,
         Pct_0.24,
         Prop_25.64,
         Prop_65,
         Prop_female,
         Log_income,
         Log_sec,
         Log_postsec)

# Building vectors that will have neighborhood structure ###########################

# Converting neighborhood objects to matrix ----------------------------------------

# 1) Having contiguous boundary point
HK.nbmat.adj <- nb2mat(HK.nb, style = 'B', zero.policy = TRUE) 

# 2) Having 3 nearest neighbors
HK.nbmat.3 <- nb2mat(HK.nb3, style = 'B', zero.policy = TRUE) 

# 3) Having 5 nearest neighbors
HK.nbmat.5 <- nb2mat(HK.nb5, style = 'B', zero.policy = TRUE) 


# Number of neighbors per district -------------------------------------------------
n <- nrow(data.clean)

# 1) Having contiguous boundary point
num.nb <- c()
for(i in 1:n){
  num.nb[i] <- sum(HK.nbmat.adj[i,])
}
#same outcome, simpler method
#num.nb <- rowSums(HK.nbmat.adj)

# 2) Having 3 nearest neighbors
num.nb.3 <- c()
for(i in 1:n){
  num.nb.3[i] <- sum(HK.nbmat.3[i,])
}
#num.nb.3 <- rowSums(HK.nbmat.3)


# 3) Having 5 nearest neighbors
num.nb.5 <- c()
for(i in 1:n){
  num.nb.5[i] <- sum(HK.nbmat.5[i,])
}
#num.nb.5 <- rowSums(HK.nbmat.5)


# Adjacency vectors -----------------------------------------------------------------

# 1) Having contiguous boundary point
adj <- c()
adj <- which(HK.nbmat.adj[1,] == 1)
for(i in 2:n){
  adj <- c(adj, c(which(HK.nbmat.adj[i,] == 1)))
}

## list of regions with their respective contiguous neighborhoods
#adj <- list()
#for(i in 1:n){
#  adj[[i]] <- c(which(HK.nbmat.adj[i,] == 1))
#}




# 2) Having 3 nearest neighbors 
adj.3 <- list()
for(i in 1:n){
  adj.3[[i]] <- c(which(HK.nbmat.3[i,] == 1))
}
adj.3 <- unlist(adj.3)
# 2) Having 3 nearest neighbors  ------- This function leads to an error in the nimble code
#adj.3 <- c()
#adj.3 <- which(HK.nbmat.adj[1,] == 1)
#for(i in 2:n){
#  adj.3 <- c(adj.3, c(which(HK.nbmat.3[i,] == 1)))
#}


 #3) Having 5 nearest neighbors 
adj.5 <- list()
for(i in 1:n){
  adj.5[[i]] <- c(which(HK.nbmat.5[i,] == 1))
}
adj.5 <- unlist(adj.5)
 #3) Having 5 nearest neighbors ------- This function leads to an error in the nimble code
#adj.5 <- c()
#adj.5 <- which(HK.nbmat.adj[1,] == 1)
#for(i in 2:n){
#  adj.5 <- c(adj.5, c(which(HK.nbmat.5[i,] == 1)))
#}


```

## ICAR
**Nimble: iCAR Usual fixed priors model**

```{r usual code}
###################################
#    Usual fixed priors model     # 
###################################

# Defining the usual fixed priors model ------------------------------------------------------
usual_code <- nimbleCode({ 

  # Defining our priors

  for(j in 1:p){
    beta[j] ~ dnorm(0, sd = 100)  # Betas for the covariates
  }

  sigma2 ~ dinvgamma(1, 0.01)     # Full conditional is good b/c full conditional is IG  --> makes MCMC easier
  
  # Defining transformed parameters
  tau2 <- 1/sigma2
  #nu <- sqrt(nu2)                 # Don't need nu
  s[1:N] ~ dcar_normal(adj[1:L], weights[1:L], num[1:N], tau2, zero_mean = 1) #CAR prior
  # Spatial effects (dcar is long vector, weights, n neighbors, zero mean = 1 constrains sum to 0)

  # Defining likelihood
  for(i in 1:N) { # inprod (beta1X + beta 2X)?
    log(mu[i]) <- log(E[i]) + inprod(X[i, 1:p], beta[1:p]) + s[i]
    y[i] ~ dpois(mu[i]) # we do dpois rmb to define offset inside this or put in log of mean
    # Notes: Don't need to define prior for mu (nu?), the SD is defined only from the mean for Poisson
    # Victoire: mu[i] <- beta0 + inprod(X[i,1:p], beta[1:p]) + s[i]   # We still need to define mu
    # Victoire: y[i] ~ dnorm(mu[i], sd = nu)  # Outcome follows N distribution

  }
})
```

**Neighborhood structure 1: Adjacency-based neighbors**

```{r}
# Neighborhood structure 1: Adjacency matrix (Victoire used 0-1 neighborhood) ###############################

# Defining the data that goes into the model ----------------------------------------------------------------

# (1) Define constants that go into CAR prior into a list
Consts_usual_01 = list(N = nrow(data.clean),                  # Number of areas
                       p = ncol(data.clean[5:18]),            # Number of covariates
                       X = as.matrix(data.clean[, c(5:18)]),  # Matrix of covariates
                       L = length(adj),                       # Edges (length of adj vector)
                       E = data.clean$Expected,
                       adj = adj,                             # Adjacency matrix
                       num = num.nb,                          # Number of neighbors per district
                       weights = rep(1, length(adj)))         # Giving weight of 1 for neighbors

# (2) Define dependent variable (outcome)
outcome <- list(y = data.clean$Cases) # Observed cases

# (3) Define initial values for the MCMC chain
Inits_usual <- list(
                    beta = rep(0, ncol(data.clean[5:18])), 
                    sigma2 = 1, 
                    s = rnorm(num.nb)) # S sampled from N dist (do we sample ours from poisson?)


# Defining model --------------------------------------------------------------------------------------------

# (1) Define the usual fixed prior model for nimble
usual01_model <- nimbleModel(code = usual_code, constants = Consts_usual_01, data = outcome, inits = Inits_usual)

# (2) Define the compiled nimble model
usual01_Cmodel <- compileNimble(usual01_model,
                              showCompilerOutput = TRUE)      

# (3) Configure the MCMC chain
usual01_conf <- configureMCMC(usual01_model, monitors = c('beta', 'sigma2', 's'))

# (4) Do something
usual01_conf$printSamplers()

# (5) Build MCMC object
usual01_MCMC <- buildMCMC(usual01_conf, enableWAIC = T) 

# (6) Compile model with MCMC object
usual01_CMCMC <- compileNimble(usual01_MCMC, project = usual01_Cmodel)  

# (7) Run the model
usual01_runMCMC <- runMCMC(usual01_CMCMC, nburnin = 10000, niter = 200000, nchains = 2, thin = 25, WAIC = T)

# (8) Check convergence
usual01_samples = rbind(usual01_runMCMC$samples[[1]], usual01_runMCMC$samples[[2]])



# Plot the MCMC chains----------

# Betas (Covariates) - log scale
par(mfrow=c(4,4), mar=c(2,4.5,2.1,1)+0.1)
plot(main = paste(names(data.clean[5])),  usual01_samples[,"beta[1]"] , type = "l") # Why are all beta's = 1
plot(main = paste(names(data.clean[6])),  usual01_samples[,"beta[2]"] , type = "l")
plot(main = paste(names(data.clean[7])),  usual01_samples[,"beta[3]"] , type = "l")
plot(main = paste(names(data.clean[8])),  usual01_samples[,"beta[4]"] , type = "l")
plot(main = paste(names(data.clean[9])),  usual01_samples[,"beta[5]"] , type = "l")
plot(main = paste(names(data.clean[10])), usual01_samples[,"beta[6]"] , type = "l")
plot(main = paste(names(data.clean[11])), usual01_samples[,"beta[7]"] , type = "l")
plot(main = paste(names(data.clean[12])), usual01_samples[,"beta[8]"] , type = "l")
plot(main = paste(names(data.clean[13])), usual01_samples[,"beta[9]"] , type = "l")
plot(main = paste(names(data.clean[14])),usual01_samples[,"beta[10]"] , type = "l")
plot(main = paste(names(data.clean[15])),usual01_samples[,"beta[11]"] , type = "l")
plot(main = paste(names(data.clean[16])),usual01_samples[,"beta[12]"] , type = "l")
plot(main = paste(names(data.clean[17])),usual01_samples[,"beta[13]"] , type = "l")
plot(main = paste(names(data.clean[18])),usual01_samples[,"beta[14]"] , type = "l")

#sigma squared
par(mfrow=c(1,1), mar=c(2,4.5,2.1,1)+0.1)
plot(main ="Sigma Squared", usual01_samples[,"sigma2"], type = "l")


# Spatial effects for each region  
par(mfrow=c(4,5), mar=c(2,3,2.1,1)+0.1)
plot(main = paste(data.clean$District[1]), usual01_samples[,"s[1]"]  , type = "l") 
plot(main = paste(data.clean$District[2]), usual01_samples[,"s[2]"]  , type = "l")
plot(main = paste(data.clean$District[3]), usual01_samples[,"s[3]"]  , type = "l")
plot(main = paste(data.clean$District[4]), usual01_samples[,"s[4]"]  , type = "l")
plot(main = paste(data.clean$District[5]), usual01_samples[,"s[5]"]  , type = "l")
plot(main = paste(data.clean$District[6]), usual01_samples[,"s[6]"]  , type = "l")
plot(main = paste(data.clean$District[7]), usual01_samples[,"s[7]"]  , type = "l")
plot(main = paste(data.clean$District[8]), usual01_samples[,"s[8]"]  , type = "l")
plot(main = paste(data.clean$District[9]), usual01_samples[,"s[9]"]  , type = "l")
plot(main = paste(data.clean$District[10]), usual01_samples[,"s[10]"], type = "l")
plot(main = paste(data.clean$District[11]), usual01_samples[,"s[11]"], type = "l")
plot(main = paste(data.clean$District[12]), usual01_samples[,"s[12]"], type = "l")
plot(main = paste(data.clean$District[13]), usual01_samples[,"s[13]"], type = "l")
plot(main = paste(data.clean$District[14]), usual01_samples[,"s[14]"], type = "l")
plot(main = paste(data.clean$District[15]), usual01_samples[,"s[15]"], type = "l")
plot(main = paste(data.clean$District[16]), usual01_samples[,"s[16]"], type = "l")
plot(main = paste(data.clean$District[17]), usual01_samples[,"s[17]"], type = "l")
plot(main = paste(data.clean$District[18]), usual01_samples[,"s[18]"], type = "l")



# Plot the density curves for posterior -------------
# Betas (Covariates) - log scale
par(mfrow=c(4,4), mar=c(2,4.5,2.1,1)+0.1)
plot(main = paste(names(data.clean[5])),density(usual01_samples[,"beta[1]"])) 
plot(main = paste(names(data.clean[6])),density(usual01_samples[,"beta[2]"]))
plot(main = paste(names(data.clean[7])),density(usual01_samples[,"beta[3]"]))
plot(main = paste(names(data.clean[8])),density(usual01_samples[,"beta[4]"]))
plot(main = paste(names(data.clean[9])),density(usual01_samples[,"beta[5]"]))
plot(main = paste(names(data.clean[10])),density(usual01_samples[,"beta[6]"]))
plot(main = paste(names(data.clean[11])),density(usual01_samples[,"beta[7]"]))
plot(main = paste(names(data.clean[12])),density(usual01_samples[,"beta[8]"]))
plot(main = paste(names(data.clean[13])),density(usual01_samples[,"beta[9]"]))
plot(main = paste(names(data.clean[14])),density(usual01_samples[,"beta[10]"]))
plot(main = paste(names(data.clean[15])),density(usual01_samples[,"beta[11]"]))
plot(main = paste(names(data.clean[16])),density(usual01_samples[,"beta[12]"]))
plot(main = paste(names(data.clean[17])),density(usual01_samples[,"beta[13]"]))
plot(main = paste(names(data.clean[18])),density(usual01_samples[,"beta[14]"]))

#sigma squared
par(mfrow=c(1,1), mar=c(2,4.5,2.1,1)+0.1)
plot(main ="Sigma Squared", density(usual01_samples[,"sigma2"]))

#Spatial effects for each region 
par(mfrow=c(4,5), mar=c(2,3,2.1,1)+0.1)
plot(main = paste(data.clean$District[1]), density(usual01_samples[,"s[1]"])) 
plot(main = paste(data.clean$District[2]), density(usual01_samples[,"s[2]"]))
plot(main = paste(data.clean$District[3]), density(usual01_samples[,"s[3]"]))
plot(main = paste(data.clean$District[4]), density(usual01_samples[,"s[4]"]))
plot(main = paste(data.clean$District[5]), density(usual01_samples[,"s[5]"]))
plot(main = paste(data.clean$District[6]), density(usual01_samples[,"s[6]"]))
plot(main = paste(data.clean$District[7]), density(usual01_samples[,"s[7]"]))
plot(main = paste(data.clean$District[8]), density(usual01_samples[,"s[8]"]))
plot(main = paste(data.clean$District[9]), density(usual01_samples[,"s[9]"]))
plot(main = paste(data.clean$District[10]), density(usual01_samples[,"s[10]"]))
plot(main = paste(data.clean$District[11]), density(usual01_samples[,"s[11]"]))
plot(main = paste(data.clean$District[12]), density(usual01_samples[,"s[12]"]))
plot(main = paste(data.clean$District[13]), density(usual01_samples[,"s[13]"]))
plot(main = paste(data.clean$District[14]), density(usual01_samples[,"s[14]"]))
plot(main = paste(data.clean$District[15]), density(usual01_samples[,"s[15]"]))
plot(main = paste(data.clean$District[16]), density(usual01_samples[,"s[16]"]))
plot(main = paste(data.clean$District[17]), density(usual01_samples[,"s[17]"]))
plot(main = paste(data.clean$District[18]), density(usual01_samples[,"s[18]"]))






# (9) WAIC ---------
usual01_runMCMC$WAIC



# Posterior summaries--------

################### Beta = Covariate estimates?


#Calculating the Beta means
means_betas_usual_01 <- apply(usual01_samples[,1:14],2, mean)

#Calculating the Beta 95% CrI 
CrI_betas_usual_01 <- t(apply(usual01_samples[ ,1:14],2, function(x) quantile(x, probs=c(0.015,0.975))))

#Combining the means and CIs into a dataframe
mean_CrI_betas_usual_01 <- t(matrix(c(means_betas_usual_01, CrI_betas_usual_01), ncol=14, byrow=T)) %>% as.data.frame()

#Renaming the columns
colnames(mean_CrI_betas_usual_01) <- c("Mean", "95% CrI LL", "95% CrI UL")

# Converting means and CrIs from log to regular scale
exp(mean_CrI_betas_usual_01)


################### S : estimates? per region

#Calculating the S means
means_s_usual_01 <- apply(usual01_samples[ ,15:(ncol(usual01_samples)-1)],2, mean)

#Calculating the Beta 95% CrI 
CrI_s_usual_01 <- t(apply(usual01_samples[ ,15:(ncol(usual01_samples)-1)],2, function(x) quantile(x, probs=c(0.015,0.975))))

#Combining the means and CIs into a dataframe
mean_CrI_s_usual_01 <- cbind(means_s_usual_01, CrI_s_usual_01) %>% as.data.frame()

#Renaming the columns
colnames(mean_CrI_s_usual_01) <- c("Mean", "95% CrI LL", "95% CrI UL")

# Converting means and CrIs from log to regular scale
exp(mean_CrI_s_usual_01)

```

**Neighborhood structure 2: Distance-based neighbors (k = 3)**
```{r}
# Neighborhood structure 1: Adjacency matrix (Victoire used 0-1 neighborhood) ###############################

# Defining the data that goes into the model ----------------------------------------------------------------

# (1) Define constants that go into CAR prior into a list
Consts_usual_02 = list(N = nrow(data.clean),                  # Number of areas
                       p = ncol(data.clean[5:18]),            # Number of covariates
                       X = as.matrix(data.clean[, c(5:18)]),  # Matrix of covariates
                       L = length(adj.3),                       # Edges (length of adj vector)
                       E = data.clean$Expected,
                       adj = adj.3,                             # Adjacency matrix
                       num = num.nb.3,                          # Number of neighbors per district
                       weights = rep(1, length(adj.3)))         # Giving weight of 1 for neighbors

# (2) Define dependent variable (outcome)
outcome <- list(y = data.clean$Cases) # Observed cases

# (3) Define initial values for the MCMC chain
Inits_usual_02 <- list(
                    beta = rep(0, ncol(data.clean[5:18])), 
                    sigma2 = 1, 
                    s = rnorm(num.nb.3)) # S sampled from N dist (do we sample ours from poisson?)


# Defining model --------------------------------------------------------------------------------------------

# (1) Define the usual fixed prior model for nimble
usual02_model <- nimbleModel(code = usual_code, constants = Consts_usual_02, data = outcome, inits = Inits_usual_02)

# (2) Define the compiled nimble model
usual02_Cmodel <- compileNimble(usual02_model,
                              showCompilerOutput = TRUE)      

# (3) Configure the MCMC chain
usual02_conf <- configureMCMC(usual02_model, monitors = c('beta', 'sigma2', 's'))

# (4) Do something
usual02_conf$printSamplers()

# (5) Build MCMC object
usual02_MCMC <- buildMCMC(usual02_conf, enableWAIC = T) 

# (6) Compile model with MCMC object
usual02_CMCMC <- compileNimble(usual02_MCMC, project = usual02_Cmodel)  

# (7) Run the model
usual02_runMCMC <- runMCMC(usual02_CMCMC, nburnin = 10000, niter = 200000, nchains = 2, thin = 25, WAIC = T)

# (8) Check convergence
usual02_samples = rbind(usual02_runMCMC$samples[[1]], usual02_runMCMC$samples[[2]])



# Plot the MCMC chains----------
plot(main = paste(names(data.clean[5])), usual02_samples[, "beta[1]"], type = "l")

# Betas (Covariates) - log scale
par(mfrow=c(4,4), mar=c(2,4.5,2.1,1)+0.1)
plot(main = paste(names(data.clean[5])),  usual02_samples[,"beta[1]"] , type = "l") # Why are all beta's = 1
plot(main = paste(names(data.clean[6])),  usual02_samples[,"beta[2]"] , type = "l")
plot(main = paste(names(data.clean[7])),  usual02_samples[,"beta[3]"] , type = "l")
plot(main = paste(names(data.clean[8])),  usual02_samples[,"beta[4]"] , type = "l")
plot(main = paste(names(data.clean[9])),  usual02_samples[,"beta[5]"] , type = "l")
plot(main = paste(names(data.clean[10])), usual02_samples[,"beta[6]"] , type = "l")
plot(main = paste(names(data.clean[11])), usual02_samples[,"beta[7]"] , type = "l")
plot(main = paste(names(data.clean[12])), usual02_samples[,"beta[8]"] , type = "l")
plot(main = paste(names(data.clean[13])), usual02_samples[,"beta[9]"] , type = "l")
plot(main = paste(names(data.clean[14])),usual02_samples[,"beta[10]"] , type = "l")
plot(main = paste(names(data.clean[15])),usual02_samples[,"beta[11]"] , type = "l")
plot(main = paste(names(data.clean[16])),usual02_samples[,"beta[12]"] , type = "l")
plot(main = paste(names(data.clean[17])),usual02_samples[,"beta[13]"] , type = "l")
plot(main = paste(names(data.clean[18])),usual02_samples[,"beta[14]"] , type = "l")

#sigma squared
par(mfrow=c(1,1), mar=c(2,4.5,2.1,1)+0.1)
plot(main ="Sigma Squared", usual02_samples[,"sigma2"], type = "l")


# Spatial effects for each region  
par(mfrow=c(4,5), mar=c(2,3,2.1,1)+0.1)
plot(main = paste(data.clean$District[1]), usual02_samples[,"s[1]"]  , type = "l") 
plot(main = paste(data.clean$District[2]), usual02_samples[,"s[2]"]  , type = "l")
plot(main = paste(data.clean$District[3]), usual02_samples[,"s[3]"]  , type = "l")
plot(main = paste(data.clean$District[4]), usual02_samples[,"s[4]"]  , type = "l")
plot(main = paste(data.clean$District[5]), usual02_samples[,"s[5]"]  , type = "l")
plot(main = paste(data.clean$District[6]), usual02_samples[,"s[6]"]  , type = "l")
plot(main = paste(data.clean$District[7]), usual02_samples[,"s[7]"]  , type = "l")
plot(main = paste(data.clean$District[8]), usual02_samples[,"s[8]"]  , type = "l")
plot(main = paste(data.clean$District[9]), usual02_samples[,"s[9]"]  , type = "l")
plot(main = paste(data.clean$District[10]), usual02_samples[,"s[10]"], type = "l")
plot(main = paste(data.clean$District[11]), usual02_samples[,"s[11]"], type = "l")
plot(main = paste(data.clean$District[12]), usual02_samples[,"s[12]"], type = "l")
plot(main = paste(data.clean$District[13]), usual02_samples[,"s[13]"], type = "l")
plot(main = paste(data.clean$District[14]), usual02_samples[,"s[14]"], type = "l")
plot(main = paste(data.clean$District[15]), usual02_samples[,"s[15]"], type = "l")
plot(main = paste(data.clean$District[16]), usual02_samples[,"s[16]"], type = "l")
plot(main = paste(data.clean$District[17]), usual02_samples[,"s[17]"], type = "l")
plot(main = paste(data.clean$District[18]), usual02_samples[,"s[18]"], type = "l")



# Plot the density curves for posterior -------------
# Betas (Covariates) - log scale
par(mfrow=c(4,4), mar=c(2,4.5,2.1,1)+0.1)
plot(main = paste(names(data.clean[5])),density(usual02_samples[,"beta[1]"])) 
plot(main = paste(names(data.clean[6])),density(usual02_samples[,"beta[2]"]))
plot(main = paste(names(data.clean[7])),density(usual02_samples[,"beta[3]"]))
plot(main = paste(names(data.clean[8])),density(usual02_samples[,"beta[4]"]))
plot(main = paste(names(data.clean[9])),density(usual02_samples[,"beta[5]"]))
plot(main = paste(names(data.clean[10])),density(usual02_samples[,"beta[6]"]))
plot(main = paste(names(data.clean[11])),density(usual02_samples[,"beta[7]"]))
plot(main = paste(names(data.clean[12])),density(usual02_samples[,"beta[8]"]))
plot(main = paste(names(data.clean[13])),density(usual02_samples[,"beta[9]"]))
plot(main = paste(names(data.clean[14])),density(usual02_samples[,"beta[10]"]))
plot(main = paste(names(data.clean[15])),density(usual02_samples[,"beta[11]"]))
plot(main = paste(names(data.clean[16])),density(usual02_samples[,"beta[12]"]))
plot(main = paste(names(data.clean[17])),density(usual02_samples[,"beta[13]"]))
plot(main = paste(names(data.clean[18])),density(usual02_samples[,"beta[14]"]))

#sigma squared
par(mfrow=c(1,1), mar=c(2,4.5,2.1,1)+0.1)
plot(main ="Sigma Squared", density(usual02_samples[,"sigma2"]))

#Spatial effects for each region 
par(mfrow=c(4,5), mar=c(2,3,2.1,1)+0.1)
plot(main = paste(data.clean$District[1]), density(usual02_samples[,"s[1]"])) 
plot(main = paste(data.clean$District[2]), density(usual02_samples[,"s[2]"]))
plot(main = paste(data.clean$District[3]), density(usual02_samples[,"s[3]"]))
plot(main = paste(data.clean$District[4]), density(usual02_samples[,"s[4]"]))
plot(main = paste(data.clean$District[5]), density(usual02_samples[,"s[5]"]))
plot(main = paste(data.clean$District[6]), density(usual02_samples[,"s[6]"]))
plot(main = paste(data.clean$District[7]), density(usual02_samples[,"s[7]"]))
plot(main = paste(data.clean$District[8]), density(usual02_samples[,"s[8]"]))
plot(main = paste(data.clean$District[9]), density(usual02_samples[,"s[9]"]))
plot(main = paste(data.clean$District[10]), density(usual02_samples[,"s[10]"]))
plot(main = paste(data.clean$District[11]), density(usual02_samples[,"s[11]"]))
plot(main = paste(data.clean$District[12]), density(usual02_samples[,"s[12]"]))
plot(main = paste(data.clean$District[13]), density(usual02_samples[,"s[13]"]))
plot(main = paste(data.clean$District[14]), density(usual02_samples[,"s[14]"]))
plot(main = paste(data.clean$District[15]), density(usual02_samples[,"s[15]"]))
plot(main = paste(data.clean$District[16]), density(usual02_samples[,"s[16]"]))
plot(main = paste(data.clean$District[17]), density(usual02_samples[,"s[17]"]))
plot(main = paste(data.clean$District[18]), density(usual02_samples[,"s[18]"]))






# (9) WAIC ---------
usual02_runMCMC$WAIC



# Posterior summaries--------

################### Betas : Covariate estimates

#Calculating the Beta means
means_betas_usual_02=apply(usual02_samples[,1:14],2, mean)

#Calculating the Beta 95% CrI 
CrI_betas_usual_02=t(apply(usual02_samples[ ,1:14],2, function(x) quantile(x, probs=c(0.025,0.975))))

#Combining the means and CIs into a dataframe
mean_CrI_betas_usual_02 <- t(matrix(c(means_betas_usual_02, CI_betas_usual_02), ncol=14, byrow=T)) %>% as.data.frame()

#Renaming the columns
colnames(mean_CrI_betas_usual_02) <- c("Mean", "95% CrI LL", "95% CrI UL")

# Converting means and CrIs from log to regular scale
exp(mean_CrI_betas_usual_02)

################### S : estimates? per region

#Calculating the S means
means_s_usual_02 <- apply(usual02_samples[ ,15:(ncol(usual02_samples)-1)],2, mean)

#Calculating the Beta 95% CrI 
CrI_s_usual_02 <- t(apply(usual02_samples[ ,15:(ncol(usual02_samples)-1)],2, function(x) quantile(x, probs=c(0.025,0.975))))

#Combining the means and CIs into a dataframe
mean_CrI_s_usual_02 <- cbind(means_s_usual_02, CrI_s_usual_02) %>% as.data.frame()

#Renaming the columns
colnames(mean_CrI_s_usual_02) <- c("Mean", "95% CrI LL", "95% CrI UL")

# Converting means and CrIs from log to regular scale
exp(mean_CrI_s_usual_02)
```
**Neighborhood structure 3: Distance-based neighbors (k = 5)**

```{r}
# Neighborhood structure 1: Adjacency matrix (Victoire used 0-1 neighborhood) ###############################

# Defining the data that goes into the model ----------------------------------------------------------------

# (1) Define constants that go into CAR prior into a list
Consts_usual_03 = list(N = nrow(data.clean),                  # Number of areas
                       p = ncol(data.clean[5:18]),            # Number of covariates
                       X = as.matrix(data.clean[, c(5:18)]),  # Matrix of covariates
                       L = length(adj.5),                       # Edges (length of adj vector)
                       E = data.clean$Expected,
                       adj = adj.5,                             # Adjacency matrix
                       num = num.nb.5,                          # Number of neighbors per district
                       weights = rep(1, length(adj.5)))         # Giving weight of 1 for neighbors

# (2) Define dependent variable (outcome)
outcome <- list(y = data.clean$Cases) # Observed cases

# (3) Define initial values for the MCMC chain
Inits_usual_03 <- list(
                    beta = rep(0, ncol(data.clean[5:18])), 
                    sigma2 = 1, 
                    s = rnorm(num.nb.5)) # S sampled from N dist (do we sample ours from poisson?)


# Defining model --------------------------------------------------------------------------------------------

# (1) Define the usual fixed prior model for nimble
usual03_model <- nimbleModel(code = usual_code, constants = Consts_usual_03, data = outcome, inits = Inits_usual_03)

# (2) Define the compiled nimble model
usual03_Cmodel <- compileNimble(usual03_model,
                              showCompilerOutput = TRUE)      

# (3) Configure the MCMC chain
usual03_conf <- configureMCMC(usual03_model, monitors = c('beta', 'sigma2', 's'))

# (4) Do something
usual03_conf$printSamplers()

# (5) Build MCMC object
usual03_MCMC <- buildMCMC(usual03_conf, enableWAIC = T) 

# (6) Compile model with MCMC object
usual03_CMCMC <- compileNimble(usual03_MCMC, project = usual03_Cmodel)  

# (7) Run the model
usual03_runMCMC <- runMCMC(usual03_CMCMC, nburnin = 50000, niter = 200000, nchains = 2, thin = 5, WAIC = T)

# (8) Check convergence
usual03_samples = rbind(usual03_runMCMC$samples[[1]], usual03_runMCMC$samples[[2]])


# Plot the MCMC chains----------

# Betas (Covariates) - log scale
par(mfrow=c(4,4), mar=c(2,4.5,2.1,1)+0.1)
plot(main = paste(names(data.clean[5])),  usual03_samples[,"beta[1]"] , type = "l") # Why are all beta's = 1
plot(main = paste(names(data.clean[6])),  usual03_samples[,"beta[2]"] , type = "l")
plot(main = paste(names(data.clean[7])),  usual03_samples[,"beta[3]"] , type = "l")
plot(main = paste(names(data.clean[8])),  usual03_samples[,"beta[4]"] , type = "l")
plot(main = paste(names(data.clean[9])),  usual03_samples[,"beta[5]"] , type = "l")
plot(main = paste(names(data.clean[10])), usual03_samples[,"beta[6]"] , type = "l")
plot(main = paste(names(data.clean[11])), usual03_samples[,"beta[7]"] , type = "l")
plot(main = paste(names(data.clean[12])), usual03_samples[,"beta[8]"] , type = "l")
plot(main = paste(names(data.clean[13])), usual03_samples[,"beta[9]"] , type = "l")
plot(main = paste(names(data.clean[14])),usual03_samples[,"beta[10]"] , type = "l")
plot(main = paste(names(data.clean[15])),usual03_samples[,"beta[11]"] , type = "l")
plot(main = paste(names(data.clean[16])),usual03_samples[,"beta[12]"] , type = "l")
plot(main = paste(names(data.clean[17])),usual03_samples[,"beta[13]"] , type = "l")
plot(main = paste(names(data.clean[18])),usual03_samples[,"beta[14]"] , type = "l")

#sigma squared
par(mfrow=c(1,1), mar=c(2,4.5,2.1,1)+0.1)
plot(main ="Sigma Squared", usual03_samples[,"sigma2"], type = "l")


# Spatial effects for each region  
par(mfrow=c(4,5), mar=c(2,3,2.1,1)+0.1)
plot(main = paste(data.clean$District[1]), usual03_samples[,"s[1]"]  , type = "l") 
plot(main = paste(data.clean$District[2]), usual03_samples[,"s[2]"]  , type = "l")
plot(main = paste(data.clean$District[3]), usual03_samples[,"s[3]"]  , type = "l")
plot(main = paste(data.clean$District[4]), usual03_samples[,"s[4]"]  , type = "l")
plot(main = paste(data.clean$District[5]), usual03_samples[,"s[5]"]  , type = "l")
plot(main = paste(data.clean$District[6]), usual03_samples[,"s[6]"]  , type = "l")
plot(main = paste(data.clean$District[7]), usual03_samples[,"s[7]"]  , type = "l")
plot(main = paste(data.clean$District[8]), usual03_samples[,"s[8]"]  , type = "l")
plot(main = paste(data.clean$District[9]), usual03_samples[,"s[9]"]  , type = "l")
plot(main = paste(data.clean$District[10]), usual03_samples[,"s[10]"], type = "l")
plot(main = paste(data.clean$District[11]), usual03_samples[,"s[11]"], type = "l")
plot(main = paste(data.clean$District[12]), usual03_samples[,"s[12]"], type = "l")
plot(main = paste(data.clean$District[13]), usual03_samples[,"s[13]"], type = "l")
plot(main = paste(data.clean$District[14]), usual03_samples[,"s[14]"], type = "l")
plot(main = paste(data.clean$District[15]), usual03_samples[,"s[15]"], type = "l")
plot(main = paste(data.clean$District[16]), usual03_samples[,"s[16]"], type = "l")
plot(main = paste(data.clean$District[17]), usual03_samples[,"s[17]"], type = "l")
plot(main = paste(data.clean$District[18]), usual03_samples[,"s[18]"], type = "l")



# Plot the density curves for posterior -------------
# Betas (Covariates) - log scale
par(mfrow=c(4,4), mar=c(2,4.5,2.1,1)+0.1)
plot(main = paste(names(data.clean[5])),density(usual03_samples[,"beta[1]"])) 
plot(main = paste(names(data.clean[6])),density(usual03_samples[,"beta[2]"]))
plot(main = paste(names(data.clean[7])),density(usual03_samples[,"beta[3]"]))
plot(main = paste(names(data.clean[8])),density(usual03_samples[,"beta[4]"]))
plot(main = paste(names(data.clean[9])),density(usual03_samples[,"beta[5]"]))
plot(main = paste(names(data.clean[10])),density(usual03_samples[,"beta[6]"]))
plot(main = paste(names(data.clean[11])),density(usual03_samples[,"beta[7]"]))
plot(main = paste(names(data.clean[12])),density(usual03_samples[,"beta[8]"]))
plot(main = paste(names(data.clean[13])),density(usual03_samples[,"beta[9]"]))
plot(main = paste(names(data.clean[14])),density(usual03_samples[,"beta[10]"]))
plot(main = paste(names(data.clean[15])),density(usual03_samples[,"beta[11]"]))
plot(main = paste(names(data.clean[16])),density(usual03_samples[,"beta[12]"]))
plot(main = paste(names(data.clean[17])),density(usual03_samples[,"beta[13]"]))
plot(main = paste(names(data.clean[18])),density(usual03_samples[,"beta[14]"]))

#sigma squared
par(mfrow=c(1,1), mar=c(2,4.5,2.1,1)+0.1)
plot(main ="Sigma Squared", density(usual03_samples[,"sigma2"]))

#Spatial effects for each region 
par(mfrow=c(4,5), mar=c(2,3,2.1,1)+0.1)
plot(main = paste(data.clean$District[1]), density(usual03_samples[,"s[1]"])) 
plot(main = paste(data.clean$District[2]), density(usual03_samples[,"s[2]"]))
plot(main = paste(data.clean$District[3]), density(usual03_samples[,"s[3]"]))
plot(main = paste(data.clean$District[4]), density(usual03_samples[,"s[4]"]))
plot(main = paste(data.clean$District[5]), density(usual03_samples[,"s[5]"]))
plot(main = paste(data.clean$District[6]), density(usual03_samples[,"s[6]"]))
plot(main = paste(data.clean$District[7]), density(usual03_samples[,"s[7]"]))
plot(main = paste(data.clean$District[8]), density(usual03_samples[,"s[8]"]))
plot(main = paste(data.clean$District[9]), density(usual03_samples[,"s[9]"]))
plot(main = paste(data.clean$District[10]), density(usual03_samples[,"s[10]"]))
plot(main = paste(data.clean$District[11]), density(usual03_samples[,"s[11]"]))
plot(main = paste(data.clean$District[12]), density(usual03_samples[,"s[12]"]))
plot(main = paste(data.clean$District[13]), density(usual03_samples[,"s[13]"]))
plot(main = paste(data.clean$District[14]), density(usual03_samples[,"s[14]"]))
plot(main = paste(data.clean$District[15]), density(usual03_samples[,"s[15]"]))
plot(main = paste(data.clean$District[16]), density(usual03_samples[,"s[16]"]))
plot(main = paste(data.clean$District[17]), density(usual03_samples[,"s[17]"]))
plot(main = paste(data.clean$District[18]), density(usual03_samples[,"s[18]"]))






# (9) WAIC ---------
usual03_runMCMC$WAIC



# Posterior summaries--------

################### Betas - covariate estimates

#Calculating the Beta means
means_betas_usual_03=apply(usual03_samples[,1:14],2, mean)

#Calculating the Beta 95% CrI 
CrI_betas_usual_03=t(apply(usual03_samples[ ,1:14],2, function(x) quantile(x, probs=c(0.035,0.975))))

#Combining the means and CIs into a dataframe
mean_CrI_betas_usual_03 <- t(matrix(c(means_betas_usual_03, CrI_betas_usual_03), ncol=14, byrow=T)) %>% as.data.frame()

#Renaming the columns
colnames(mean_CrI_betas_usual_03) <- c("Mean", "95% CrI LL", "95% CrI UL")

# Converting means and CrIs from log to regular scale
exp(mean_CrI_betas_usual_03)

################### S : estimates? per region

#Calculating the S means
means_s_usual_03 <- apply(usual03_samples[ ,15:(ncol(usual03_samples)-1)],2, mean)

#Calculating the Beta 95% CrI 
CrI_s_usual_03 <- t(apply(usual03_samples[ ,15:(ncol(usual03_samples)-1)],2, function(x) quantile(x, probs=c(0.035,0.975))))

#Combining the means and CIs into a dataframe
mean_CrI_s_usual_03 <- cbind(means_s_usual_03, CrI_s_usual_03) %>% as.data.frame()

#Renaming the columns
colnames(mean_CrI_s_usual_03) <- c("Mean", "95% CrI LL", "95% CrI UL")

# Converting means and CrIs from log to regular scale
exp(mean_CrI_s_usual_03)


```


## BYM CAR
**Nimble: BYMCAR Usual fixed priors model**

```{r usual code}
###################################
#    Usual fixed priors model     # 
###################################

# Defining the usual fixed priors model ------------------------------------------------------
usual_code_bym <- nimbleCode({ 

  # Defining our priors

#    for(i in 1:N){
#log(mu[i])<-beta0+ v[i] + b[i]
#lambda[i]<-mu[i]*E[i]
#y[i]~dpois(lambda[i])
#v[i]~dnorm(0,tauv)
#}
#for(k in 1:L){weights[k]<-1}
#b[1:N]~dcar_normal(adj[1:L], weights[1:L], num[1:N], tauB,zero_mean=1)
#
#beta0~dnorm(0,tau0)
#tauv~dgamma(2,0.5)
#tau0~dgamma(2,0.5)
#tauB~dgamma(2,0.5) 
    
  for(j in 1:p){
    beta[j] ~ dnorm(0, sd = 100)  # Betas for the covariates
  }

  sigma2 ~ dinvgamma(1, 0.01)     # Full conditional is good b/c full conditional is IG  --> makes MCMC easier
  
  v[i]~dnorm(0,tauv) 
  h  ~ dinvgamma(1, 0.01) 
  tauv <- 1/h
    #dgamma(2,0.5)
  
  
  # Defining transformed parameters
  tau2 <- 1/sigma2
  #nu <- sqrt(nu2)                 # Don't need nu
  s[1:N] ~ dcar_normal(adj[1:L], weights[1:L], num[1:N], tau2, zero_mean = 1) #CAR prior
  # Spatial effects (dcar is long vector, weights, n neighbors, zero mean = 1 constrains sum to 0)

  # Defining likelihood
  for(i in 1:N) { # inprod (beta1X + beta 2X)?
    log(mu[i]) <- log(E[i]) + inprod(X[i, 1:p], beta[1:p]) + s[i] + v[i] 
    y[i] ~ dpois(mu[i]) # we do dpois rmb to define offset inside this or put in log of mean
    # Notes: Don't need to define prior for mu (nu?), the SD is defined only from the mean for Poisson
    # Victoire: mu[i] <- beta0 + inprod(X[i,1:p], beta[1:p]) + s[i]   # We still need to define mu
    # Victoire: y[i] ~ dnorm(mu[i], sd = nu)  # Outcome follows N distribution

  }
  
})
```

```{r}
# Neighborhood structure 1: Adjacency matrix (Victoire used 0-1 neighborhood) ###############################

# Defining the data that goes into the model ----------------------------------------------------------------

# (1) Define constants that go into CAR prior into a list
Consts_usual_bym_01 = list(N = nrow(data.clean),                  # Number of areas
                       p = ncol(data.clean[5:18]),            # Number of covariates
                       X = as.matrix(data.clean[, c(5:18)]),  # Matrix of covariates
                       L = length(adj),                       # Edges (length of adj vector)
                       E = data.clean$Expected,
                       adj = adj,                             # Adjacency matrix
                       num = num.nb,                          # Number of neighbors per district
                       weights = rep(1, length(adj)))         # Giving weight of 1 for neighbors

# (2) Define dependent variable (outcome)
outcome <- list(y = data.clean$Cases) # Observed cases

# (3) Define initial values for the MCMC chain
Inits_usual_bym_01 <- list(
                    beta = rep(0, ncol(data.clean[5:18])), 
                    sigma2 = 1, 
                    s = rnorm(num.nb), # S sampled from N dist (do we sample ours from poisson?)
                    v = rnorm(num.nb),
                    h = 1)


# Defining model --------------------------------------------------------------------------------------------

# (1) Define the usual fixed prior model for nimble
bym_usual01_model <- nimbleModel(code = usual_code_bym, constants = Consts_usual_bym_01, 
                             data = outcome, inits = Inits_usual_bym_01)

# (2) Define the compiled nimble model
usual01_Cmodel <- compileNimble(usual01_model,
                              showCompilerOutput = TRUE)      

# (3) Configure the MCMC chain
usual01_conf <- configureMCMC(usual01_model, monitors = c('beta', 'sigma2', 's', 'v', 'h'))

# (4) Do something
usual01_conf$printSamplers()

# (5) Build MCMC object
usual01_MCMC <- buildMCMC(usual01_conf, enableWAIC = T) 

# (6) Compile model with MCMC object
usual01_CMCMC <- compileNimble(usual01_MCMC, project = usual01_Cmodel)  

# (7) Run the model
usual01_runMCMC <- runMCMC(usual01_CMCMC, nburnin = 10000, niter = 200000, nchains = 2, thin = 25, WAIC = T)

# (8) Check convergence
usual01_samples = rbind(usual01_runMCMC$samples[[1]], usual01_runMCMC$samples[[2]])



# Plot the MCMC chains----------

# Betas (Covariates) - log scale
par(mfrow=c(4,4), mar=c(2,4.5,2.1,1)+0.1)
plot(main = paste(names(data.clean[5])),  usual01_samples[,"beta[1]"] , type = "l") # Why are all beta's = 1
plot(main = paste(names(data.clean[6])),  usual01_samples[,"beta[2]"] , type = "l")
plot(main = paste(names(data.clean[7])),  usual01_samples[,"beta[3]"] , type = "l")
plot(main = paste(names(data.clean[8])),  usual01_samples[,"beta[4]"] , type = "l")
plot(main = paste(names(data.clean[9])),  usual01_samples[,"beta[5]"] , type = "l")
plot(main = paste(names(data.clean[10])), usual01_samples[,"beta[6]"] , type = "l")
plot(main = paste(names(data.clean[11])), usual01_samples[,"beta[7]"] , type = "l")
plot(main = paste(names(data.clean[12])), usual01_samples[,"beta[8]"] , type = "l")
plot(main = paste(names(data.clean[13])), usual01_samples[,"beta[9]"] , type = "l")
plot(main = paste(names(data.clean[14])),usual01_samples[,"beta[10]"] , type = "l")
plot(main = paste(names(data.clean[15])),usual01_samples[,"beta[11]"] , type = "l")
plot(main = paste(names(data.clean[16])),usual01_samples[,"beta[12]"] , type = "l")
plot(main = paste(names(data.clean[17])),usual01_samples[,"beta[13]"] , type = "l")
plot(main = paste(names(data.clean[18])),usual01_samples[,"beta[14]"] , type = "l")

#sigma squared
par(mfrow=c(1,1), mar=c(2,4.5,2.1,1)+0.1)
plot(main ="Sigma Squared", usual01_samples[,"sigma2"], type = "l")


# Spatial effects for each region  
par(mfrow=c(4,5), mar=c(2,3,2.1,1)+0.1)
plot(main = paste(data.clean$District[1]), usual01_samples[,"s[1]"]  , type = "l") 
plot(main = paste(data.clean$District[2]), usual01_samples[,"s[2]"]  , type = "l")
plot(main = paste(data.clean$District[3]), usual01_samples[,"s[3]"]  , type = "l")
plot(main = paste(data.clean$District[4]), usual01_samples[,"s[4]"]  , type = "l")
plot(main = paste(data.clean$District[5]), usual01_samples[,"s[5]"]  , type = "l")
plot(main = paste(data.clean$District[6]), usual01_samples[,"s[6]"]  , type = "l")
plot(main = paste(data.clean$District[7]), usual01_samples[,"s[7]"]  , type = "l")
plot(main = paste(data.clean$District[8]), usual01_samples[,"s[8]"]  , type = "l")
plot(main = paste(data.clean$District[9]), usual01_samples[,"s[9]"]  , type = "l")
plot(main = paste(data.clean$District[10]), usual01_samples[,"s[10]"], type = "l")
plot(main = paste(data.clean$District[11]), usual01_samples[,"s[11]"], type = "l")
plot(main = paste(data.clean$District[12]), usual01_samples[,"s[12]"], type = "l")
plot(main = paste(data.clean$District[13]), usual01_samples[,"s[13]"], type = "l")
plot(main = paste(data.clean$District[14]), usual01_samples[,"s[14]"], type = "l")
plot(main = paste(data.clean$District[15]), usual01_samples[,"s[15]"], type = "l")
plot(main = paste(data.clean$District[16]), usual01_samples[,"s[16]"], type = "l")
plot(main = paste(data.clean$District[17]), usual01_samples[,"s[17]"], type = "l")
plot(main = paste(data.clean$District[18]), usual01_samples[,"s[18]"], type = "l")



# Plot the density curves for posterior -------------
# Betas (Covariates) - log scale
par(mfrow=c(4,4), mar=c(2,4.5,2.1,1)+0.1)
plot(main = paste(names(data.clean[5])),density(usual01_samples[,"beta[1]"])) 
plot(main = paste(names(data.clean[6])),density(usual01_samples[,"beta[2]"]))
plot(main = paste(names(data.clean[7])),density(usual01_samples[,"beta[3]"]))
plot(main = paste(names(data.clean[8])),density(usual01_samples[,"beta[4]"]))
plot(main = paste(names(data.clean[9])),density(usual01_samples[,"beta[5]"]))
plot(main = paste(names(data.clean[10])),density(usual01_samples[,"beta[6]"]))
plot(main = paste(names(data.clean[11])),density(usual01_samples[,"beta[7]"]))
plot(main = paste(names(data.clean[12])),density(usual01_samples[,"beta[8]"]))
plot(main = paste(names(data.clean[13])),density(usual01_samples[,"beta[9]"]))
plot(main = paste(names(data.clean[14])),density(usual01_samples[,"beta[10]"]))
plot(main = paste(names(data.clean[15])),density(usual01_samples[,"beta[11]"]))
plot(main = paste(names(data.clean[16])),density(usual01_samples[,"beta[12]"]))
plot(main = paste(names(data.clean[17])),density(usual01_samples[,"beta[13]"]))
plot(main = paste(names(data.clean[18])),density(usual01_samples[,"beta[14]"]))

#sigma squared
par(mfrow=c(1,1), mar=c(2,4.5,2.1,1)+0.1)
plot(main ="Sigma Squared", density(usual01_samples[,"sigma2"]))

#Spatial effects for each region 
par(mfrow=c(4,5), mar=c(2,3,2.1,1)+0.1)
plot(main = paste(data.clean$District[1]), density(usual01_samples[,"s[1]"])) 
plot(main = paste(data.clean$District[2]), density(usual01_samples[,"s[2]"]))
plot(main = paste(data.clean$District[3]), density(usual01_samples[,"s[3]"]))
plot(main = paste(data.clean$District[4]), density(usual01_samples[,"s[4]"]))
plot(main = paste(data.clean$District[5]), density(usual01_samples[,"s[5]"]))
plot(main = paste(data.clean$District[6]), density(usual01_samples[,"s[6]"]))
plot(main = paste(data.clean$District[7]), density(usual01_samples[,"s[7]"]))
plot(main = paste(data.clean$District[8]), density(usual01_samples[,"s[8]"]))
plot(main = paste(data.clean$District[9]), density(usual01_samples[,"s[9]"]))
plot(main = paste(data.clean$District[10]), density(usual01_samples[,"s[10]"]))
plot(main = paste(data.clean$District[11]), density(usual01_samples[,"s[11]"]))
plot(main = paste(data.clean$District[12]), density(usual01_samples[,"s[12]"]))
plot(main = paste(data.clean$District[13]), density(usual01_samples[,"s[13]"]))
plot(main = paste(data.clean$District[14]), density(usual01_samples[,"s[14]"]))
plot(main = paste(data.clean$District[15]), density(usual01_samples[,"s[15]"]))
plot(main = paste(data.clean$District[16]), density(usual01_samples[,"s[16]"]))
plot(main = paste(data.clean$District[17]), density(usual01_samples[,"s[17]"]))
plot(main = paste(data.clean$District[18]), density(usual01_samples[,"s[18]"]))






# (9) WAIC ---------
usual01_runMCMC$WAIC



# Posterior summaries--------

#Betas
#Calculating the Beta means
means_betas_usual_01 <- apply(usual01_samples[,1:14],2, mean)

#Calculating the Beta 95% CrI 
CrI_betas_usual_01 <- t(apply(usual01_samples[ ,1:14],2, function(x) quantile(x, probs=c(0.015,0.975))))

#Combining the means and CIs into a dataframe
mean_CrI_betas_usual_01 <- t(matrix(c(means_betas_usual_01, CrI_betas_usual_01), ncol=14, byrow=T)) %>% as.data.frame()

#Renaming the columns
colnames(mean_CrI_betas_usual_01) <- c("Mean", "95% CrI LL", "95% CrI UL")

# Converting means and CrIs from log to regular scale
exp(mean_CrI_betas_usual_01)

################### S : estimates? per region

#Calculating the S means
means_s_usual_01 <- apply(usual01_samples[ ,15:(ncol(usual01_samples)-1)],2, mean)

#Calculating the Beta 95% CrI 
CrI_s_usual_01 <- t(apply(usual01_samples[ ,15:(ncol(usual01_samples)-1)],2, function(x) quantile(x, probs=c(0.015,0.975))))

#Combining the means and CIs into a dataframe
mean_CrI_s_usual_01 <- cbind(means_s_usual_01, CrI_s_usual_01) %>% as.data.frame()

#Renaming the columns
colnames(mean_CrI_s_usual_01) <- c("Mean", "95% CrI LL", "95% CrI UL")

# Converting means and CrIs from log to regular scale
exp(mean_CrI_s_usual_01)

```


# Summary of Inferential Results (3 pages)

```{r}
#WAIC by model
WAICs <- cbind(Adjescent= usual01_runMCMC$WAIC, K3= usual02_runMCMC$WAIC,K5= usual03_runMCMC$WAIC)
WAICs



```


# Conclusion (1 page)

# Appendix
