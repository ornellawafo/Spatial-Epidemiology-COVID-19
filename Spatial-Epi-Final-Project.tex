\PassOptionsToPackage{unicode=true}{hyperref} % options for packages loaded elsewhere
\PassOptionsToPackage{hyphens}{url}
%
\documentclass[]{article}
\usepackage{lmodern}
\usepackage{amssymb,amsmath}
\usepackage{ifxetex,ifluatex}
\usepackage{fixltx2e} % provides \textsubscript
\ifnum 0\ifxetex 1\fi\ifluatex 1\fi=0 % if pdftex
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
  \usepackage{textcomp} % provides euro and other symbols
\else % if luatex or xelatex
  \usepackage{unicode-math}
  \defaultfontfeatures{Ligatures=TeX,Scale=MatchLowercase}
\fi
% use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
% use microtype if available
\IfFileExists{microtype.sty}{%
\usepackage[]{microtype}
\UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\IfFileExists{parskip.sty}{%
\usepackage{parskip}
}{% else
\setlength{\parindent}{0pt}
\setlength{\parskip}{6pt plus 2pt minus 1pt}
}
\usepackage{hyperref}
\hypersetup{
            pdftitle={Final Project},
            pdfauthor={Zharmaine Ante, Demy Dam, Ornella Wafo Noubissie},
            pdfborder={0 0 0},
            breaklinks=true}
\urlstyle{same}  % don't use monospace font for urls
\usepackage[margin=1in]{geometry}
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.77,0.63,0.00}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\usepackage{graphicx,grffile}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
\setlength{\emergencystretch}{3em}  % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{0}
% Redefines (sub)paragraphs to behave more like sections
\ifx\paragraph\undefined\else
\let\oldparagraph\paragraph
\renewcommand{\paragraph}[1]{\oldparagraph{#1}\mbox{}}
\fi
\ifx\subparagraph\undefined\else
\let\oldsubparagraph\subparagraph
\renewcommand{\subparagraph}[1]{\oldsubparagraph{#1}\mbox{}}
\fi

% set default figure placement to htbp
\makeatletter
\def\fps@figure{htbp}
\makeatother

\usepackage{etoolbox}
\makeatletter
\providecommand{\subtitle}[1]{% add subtitle to \maketitle
  \apptocmd{\@title}{\par {\large #1 \par}}{}{}
}
\makeatother

\title{Final Project}
\providecommand{\subtitle}[1]{}
\subtitle{EPIB 677, Winter 2020, McGill University}
\author{Zharmaine Ante, Demy Dam, Ornella Wafo Noubissie}
\date{2020-04-24}

\begin{document}
\maketitle

\hypertarget{abstract-1-page}{%
\section{Abstract (1 page)}\label{abstract-1-page}}

\hypertarget{introduction-1-page}{%
\section{Introduction (1 page)}\label{introduction-1-page}}

\hypertarget{analysis-plan-2-pages}{%
\section{Analysis Plan (2 pages)}\label{analysis-plan-2-pages}}

\hypertarget{descriptive-and-univariate-analyses-3-pages}{%
\section{Descriptive and Univariate Analyses (3
pages)}\label{descriptive-and-univariate-analyses-3-pages}}

\hypertarget{data-cleaning}{%
\subsection{Data Cleaning}\label{data-cleaning}}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Data manipulation-1} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Data manipulation-2} \end{center}

\hypertarget{exploratory-analysis}{%
\subsection{Exploratory analysis}\label{exploratory-analysis}}

\begin{verbatim}
##                 District      Cases          Expected           SIR        
##  Central and Western: 1   Min.   : 4.00   Min.   : 9.017   Min.   :0.1138  
##  Eastern            : 1   1st Qu.:10.00   1st Qu.:17.206   1st Qu.:0.4740  
##  Islands            : 1   Median :15.00   Median :22.851   Median :0.5907  
##  Kowloon City       : 1   Mean   :22.83   Mean   :22.833   Mean   :1.2906  
##  Kwai Tsing         : 1   3rd Qu.:37.00   3rd Qu.:28.171   3rd Qu.:1.2989  
##  Kwun Tong          : 1   Max.   :62.00   Max.   :38.114   Max.   :4.9549  
##  (Other)            :12                                                    
##  st_pop_density      Prop_labor      Prop_female       Prop_0.24     
##  Min.   :-1.0172   Min.   :0.5067   Min.   :0.5304   Min.   :0.1830  
##  1st Qu.:-0.8211   1st Qu.:0.5304   1st Qu.:0.5352   1st Qu.:0.2132  
##  Median :-0.3283   Median :0.5418   Median :0.5399   Median :0.2160  
##  Mean   : 0.0000   Mean   :0.5444   Mean   :0.5426   Mean   :0.2147  
##  3rd Qu.: 0.9369   3rd Qu.:0.5596   3rd Qu.:0.5503   3rd Qu.:0.2190  
##  Max.   : 2.0239   Max.   :0.5869   Max.   :0.5635   Max.   :0.2320  
##                                                                      
##    Prop_25.64        Prop_65       household_poverty_rate beds_per_hosp   
##  Min.   :0.6070   Min.   :0.1500   Min.   :14.10          Min.   : 123.5  
##  1st Qu.:0.6172   1st Qu.:0.1552   1st Qu.:16.82          1st Qu.: 469.1  
##  Median :0.6225   Median :0.1605   Median :19.50          Median : 712.4  
##  Mean   :0.6225   Mean   :0.1628   Mean   :19.67          Mean   : 804.7  
##  3rd Qu.:0.6278   3rd Qu.:0.1688   3rd Qu.:22.73          3rd Qu.:1194.2  
##  Max.   :0.6430   Max.   :0.1830   Max.   :27.00          Max.   :1739.0  
## 
\end{verbatim}

\begin{verbatim}
##                             Cases   Expected         SIR st_pop_density
## Cases                   1.0000000 -0.2780718  0.88582475     0.18432752
## Expected               -0.2780718  1.0000000 -0.57105199     0.26829047
## SIR                     0.8858247 -0.5710520  1.00000000     0.02568876
## st_pop_density          0.1843275  0.2682905  0.02568876     1.00000000
## Prop_labor              0.6374807 -0.5558044  0.76107861    -0.12475472
## Prop_female             0.5580035 -0.4972269  0.70639755    -0.11826925
## Prop_0.24              -0.5243506  0.2172643 -0.63862505    -0.13996145
## Prop_25.64              0.4655186 -0.5453285  0.63039183    -0.40303334
## Prop_65                 0.1510775  0.2846935  0.12790618     0.55143411
## household_poverty_rate -0.5096711  0.4832576 -0.60000133     0.44133387
## beds_per_hosp           0.1260122  0.5326878 -0.21246134     0.48418949
##                         Prop_labor Prop_female   Prop_0.24 Prop_25.64
## Cases                   0.63748067  0.55800346 -0.52435059  0.4655186
## Expected               -0.55580444 -0.49722694  0.21726431 -0.5453285
## SIR                     0.76107861  0.70639755 -0.63862505  0.6303918
## st_pop_density         -0.12475472 -0.11826925 -0.13996145 -0.4030333
## Prop_labor              1.00000000  0.76017026 -0.57655308  0.7534181
## Prop_female             0.76017026  1.00000000 -0.57750729  0.5947391
## Prop_0.24              -0.57655308 -0.57750729  1.00000000 -0.5716045
## Prop_25.64              0.75341814  0.59473906 -0.57160445  1.0000000
## Prop_65                -0.05839632  0.09480558 -0.61539349 -0.2942884
## household_poverty_rate -0.81811107 -0.79919177  0.51112003 -0.8030298
## beds_per_hosp          -0.28923471 -0.34589096  0.03389521 -0.2110798
##                            Prop_65 household_poverty_rate beds_per_hosp
## Cases                   0.15107752             -0.5096711    0.12601225
## Expected                0.28469346              0.4832576    0.53268779
## SIR                     0.12790618             -0.6000013   -0.21246134
## st_pop_density          0.55143411              0.4413339    0.48418949
## Prop_labor             -0.05839632             -0.8181111   -0.28923471
## Prop_female             0.09480558             -0.7991918   -0.34589096
## Prop_0.24              -0.61539349              0.5111200    0.03389521
## Prop_25.64             -0.29428837             -0.8030298   -0.21107983
## Prop_65                 1.00000000              0.1816165    0.16506311
## household_poverty_rate  0.18161649              1.0000000    0.36967130
## beds_per_hosp           0.16506311              0.3696713    1.00000000
\end{verbatim}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Histograms of selected variables-1} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Histograms of selected variables-2} \end{center}

\hypertarget{maps-of-the-outcome-and-covariates}{%
\subsection{Maps of the outcome and
covariates}\label{maps-of-the-outcome-and-covariates}}

\begin{verbatim}
## OGR data source with driver: ESRI Shapefile 
## Source: "/Users/demydam/Documents/MScPH/EPIB 677/Spatial-Epidemiology-COVID-19/shp_HK/Hong_Kong_18_Districts.shp", layer: "Hong_Kong_18_Districts"
## with 18 features
## It has 5 fields
## Integer64 fields read as strings:  OBJECTID
\end{verbatim}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Mapping outcome by district-1} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Mapping outcome by district-2} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Mapping covariates by district-1} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Mapping covariates by district-2} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Mapping covariates by district-3} \end{center}

\hypertarget{morans-i-statistic-spatial-autocorrelation-test}{%
\subsection{Moran's I statistic spatial autocorrelation
test}\label{morans-i-statistic-spatial-autocorrelation-test}}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Building neighborhood structure-1} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Building neighborhood structure-2} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Building neighborhood structure-3} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{poi.fit1 <-}\StringTok{ }\KeywordTok{glm}\NormalTok{(Cases }\OperatorTok{~}\StringTok{ }\NormalTok{st_pop_density }\OperatorTok{+}\StringTok{ }\KeywordTok{offset}\NormalTok{(}\KeywordTok{log}\NormalTok{(Expected)), }
                \DataTypeTok{data =}\NormalTok{ data.clean, }\DataTypeTok{family =} \KeywordTok{poisson}\NormalTok{(}\DataTypeTok{link =} \StringTok{"log"}\NormalTok{))}

\NormalTok{poi.fit2 <-}\StringTok{ }\KeywordTok{glm}\NormalTok{(Cases }\OperatorTok{~}\StringTok{ }\NormalTok{Prop_female }\OperatorTok{+}\StringTok{ }\KeywordTok{offset}\NormalTok{(}\KeywordTok{log}\NormalTok{(Expected)), }
                \DataTypeTok{data =}\NormalTok{ data.clean, }\DataTypeTok{family =} \KeywordTok{poisson}\NormalTok{(}\DataTypeTok{link =} \StringTok{"log"}\NormalTok{))}

\NormalTok{poi.fit3 <-}\StringTok{ }\KeywordTok{glm}\NormalTok{(Cases }\OperatorTok{~}\StringTok{ }\NormalTok{Prop_}\FloatTok{0.24} \OperatorTok{+}\StringTok{ }\NormalTok{Prop_}\FloatTok{25.64} \OperatorTok{+}\StringTok{ }\NormalTok{Prop_}\DecValTok{65} \OperatorTok{+}\StringTok{ }\KeywordTok{offset}\NormalTok{(}\KeywordTok{log}\NormalTok{(Expected)), }
                \DataTypeTok{data =}\NormalTok{ data.clean, }\DataTypeTok{family =} \KeywordTok{poisson}\NormalTok{(}\DataTypeTok{link =} \StringTok{"log"}\NormalTok{))}

\NormalTok{poi.fit4 <-}\StringTok{ }\KeywordTok{glm}\NormalTok{(Cases }\OperatorTok{~}\StringTok{ }\NormalTok{Prop_labor }\OperatorTok{+}\StringTok{ }\KeywordTok{offset}\NormalTok{(}\KeywordTok{log}\NormalTok{(Expected)), }
                \DataTypeTok{data =}\NormalTok{ data.clean, }\DataTypeTok{family =} \KeywordTok{poisson}\NormalTok{(}\DataTypeTok{link =} \StringTok{"log"}\NormalTok{))}

\NormalTok{poi.fit5 <-}\StringTok{ }\KeywordTok{glm}\NormalTok{(Cases }\OperatorTok{~}\StringTok{ }\NormalTok{beds_per_hosp }\OperatorTok{+}\StringTok{ }\KeywordTok{offset}\NormalTok{(}\KeywordTok{log}\NormalTok{(Expected)), }
                \DataTypeTok{data =}\NormalTok{ data.clean, }\DataTypeTok{family =} \KeywordTok{poisson}\NormalTok{(}\DataTypeTok{link =} \StringTok{"log"}\NormalTok{))}

\NormalTok{poi.fit6 <-}\StringTok{ }\KeywordTok{glm}\NormalTok{(Cases }\OperatorTok{~}\StringTok{ }\NormalTok{household_poverty_rate }\OperatorTok{+}\StringTok{ }\KeywordTok{offset}\NormalTok{(}\KeywordTok{log}\NormalTok{(Expected)), }
                \DataTypeTok{data =}\NormalTok{ data.clean, }\DataTypeTok{family =} \KeywordTok{poisson}\NormalTok{(}\DataTypeTok{link =} \StringTok{"log"}\NormalTok{))}

\NormalTok{poi.fit7 <-}\StringTok{ }\KeywordTok{glm}\NormalTok{(Cases }\OperatorTok{~}\StringTok{ }\NormalTok{st_pop_density }\OperatorTok{+}\StringTok{ }\NormalTok{Prop_female }\OperatorTok{+}\StringTok{ }\NormalTok{Prop_}\FloatTok{0.24} \OperatorTok{+}\StringTok{ }\NormalTok{Prop_}\FloatTok{25.64} \OperatorTok{+}\StringTok{ }\NormalTok{Prop_}\DecValTok{65} \OperatorTok{+}\StringTok{ }
\StringTok{                }\NormalTok{Prop_labor }\OperatorTok{+}\StringTok{ }\NormalTok{beds_per_hosp }\OperatorTok{+}\StringTok{ }\NormalTok{household_poverty_rate }\OperatorTok{+}\StringTok{ }\KeywordTok{offset}\NormalTok{(}\KeywordTok{log}\NormalTok{(Expected)), }
                \DataTypeTok{data =}\NormalTok{ data.clean, }\DataTypeTok{family =} \KeywordTok{poisson}\NormalTok{(}\DataTypeTok{link=}\StringTok{"log"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Moran I test under randomisation
## 
## data:  data$SIR  
## weights: HK.wnb  n reduced by no-neighbour observations
##   
## 
## Moran I statistic standard deviate = 3.8157, p-value = 6.791e-05
## alternative hypothesis: greater
## sample estimates:
## Moran I statistic       Expectation          Variance 
##        0.50217454       -0.06250000        0.02190065
\end{verbatim}

\begin{verbatim}
## 
##  Moran I test under randomisation
## 
## data:  data$SIR  
## weights: HK.wnb3    
## 
## Moran I statistic standard deviate = 4.455, p-value = 4.195e-06
## alternative hypothesis: greater
## sample estimates:
## Moran I statistic       Expectation          Variance 
##        0.53628274       -0.05882353        0.01784408
\end{verbatim}

\begin{verbatim}
## 
##  Moran I test under randomisation
## 
## data:  data$SIR  
## weights: HK.wnb5    
## 
## Moran I statistic standard deviate = 4.2869, p-value = 9.058e-06
## alternative hypothesis: greater
## sample estimates:
## Moran I statistic       Expectation          Variance 
##        0.31576032       -0.05882353        0.00763491
\end{verbatim}

\begin{verbatim}
## 
##  Global Moran I for regression residuals
## 
## data:  
## model: glm(formula = Cases ~ st_pop_density + offset(log(Expected)),
## family = poisson(link = "log"), data = data.clean)
## weights: HK.wnb
## 
## Moran I statistic standard deviate = 2.7266, p-value = 0.003199
## alternative hypothesis: greater
## sample estimates:
## Observed Moran I      Expectation         Variance 
##      0.518891429     -0.003940129      0.036768220
\end{verbatim}

\begin{verbatim}
## 
##  Global Moran I for regression residuals
## 
## data:  
## model: glm(formula = Cases ~ Prop_female + offset(log(Expected)),
## family = poisson(link = "log"), data = data.clean)
## weights: HK.wnb
## 
## Moran I statistic standard deviate = -0.10148, p-value = 0.5404
## alternative hypothesis: greater
## sample estimates:
## Observed Moran I      Expectation         Variance 
##     -0.023939545     -0.004548851      0.036508756
\end{verbatim}

\begin{verbatim}
## 
##  Global Moran I for regression residuals
## 
## data:  
## model: glm(formula = Cases ~ Prop_0.24 + Prop_25.64 + Prop_65 +
## offset(log(Expected)), family = poisson(link = "log"), data =
## data.clean)
## weights: HK.wnb
## 
## Moran I statistic standard deviate = 0.57751, p-value = 0.2818
## alternative hypothesis: greater
## sample estimates:
## Observed Moran I      Expectation         Variance 
##      0.120422322     -0.005291509      0.047385219
\end{verbatim}

\begin{verbatim}
## 
##  Global Moran I for regression residuals
## 
## data:  
## model: glm(formula = Cases ~ Prop_labor + offset(log(Expected)), family
## = poisson(link = "log"), data = data.clean)
## weights: HK.wnb
## 
## Moran I statistic standard deviate = 0.18743, p-value = 0.4257
## alternative hypothesis: greater
## sample estimates:
## Observed Moran I      Expectation         Variance 
##      0.031469964     -0.004362123      0.036547441
\end{verbatim}

\begin{verbatim}
## 
##  Global Moran I for regression residuals
## 
## data:  
## model: glm(formula = Cases ~ beds_per_hosp + offset(log(Expected)),
## family = poisson(link = "log"), data = data.clean)
## weights: HK.wnb
## 
## Moran I statistic standard deviate = 2.7285, p-value = 0.003181
## alternative hypothesis: greater
## sample estimates:
## Observed Moran I      Expectation         Variance 
##      0.521910834     -0.002718476      0.036969471
\end{verbatim}

\begin{verbatim}
## 
##  Global Moran I for regression residuals
## 
## data:  
## model: glm(formula = Cases ~ household_poverty_rate +
## offset(log(Expected)), family = poisson(link = "log"), data =
## data.clean)
## weights: HK.wnb
## 
## Moran I statistic standard deviate = 1.1147, p-value = 0.1325
## alternative hypothesis: greater
## sample estimates:
## Observed Moran I      Expectation         Variance 
##      0.209445394     -0.003835327      0.036610821
\end{verbatim}

\begin{verbatim}
## 
##  Global Moran I for regression residuals
## 
## data:  
## model: glm(formula = Cases ~ st_pop_density + Prop_female + Prop_0.24 +
## Prop_25.64 + Prop_65 + Prop_labor + beds_per_hosp +
## household_poverty_rate + offset(log(Expected)), family = poisson(link =
## "log"), data = data.clean)
## weights: HK.wnb
## 
## Moran I statistic standard deviate = -0.69019, p-value = 0.755
## alternative hypothesis: greater
## sample estimates:
## Observed Moran I      Expectation         Variance 
##      -0.24488982      -0.01547283       0.11048655
\end{verbatim}

\hypertarget{poisson-model}{%
\subsection{Poisson Model}\label{poisson-model}}

\begin{verbatim}
## 
## Call:
## glm(formula = Cases ~ . - District - SIR - Expected + offset(log(Expected)), 
##     family = poisson(link = "log"), data = data.clean)
## 
## Deviance Residuals: 
##     Min       1Q   Median       3Q      Max  
## -3.4603  -0.8858   0.1139   0.7045   3.4131  
## 
## Coefficients:
##                          Estimate Std. Error z value Pr(>|z|)    
## (Intercept)             1.085e+03  1.717e+02   6.321 2.61e-10 ***
## st_pop_density          2.452e-01  9.583e-02   2.559   0.0105 *  
## Prop_labor              2.792e+01  6.470e+00   4.316 1.59e-05 ***
## Prop_female             3.027e+01  1.434e+01   2.110   0.0348 *  
## Prop_0.24              -1.135e+03  1.720e+02  -6.596 4.22e-11 ***
## Prop_25.64             -1.105e+03  1.670e+02  -6.615 3.72e-11 ***
## Prop_65                -1.147e+03  1.704e+02  -6.731 1.68e-11 ***
## household_poverty_rate  4.499e-02  4.028e-02   1.117   0.2640    
## beds_per_hosp           3.625e-04  1.645e-04   2.203   0.0276 *  
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## (Dispersion parameter for poisson family taken to be 1)
## 
##     Null deviance: 366.341  on 17  degrees of freedom
## Residual deviance:  58.217  on  9  degrees of freedom
## AIC: 160.32
## 
## Number of Fisher Scoring iterations: 5
\end{verbatim}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Poisson Model-1} \end{center}

\begin{verbatim}
## 
##  Overdispersion test
## 
## data:  poi.fit
## z = 2.0743, p-value = 0.01903
## alternative hypothesis: true dispersion is greater than 1
## sample estimates:
## dispersion 
##   3.318046
\end{verbatim}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Poisson Model-2} \end{center}

\hypertarget{building-neighbors-and-adjacency-list}{%
\subsection{Building neighbors and adjacency
list}\label{building-neighbors-and-adjacency-list}}

\textbf{Nimble: iCAR Usual fixed priors model}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{set.seed}\NormalTok{(}\DecValTok{1234}\NormalTok{)}

\CommentTok{# Defining the usual fixed priors model ------------------------------------------------------}
\NormalTok{usual_code <-}\StringTok{ }\KeywordTok{nimbleCode}\NormalTok{(\{}
  
  \CommentTok{# Defining our priors}
\NormalTok{  beta0 }\OperatorTok{~}\StringTok{ }\KeywordTok{dnorm}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DataTypeTok{sd =} \DecValTok{100}\NormalTok{)}
  \ControlFlowTok{for}\NormalTok{(j }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\NormalTok{p)\{}
\NormalTok{    beta[j] }\OperatorTok{~}\StringTok{ }\KeywordTok{dnorm}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DataTypeTok{sd =} \DecValTok{100}\NormalTok{)  }\CommentTok{#Betas for the covariates}
\NormalTok{  \}}
\NormalTok{  sigma2 }\OperatorTok{~}\StringTok{ }\KeywordTok{dinvgamma}\NormalTok{(}\DecValTok{1}\NormalTok{, }\FloatTok{0.01}\NormalTok{)}

  \CommentTok{#sigma2 ~ dinvgamma(1, 10) }
  \CommentTok{# tau2 ~ dinvgamma(2, 0.10) }
  \CommentTok{#here i set up a prior for tau directly, it makes the MCMC converge better}
  
  \CommentTok{# Defining transformed parameters}
\NormalTok{  tau2 <-}\StringTok{ }\DecValTok{1}\OperatorTok{/}\NormalTok{sigma2}
\NormalTok{  s[}\DecValTok{1}\OperatorTok{:}\NormalTok{N] }\OperatorTok{~}\StringTok{ }\KeywordTok{dcar_normal}\NormalTok{(adj[}\DecValTok{1}\OperatorTok{:}\NormalTok{L], weights[}\DecValTok{1}\OperatorTok{:}\NormalTok{L], num[}\DecValTok{1}\OperatorTok{:}\NormalTok{N], tau2, }\DataTypeTok{zero_mean =} \DecValTok{1}\NormalTok{) }\CommentTok{#CAR prior}
  \CommentTok{# Spatial effects (dcar is long vector, weights, n neighbors, zero mean = 1 constrains sum to 0)}

  \CommentTok{# Defining likelihood }
  \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\NormalTok{N) \{ }
    \KeywordTok{log}\NormalTok{(r[i]) <-}\StringTok{ }\NormalTok{beta0 }\OperatorTok{+}\StringTok{ }\KeywordTok{inprod}\NormalTok{(X[i, }\DecValTok{1}\OperatorTok{:}\NormalTok{p], beta[}\DecValTok{1}\OperatorTok{:}\NormalTok{p]) }\OperatorTok{+}\StringTok{ }\NormalTok{s[i]}
\NormalTok{    mu[i] <-}\StringTok{ }\NormalTok{E[i]}\OperatorTok{*}\NormalTok{r[i] }
\NormalTok{    y[i] }\OperatorTok{~}\StringTok{ }\KeywordTok{dpois}\NormalTok{(mu[i]) }
\NormalTok{  \} }
\NormalTok{\})}
\end{Highlighting}
\end{Shaded}

\textbf{Neighborhood structure 1: Adjacency-based neighbors}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Defining the data that goes into the model -----------------------------------------------------}

\CommentTok{# (1) Define constants that go into CAR prior into a list}
\NormalTok{Consts_usual_}\DecValTok{01}\NormalTok{ =}\StringTok{ }\KeywordTok{list}\NormalTok{(}\DataTypeTok{N =} \KeywordTok{nrow}\NormalTok{(data.clean),                  }\CommentTok{# Number of areas}
                       \DataTypeTok{p =} \KeywordTok{ncol}\NormalTok{(data.clean[}\DecValTok{5}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(data.clean)]),            }\CommentTok{# Number of covariates}
                       \DataTypeTok{X =} \KeywordTok{as.matrix}\NormalTok{(data.clean[, }\KeywordTok{c}\NormalTok{(}\DecValTok{5}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(data.clean))]),  }\CommentTok{# Matrix of covariates}
                       \DataTypeTok{L =} \KeywordTok{length}\NormalTok{(adj),                       }\CommentTok{# Edges (length of adj vector)}
                       \DataTypeTok{E =}\NormalTok{ data.clean}\OperatorTok{$}\NormalTok{Expected,               }\CommentTok{# Expected cases}
                       \DataTypeTok{adj =}\NormalTok{ adj,                             }\CommentTok{# Adjacency matrix}
                       \DataTypeTok{num =}\NormalTok{ num.nb,                          }\CommentTok{# Number of neighbors per district}
                       \DataTypeTok{weights =} \KeywordTok{rep}\NormalTok{(}\DecValTok{1}\NormalTok{, }\KeywordTok{length}\NormalTok{(adj)))         }\CommentTok{# Giving weight of 1 for neighbors}

\CommentTok{# (2) Define dependent variable (outcome)}
\NormalTok{outcome <-}\StringTok{ }\KeywordTok{list}\NormalTok{(}\DataTypeTok{y =}\NormalTok{ data.clean}\OperatorTok{$}\NormalTok{Cases) }\CommentTok{# Observed cases}

\CommentTok{# (3) Define initial values for the MCMC chain}
\NormalTok{Inits_usual <-}\StringTok{ }\KeywordTok{list}\NormalTok{(}\DataTypeTok{beta0 =} \DecValTok{-21}\NormalTok{,}
                    \DataTypeTok{beta =} \KeywordTok{rep}\NormalTok{(}\DecValTok{0}\NormalTok{, }\KeywordTok{ncol}\NormalTok{(data.clean[, }\DecValTok{5}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(data.clean)])), }
                    \DataTypeTok{sigma2 =} \DecValTok{1}\NormalTok{, }
                    \CommentTok{#tau2 = 0.1,}
                    \DataTypeTok{s =} \KeywordTok{rnorm}\NormalTok{(}\KeywordTok{length}\NormalTok{(num.nb)))}

\CommentTok{# Defining model -------------------------------------------------------------------------------}

\CommentTok{# (1) Define the usual fixed prior model for nimble}
\NormalTok{usual01_model <-}\StringTok{ }\KeywordTok{nimbleModel}\NormalTok{(}\DataTypeTok{code =}\NormalTok{ usual_code, }\DataTypeTok{constants =}\NormalTok{ Consts_usual_}\DecValTok{01}\NormalTok{, }\DataTypeTok{data =}\NormalTok{ outcome, }\DataTypeTok{inits =}\NormalTok{ Inits_usual)}

\CommentTok{# (2) Define the compiled nimble model}
\NormalTok{usual01_Cmodel <-}\StringTok{ }\KeywordTok{compileNimble}\NormalTok{(usual01_model, }\DataTypeTok{showCompilerOutput =} \OtherTok{TRUE}\NormalTok{)      }
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## clang++ -std=gnu++11 -I"/Library/Frameworks/R.framework/Resources/include" -DNDEBUG -DR_NO_REMAP   -DEIGEN_MPL2_ONLY=1 -I"/Library/Frameworks/R.framework/Versions/3.6/Resources/library/nimble/include" -Wno-misleading-indentation -Wno-ignored-attributes -Wno-deprecated-declarations  -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk -I/usr/local/include  -fPIC  -Wall -g -O2  -c P_1_usual_code_MID_1.cpp -o P_1_usual_code_MID_1.o
## clang++ -std=gnu++11 -I"/Library/Frameworks/R.framework/Resources/include" -DNDEBUG -DR_NO_REMAP   -DEIGEN_MPL2_ONLY=1 -I"/Library/Frameworks/R.framework/Versions/3.6/Resources/library/nimble/include" -Wno-misleading-indentation -Wno-ignored-attributes -Wno-deprecated-declarations  -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk -I/usr/local/include  -fPIC  -Wall -g -O2  -c P_1_usual_code_MID_1_nfCode.cpp -o P_1_usual_code_MID_1_nfCode.o
## clang++ -std=gnu++11 -dynamiclib -Wl,-headerpad_max_install_names -undefined dynamic_lookup -single_module -multiply_defined suppress -L/Library/Frameworks/R.framework/Resources/lib -L/usr/local/lib -o P_1_usual_code_MID_1_04_24_03_39_25.so P_1_usual_code_MID_1.o P_1_usual_code_MID_1_nfCode.o -L/Library/Frameworks/R.framework/Versions/3.6/Resources/library/nimble/CppCode -lnimble -L/Library/Frameworks/R.framework/Resources/lib -lRlapack -L/Library/Frameworks/R.framework/Resources/lib -lRblas -F/Library/Frameworks/R.framework/.. -framework R -Wl,-framework -Wl,CoreFoundation
## warning: unknown warning option '-Wno-misleading-indentation'; did you mean '-Wno-missing-declarations'? [-Wunknown-warning-option]
## 1 warning generated.
## warning: unknown warning option '-Wno-misleading-indentation'; did you mean '-Wno-missing-declarations'? [-Wunknown-warning-option]
## 1 warning generated.
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# (3) Configure the MCMC chain}
\NormalTok{usual01_conf <-}\StringTok{ }\KeywordTok{configureMCMC}\NormalTok{(usual01_model, }\DataTypeTok{monitors =} \KeywordTok{c}\NormalTok{(}\StringTok{'beta0'}\NormalTok{, }\StringTok{'beta'}\NormalTok{, }\StringTok{'sigma2'}\NormalTok{, }\StringTok{'s'}\NormalTok{))}

\CommentTok{# (4) Print samplers}
\NormalTok{usual01_conf}\OperatorTok{$}\KeywordTok{printSamplers}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1]  RW sampler: beta0
## [2]  RW sampler: beta[1]
## [3]  RW sampler: beta[2]
## [4]  RW sampler: beta[3]
## [5]  RW sampler: beta[4]
## [6]  RW sampler: beta[5]
## [7]  RW sampler: beta[6]
## [8]  RW sampler: beta[7]
## [9]  RW sampler: beta[8]
## [10] RW sampler: sigma2
## [11] CAR_normal sampler: s[1:18]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# (5) Build MCMC object}
\NormalTok{usual01_MCMC <-}\StringTok{ }\KeywordTok{buildMCMC}\NormalTok{(usual01_conf, }\DataTypeTok{enableWAIC =}\NormalTok{ T) }

\CommentTok{# (6) Compile model with MCMC object}
\NormalTok{usual01_CMCMC <-}\StringTok{ }\KeywordTok{compileNimble}\NormalTok{(usual01_MCMC, }\DataTypeTok{project =}\NormalTok{ usual01_Cmodel)  }

\CommentTok{# (7) Run the model}
\NormalTok{usual01_runMCMC <-}\StringTok{ }\KeywordTok{runMCMC}\NormalTok{(usual01_CMCMC, }\DataTypeTok{niter =} \DecValTok{200000}\NormalTok{, }\DataTypeTok{nburnin =} \DecValTok{15000}\NormalTok{, }\DataTypeTok{thin =} \DecValTok{20}\NormalTok{, }\DataTypeTok{nchains =} \DecValTok{2}\NormalTok{, }\DataTypeTok{WAIC =}\NormalTok{ T)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## |-------------|-------------|-------------|-------------|
## |-------------------------------------------------------|
## |-------------|-------------|-------------|-------------|
## |-------------------------------------------------------|
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# (8) Check convergence}
\NormalTok{usual01_samples =}\StringTok{ }\KeywordTok{rbind}\NormalTok{(usual01_runMCMC}\OperatorTok{$}\NormalTok{samples[[}\DecValTok{1}\NormalTok{]], usual01_runMCMC}\OperatorTok{$}\NormalTok{samples[[}\DecValTok{2}\NormalTok{]])}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Results ----------------------------------------------------------------------------------------}

\CommentTok{# (9) WAIC ---------------------------------------------------------------------------------------}
\NormalTok{usual01_runMCMC}\OperatorTok{$}\NormalTok{WAIC}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 117.9545
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# (10) Posterior summaries: Means and CrIs -------------------------------------------------------}

\CommentTok{################### Beta = Covariate estimates?}

\CommentTok{# Calculating the Beta means}
\NormalTok{means_betas_usual_}\DecValTok{01}\NormalTok{ <-}\StringTok{ }\KeywordTok{apply}\NormalTok{(usual01_samples[,}\DecValTok{1}\OperatorTok{:}\DecValTok{8}\NormalTok{],}\DecValTok{2}\NormalTok{, mean)}

\CommentTok{# Calculating the Beta 95% CrI }
\NormalTok{CrI_betas_usual_}\DecValTok{01}\NormalTok{ <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{apply}\NormalTok{(usual01_samples[ ,}\DecValTok{1}\OperatorTok{:}\DecValTok{8}\NormalTok{],}\DecValTok{2}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(x) }\KeywordTok{quantile}\NormalTok{(x, }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{,}\FloatTok{0.975}\NormalTok{))))}

\CommentTok{# Combining the means and CIs into a dataframe}
\NormalTok{mean_CrI_betas_usual_}\DecValTok{01}\NormalTok{ <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{matrix}\NormalTok{(}\KeywordTok{c}\NormalTok{(means_betas_usual_}\DecValTok{01}\NormalTok{, CrI_betas_usual_}\DecValTok{01}\NormalTok{), }\DataTypeTok{ncol=}\DecValTok{8}\NormalTok{, }\DataTypeTok{byrow=}\NormalTok{T)) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{()}

\CommentTok{# Renaming the columns}
\KeywordTok{colnames}\NormalTok{(mean_CrI_betas_usual_}\DecValTok{01}\NormalTok{) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Mean"}\NormalTok{, }\StringTok{"95% CrI LL"}\NormalTok{, }\StringTok{"95% CrI UL"}\NormalTok{)}

\CommentTok{# Converting means and CrIs from log to regular scale}
\KeywordTok{exp}\NormalTok{(mean_CrI_betas_usual_}\DecValTok{01}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##           Mean   95% CrI LL   95% CrI UL
## 1 7.807466e-01 3.650559e-01 1.568208e+00
## 2 1.155271e+08 7.458109e-01 3.589460e+14
## 3 3.200845e+03 1.123267e-08 1.186917e+15
## 4 4.035033e-08 6.970951e-28 1.427581e+12
## 5 1.618239e+06 8.862650e-03 6.306796e+14
## 6 4.469648e-06 2.536019e-30 9.747147e+14
## 7 1.074911e+00 9.223506e-01 1.291557e+00
## 8 1.000542e+00 9.994829e-01 1.001745e+00
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{################### S : estimates? per region}

\CommentTok{# Calculating the S means}
\NormalTok{means_s_usual_}\DecValTok{01}\NormalTok{ <-}\StringTok{ }\KeywordTok{apply}\NormalTok{(usual01_samples[ ,}\DecValTok{8}\OperatorTok{:}\NormalTok{(}\KeywordTok{ncol}\NormalTok{(usual01_samples)}\OperatorTok{-}\DecValTok{1}\NormalTok{)],}\DecValTok{2}\NormalTok{, mean)}

\CommentTok{# Calculating the S 95% CrI }
\NormalTok{CrI_s_usual_}\DecValTok{01}\NormalTok{ <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{apply}\NormalTok{(usual01_samples[ ,}\DecValTok{8}\OperatorTok{:}\NormalTok{(}\KeywordTok{ncol}\NormalTok{(usual01_samples)}\OperatorTok{-}\DecValTok{1}\NormalTok{)],}\DecValTok{2}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(x) }\KeywordTok{quantile}\NormalTok{(x, }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.015}\NormalTok{,}\FloatTok{0.975}\NormalTok{))))}

\CommentTok{# Combining the means and CIs into a dataframe}
\NormalTok{mean_CrI_s_usual_}\DecValTok{01}\NormalTok{ <-}\StringTok{ }\KeywordTok{cbind}\NormalTok{(means_s_usual_}\DecValTok{01}\NormalTok{, CrI_s_usual_}\DecValTok{01}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{()}

\CommentTok{# Renaming the columns}
\KeywordTok{colnames}\NormalTok{(mean_CrI_s_usual_}\DecValTok{01}\NormalTok{) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Mean"}\NormalTok{, }\StringTok{"95% CrI LL"}\NormalTok{, }\StringTok{"95% CrI UL"}\NormalTok{)}

\CommentTok{# Converting means and CrIs from log to regular scale}
\KeywordTok{exp}\NormalTok{(mean_CrI_s_usual_}\DecValTok{01}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                 Mean   95% CrI LL   95% CrI UL
## beta[8] 1.000542e+00 9.993638e-01  1.001744733
## beta0   2.516991e-09 8.344875e-18  0.001953246
## s[1]    2.511766e+00 7.200378e-01  6.248440748
## s[2]    1.302085e+00 2.295342e-01  4.665787130
## s[3]    1.411997e+00 3.374980e-01  7.061189223
## s[4]    1.043855e+00 3.809439e-01  3.109486121
## s[5]    5.704093e-01 2.291164e-01  1.231970644
## s[6]    1.076612e+00 3.639822e-01  3.087747654
## s[7]    1.059236e+00 3.032228e-01  4.285303107
## s[8]    6.557366e-01 3.186952e-01  1.211717031
## s[9]    8.774672e-01 4.824610e-01  1.596339544
## s[10]   6.856496e-01 2.946984e-01  1.451823664
## s[11]   3.470246e+00 1.943165e+00  5.816618529
## s[12]   8.538050e-01 3.984806e-01  1.786170986
## s[13]   3.729092e-01 1.507377e-01  0.763206866
## s[14]   5.103200e-01 1.560891e-01  1.393184120
## s[15]   2.245679e+00 3.157655e-01  8.720797038
## s[16]   6.480049e-01 1.825145e-01  1.798379601
## s[17]   3.250908e+00 8.844127e-01 10.518908333
## s[18]   3.030480e-01 9.789364e-02  0.810745361
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{################## beta 0 }

\CommentTok{# Calculating the beta0 means}
\NormalTok{mean_beta0_usual01 <-}\StringTok{ }\KeywordTok{mean}\NormalTok{(usual01_samples[ ,}\DecValTok{7}\NormalTok{])}

\CommentTok{# Calculating the Beta 95% CrI }
\NormalTok{CrI_beta0_usual_}\DecValTok{01}\NormalTok{ <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{quantile}\NormalTok{(usual01_samples[ , }\DecValTok{7}\NormalTok{], }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{,}\FloatTok{0.975}\NormalTok{)))}

\CommentTok{# Combining the means and CIs into a dataframe}
\NormalTok{mean_CrI_beta0_usual_}\DecValTok{01}\NormalTok{ <-}\StringTok{ }\KeywordTok{cbind}\NormalTok{(mean_beta0_usual01, CrI_beta0_usual_}\DecValTok{01}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{()}

\CommentTok{# Renaming the columns}
\KeywordTok{colnames}\NormalTok{(mean_CrI_beta0_usual_}\DecValTok{01}\NormalTok{) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Mean"}\NormalTok{, }\StringTok{"95% CrI LL"}\NormalTok{, }\StringTok{"95% CrI UL"}\NormalTok{)}

\CommentTok{# Converting means and CrIs from log to regular scale}
\KeywordTok{exp}\NormalTok{(mean_CrI_beta0_usual_}\DecValTok{01}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##       Mean 95% CrI LL 95% CrI UL
## 1 1.074911  0.9223506   1.291557
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# (11) Fitted values -----------------------------------------------------------------------------}

\CommentTok{# Creating matrix to store fitted values}
\NormalTok{fitted_usual01 =}\StringTok{ }\KeywordTok{matrix}\NormalTok{(}\OtherTok{NA}\NormalTok{, }\DataTypeTok{nrow=}\KeywordTok{nrow}\NormalTok{(usual01_samples), }\DataTypeTok{ncol=} \KeywordTok{nrow}\NormalTok{(data.clean))}

\CommentTok{# Loop to generate fitted values: log(ri)}
\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{nrow}\NormalTok{(data.clean))\{}
\NormalTok{  fitted_usual01[,i] =}\StringTok{ }\NormalTok{usual01_samples[,}\StringTok{"beta0"}\NormalTok{] }\OperatorTok{+}\StringTok{ }\KeywordTok{as.matrix}\NormalTok{(data.clean[i,}\DecValTok{5}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(data.clean)]) }\OperatorTok{%*%}\StringTok{ }

\StringTok{    }\KeywordTok{t}\NormalTok{(usual01_samples[,}\DecValTok{1}\OperatorTok{:}\DecValTok{8}\NormalTok{]) }\OperatorTok{+}\StringTok{ }\NormalTok{usual01_samples[, }\DecValTok{10}\OperatorTok{+}\NormalTok{i}\DecValTok{-1}\NormalTok{] }

\NormalTok{\}}




\CommentTok{# Mean fitted SIR}
\NormalTok{fitted_SIR_usual01 <-}\StringTok{ }\KeywordTok{exp}\NormalTok{(}\KeywordTok{apply}\NormalTok{(fitted_usual01, }\DecValTok{2}\NormalTok{, mean))}

\CommentTok{# Mean fitted Cases}
\NormalTok{fitted_usual_}\DecValTok{01}\NormalTok{ <-}\StringTok{ }\NormalTok{fitted_SIR_usual01}\OperatorTok{*}\NormalTok{data.clean}\OperatorTok{$}\NormalTok{Expected}

\CommentTok{# 95% CrI SIR}
\NormalTok{fitted_usual_}\DecValTok{01}\NormalTok{_CrI_SIR <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{exp}\NormalTok{(}\KeywordTok{apply}\NormalTok{(fitted_usual01, }\DecValTok{2}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(x) }\KeywordTok{quantile}\NormalTok{(x, }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{, }\FloatTok{0.975}\NormalTok{)))))}

\CommentTok{# 95% CrI Cases}
\NormalTok{fitted_usual_}\DecValTok{01}\NormalTok{_CrI <-}\StringTok{  }\NormalTok{data.clean}\OperatorTok{$}\NormalTok{Expected }\OperatorTok{*}\NormalTok{fitted_usual_}\DecValTok{01}\NormalTok{_CrI_SIR}

\CommentTok{# Creating Dataframe to store fitted values and quantiles in regular svale}
\NormalTok{fitted_usual01_df <-}\StringTok{ }\KeywordTok{data.frame}\NormalTok{(}\StringTok{"Observed SIR"}\NormalTok{   =}\StringTok{  }\KeywordTok{round}\NormalTok{(data.clean}\OperatorTok{$}\NormalTok{SIR, }\DecValTok{2}\NormalTok{), }
                                \StringTok{"Fitted SIR"}\NormalTok{     =}\StringTok{  }\KeywordTok{round}\NormalTok{(fitted_SIR_usual01,}\DecValTok{2}\NormalTok{), }
                                \StringTok{"Observed Cases"}\NormalTok{ =}\StringTok{  }\KeywordTok{round}\NormalTok{(data.clean}\OperatorTok{$}\NormalTok{Cases), }
                                \StringTok{"Fitted Cases"}\NormalTok{ =}\StringTok{  }\KeywordTok{round}\NormalTok{(fitted_usual_}\DecValTok{01}\NormalTok{), }
                                \StringTok{"CrI LL"}\NormalTok{    =}\StringTok{  }\KeywordTok{round}\NormalTok{(fitted_usual_}\DecValTok{01}\NormalTok{_CrI[,}\DecValTok{1}\NormalTok{]),}
                                \StringTok{"CrI UL"}\NormalTok{    =}\StringTok{  }\KeywordTok{round}\NormalTok{(fitted_usual_}\DecValTok{01}\NormalTok{_CrI[,}\DecValTok{2}\NormalTok{]))}


\CommentTok{# Top 6 rows}
\KeywordTok{head}\NormalTok{(fitted_usual01_df)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   Observed.SIR Fitted.SIR Observed.Cases Fitted.Cases CrI.LL CrI.UL
## 1         3.09       3.07             42           42     30     56
## 2         1.40       1.43             43           44     32     59
## 3         1.00       0.94              9            8      4     15
## 4         0.60       0.60             14           14      8     22
## 5         0.42       0.41             12           12      7     19
## 6         0.54       0.50             20           19     12     28
\end{verbatim}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/iCAR Adjacency  MCMC chains-1} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/iCAR Adjacency  MCMC chains-2} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/iCAR Adjacency  MCMC chains-3} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/iCAR Adjacency  MCMC chains-4} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/iCAR Adjacency  Posterior density curves-1} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/iCAR Adjacency  Posterior density curves-2} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/iCAR Adjacency  Posterior density curves-3} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/iCAR Adjacency  Posterior density curves-4} \end{center}

\textbf{Neighborhood structure 2: Distance-based neighbors (k = 3)}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Defining the data that goes into the model ----------------------------------------------------------------}

\CommentTok{# (1) Define constants that go into CAR prior into a list}
\NormalTok{Consts_usual_}\DecValTok{02}\NormalTok{ =}\StringTok{ }\KeywordTok{list}\NormalTok{(}\DataTypeTok{N =} \KeywordTok{nrow}\NormalTok{(data.clean),                    }\CommentTok{# Number of areas}
                       \DataTypeTok{p =} \KeywordTok{ncol}\NormalTok{(data.clean[}\DecValTok{5}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(data.clean)]),            }\CommentTok{# Number of covariates}
                       \DataTypeTok{X =} \KeywordTok{as.matrix}\NormalTok{(data.clean[, }\KeywordTok{c}\NormalTok{(}\DecValTok{5}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(data.clean))]),  }\CommentTok{# Matrix of covariates}
                       \DataTypeTok{L =} \KeywordTok{length}\NormalTok{(adj}\FloatTok{.3}\NormalTok{),                       }\CommentTok{# Edges (length of adj vector)}
                       \DataTypeTok{E =}\NormalTok{ data.clean}\OperatorTok{$}\NormalTok{Expected,                 }\CommentTok{# Expected cases}
                       \DataTypeTok{adj =}\NormalTok{ adj}\FloatTok{.3}\NormalTok{,                             }\CommentTok{# Adjacency matrix}
                       \DataTypeTok{num =}\NormalTok{ num.nb}\FloatTok{.3}\NormalTok{,                          }\CommentTok{# Number of neighbors per district}
                       \DataTypeTok{weights =} \KeywordTok{rep}\NormalTok{(}\DecValTok{1}\NormalTok{, }\KeywordTok{length}\NormalTok{(adj}\FloatTok{.3}\NormalTok{)))         }\CommentTok{# Giving weight of 1 for neighbors}

\CommentTok{# (2) Define dependent variable (outcome)}
\NormalTok{outcome <-}\StringTok{ }\KeywordTok{list}\NormalTok{(}\DataTypeTok{y =}\NormalTok{ data.clean}\OperatorTok{$}\NormalTok{Cases) }\CommentTok{# Observed cases}

\CommentTok{# (3) Define initial values for the MCMC chain}
\NormalTok{Inits_usual_}\DecValTok{02}\NormalTok{ <-}\StringTok{ }\KeywordTok{list}\NormalTok{(}\DataTypeTok{beta0 =} \DecValTok{0}\NormalTok{,}
                    \DataTypeTok{beta =} \KeywordTok{rep}\NormalTok{(}\DecValTok{0}\NormalTok{, }\KeywordTok{ncol}\NormalTok{(data.clean[}\DecValTok{5}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(data.clean)])), }
                    \DataTypeTok{sigma2 =} \DecValTok{1}\NormalTok{, }
                    \DataTypeTok{s =} \KeywordTok{rnorm}\NormalTok{(num.nb}\FloatTok{.3}\NormalTok{))}

\CommentTok{# Defining model --------------------------------------------------------------------------------------------}

\CommentTok{# (1) Define the usual fixed prior model for nimble}
\NormalTok{usual02_model <-}\StringTok{ }\KeywordTok{nimbleModel}\NormalTok{(}\DataTypeTok{code =}\NormalTok{ usual_code, }\DataTypeTok{constants =}\NormalTok{ Consts_usual_}\DecValTok{02}\NormalTok{, }\DataTypeTok{data =}\NormalTok{ outcome, }\DataTypeTok{inits =}\NormalTok{ Inits_usual_}\DecValTok{02}\NormalTok{)}

\CommentTok{# (2) Define the compiled nimble model}
\NormalTok{usual02_Cmodel <-}\StringTok{ }\KeywordTok{compileNimble}\NormalTok{(usual02_model, }\DataTypeTok{showCompilerOutput =} \OtherTok{TRUE}\NormalTok{)      }
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## clang++ -std=gnu++11 -I"/Library/Frameworks/R.framework/Resources/include" -DNDEBUG -DR_NO_REMAP   -DEIGEN_MPL2_ONLY=1 -I"/Library/Frameworks/R.framework/Versions/3.6/Resources/library/nimble/include" -Wno-misleading-indentation -Wno-ignored-attributes -Wno-deprecated-declarations  -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk -I/usr/local/include  -fPIC  -Wall -g -O2  -c P_2_usual_code_MID_2.cpp -o P_2_usual_code_MID_2.o
## clang++ -std=gnu++11 -I"/Library/Frameworks/R.framework/Resources/include" -DNDEBUG -DR_NO_REMAP   -DEIGEN_MPL2_ONLY=1 -I"/Library/Frameworks/R.framework/Versions/3.6/Resources/library/nimble/include" -Wno-misleading-indentation -Wno-ignored-attributes -Wno-deprecated-declarations  -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk -I/usr/local/include  -fPIC  -Wall -g -O2  -c P_2_usual_code_MID_2_nfCode.cpp -o P_2_usual_code_MID_2_nfCode.o
## clang++ -std=gnu++11 -dynamiclib -Wl,-headerpad_max_install_names -undefined dynamic_lookup -single_module -multiply_defined suppress -L/Library/Frameworks/R.framework/Resources/lib -L/usr/local/lib -o P_2_usual_code_MID_2_04_24_03_40_34.so P_2_usual_code_MID_2.o P_2_usual_code_MID_2_nfCode.o -L/Library/Frameworks/R.framework/Versions/3.6/Resources/library/nimble/CppCode -lnimble -L/Library/Frameworks/R.framework/Resources/lib -lRlapack -L/Library/Frameworks/R.framework/Resources/lib -lRblas -F/Library/Frameworks/R.framework/.. -framework R -Wl,-framework -Wl,CoreFoundation
## warning: unknown warning option '-Wno-misleading-indentation'; did you mean '-Wno-missing-declarations'? [-Wunknown-warning-option]
## 1 warning generated.
## warning: unknown warning option '-Wno-misleading-indentation'; did you mean '-Wno-missing-declarations'? [-Wunknown-warning-option]
## 1 warning generated.
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# (3) Configure the MCMC chain}
\NormalTok{usual02_conf <-}\StringTok{ }\KeywordTok{configureMCMC}\NormalTok{(usual02_model, }\DataTypeTok{monitors =} \KeywordTok{c}\NormalTok{(}\StringTok{'beta0'}\NormalTok{, }\StringTok{'beta'}\NormalTok{, }\StringTok{'sigma2'}\NormalTok{, }\StringTok{'s'}\NormalTok{))}

\CommentTok{# (4) Print samplers}
\NormalTok{usual02_conf}\OperatorTok{$}\KeywordTok{printSamplers}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1]  RW sampler: beta0
## [2]  RW sampler: beta[1]
## [3]  RW sampler: beta[2]
## [4]  RW sampler: beta[3]
## [5]  RW sampler: beta[4]
## [6]  RW sampler: beta[5]
## [7]  RW sampler: beta[6]
## [8]  RW sampler: beta[7]
## [9]  RW sampler: beta[8]
## [10] RW sampler: sigma2
## [11] CAR_normal sampler: s[1:18]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# (5) Build MCMC object}
\NormalTok{usual02_MCMC <-}\StringTok{ }\KeywordTok{buildMCMC}\NormalTok{(usual02_conf, }\DataTypeTok{enableWAIC =}\NormalTok{ T) }

\CommentTok{# (6) Compile model with MCMC object}
\NormalTok{usual02_CMCMC <-}\StringTok{ }\KeywordTok{compileNimble}\NormalTok{(usual02_MCMC, }\DataTypeTok{project =}\NormalTok{ usual02_Cmodel)  }

\CommentTok{# (7) Run the model}
\NormalTok{usual02_runMCMC <-}\StringTok{ }\KeywordTok{runMCMC}\NormalTok{(usual02_CMCMC, }\DataTypeTok{nburnin =} \DecValTok{10000}\NormalTok{, }\DataTypeTok{niter =} \DecValTok{200000}\NormalTok{, }\DataTypeTok{nchains =} \DecValTok{2}\NormalTok{, }\DataTypeTok{thin =} \DecValTok{25}\NormalTok{, }\DataTypeTok{WAIC =}\NormalTok{ T)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## |-------------|-------------|-------------|-------------|
## |-------------------------------------------------------|
## |-------------|-------------|-------------|-------------|
## |-------------------------------------------------------|
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# (8) Check convergence}
\NormalTok{usual02_samples =}\StringTok{ }\KeywordTok{rbind}\NormalTok{(usual02_runMCMC}\OperatorTok{$}\NormalTok{samples[[}\DecValTok{1}\NormalTok{]], usual02_runMCMC}\OperatorTok{$}\NormalTok{samples[[}\DecValTok{2}\NormalTok{]])}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Results ----------------------------------------------------------------------------------------}

\CommentTok{# (9) WAIC ---------------------------------------------------------------------------------------}
\NormalTok{usual02_runMCMC}\OperatorTok{$}\NormalTok{WAIC}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 116.3871
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# (10) Posterior summaries -----------------------------------------------------------------------}

\CommentTok{################### Betas : Covariate estimates}

\CommentTok{# Calculating the Beta means}
\NormalTok{means_betas_usual_}\DecValTok{02}\NormalTok{=}\KeywordTok{apply}\NormalTok{(usual02_samples[,}\DecValTok{1}\OperatorTok{:}\DecValTok{8}\NormalTok{],}\DecValTok{2}\NormalTok{, mean)}


\CommentTok{# Calculating the Beta 95% CrI }
\NormalTok{CrI_betas_usual_}\DecValTok{02}\NormalTok{=}\KeywordTok{t}\NormalTok{(}\KeywordTok{apply}\NormalTok{(usual02_samples[ ,}\DecValTok{1}\OperatorTok{:}\DecValTok{8}\NormalTok{],}\DecValTok{2}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(x) }\KeywordTok{quantile}\NormalTok{(x, }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{,}\FloatTok{0.975}\NormalTok{))))}

\CommentTok{# Combining the means and CIs into a dataframe}
\NormalTok{mean_CrI_betas_usual_}\DecValTok{02}\NormalTok{ <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{matrix}\NormalTok{(}\KeywordTok{c}\NormalTok{(means_betas_usual_}\DecValTok{02}\NormalTok{, CrI_betas_usual_}\DecValTok{02}\NormalTok{), }\DataTypeTok{ncol=}\DecValTok{8}\NormalTok{, }\DataTypeTok{byrow=}\NormalTok{T)) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{()}

\CommentTok{# Renaming the columns}
\KeywordTok{colnames}\NormalTok{(mean_CrI_betas_usual_}\DecValTok{02}\NormalTok{) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Mean"}\NormalTok{, }\StringTok{"95% CrI LL"}\NormalTok{, }\StringTok{"95% CrI UL"}\NormalTok{)}

\CommentTok{# Converting means and CrIs from log to regular scale}
\KeywordTok{exp}\NormalTok{(mean_CrI_betas_usual_}\DecValTok{02}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##           Mean   95% CrI LL   95% CrI UL
## 1 1.069433e+00 6.429191e-01 1.767548e+00
## 2 4.043915e+12 1.383166e+04 3.899583e+18
## 3 2.464204e+03 7.185107e-11 4.293901e+21
## 4 1.463245e-16 3.953825e-29 4.699326e-01
## 5 1.449276e-07 3.863708e-20 2.802879e+03
## 6 3.647228e-25 7.274503e-42 1.770636e-09
## 7 1.073304e+00 9.268584e-01 1.250906e+00
## 8 1.000401e+00 9.996201e-01 1.001256e+00
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{################### S : estimates? per region}

\CommentTok{# Calculating the S means}
\NormalTok{means_s_usual_}\DecValTok{02}\NormalTok{ <-}\StringTok{ }\KeywordTok{apply}\NormalTok{(usual02_samples[ ,}\DecValTok{8}\OperatorTok{:}\NormalTok{(}\KeywordTok{ncol}\NormalTok{(usual02_samples)}\OperatorTok{-}\DecValTok{1}\NormalTok{)],}\DecValTok{2}\NormalTok{, mean)}

\CommentTok{# Calculating the S 95% CrI }
\NormalTok{CrI_s_usual_}\DecValTok{02}\NormalTok{ <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{apply}\NormalTok{(usual02_samples[ ,}\DecValTok{8}\OperatorTok{:}\NormalTok{(}\KeywordTok{ncol}\NormalTok{(usual02_samples)}\OperatorTok{-}\DecValTok{1}\NormalTok{)],}\DecValTok{2}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(x) }\KeywordTok{quantile}\NormalTok{(x, }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{,}\FloatTok{0.975}\NormalTok{))))}

\CommentTok{# Combining the means and CIs into a dataframe}
\NormalTok{mean_CrI_s_usual_}\DecValTok{02}\NormalTok{ <-}\StringTok{ }\KeywordTok{cbind}\NormalTok{(means_s_usual_}\DecValTok{02}\NormalTok{, CrI_s_usual_}\DecValTok{02}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{()}

\CommentTok{# Renaming the columns}
\KeywordTok{colnames}\NormalTok{(mean_CrI_s_usual_}\DecValTok{02}\NormalTok{) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Mean"}\NormalTok{, }\StringTok{"95% CrI LL"}\NormalTok{, }\StringTok{"95% CrI UL"}\NormalTok{)}

\CommentTok{# Converting means and CrIs from log to regular scale}
\KeywordTok{exp}\NormalTok{(mean_CrI_s_usual_}\DecValTok{02}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                Mean   95% CrI LL   95% CrI UL
## beta[8]   1.0004006 0.9996200983 1.001256e+00
## beta0   123.8838617 0.0002790678 3.542050e+06
## s[1]      1.7539164 0.8427834391 3.692058e+00
## s[2]      1.5770885 0.6261052623 4.092202e+00
## s[3]      1.1065165 0.4777933584 2.570613e+00
## s[4]      0.7518183 0.3788521075 1.472648e+00
## s[5]      0.7073993 0.3852905156 1.295581e+00
## s[6]      0.9351565 0.4261709119 2.118764e+00
## s[7]      1.6209600 0.6766063068 4.041747e+00
## s[8]      0.6779387 0.3617074800 1.272175e+00
## s[9]      1.2728483 0.7660378973 2.172037e+00
## s[10]     0.5105136 0.2566688109 9.528015e-01
## s[11]     3.3834159 2.1117040150 5.456805e+00
## s[12]     1.2283987 0.6466912805 2.348813e+00
## s[13]     0.4242026 0.2150141657 7.553898e-01
## s[14]     0.6230071 0.2668046166 1.404609e+00
## s[15]     2.4020429 0.9851386130 6.166019e+00
## s[16]     0.7096171 0.3097013768 1.554738e+00
## s[17]     1.5732587 0.7312617158 3.313053e+00
## s[18]     0.3123220 0.1258319564 6.908816e-01
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{################## beta0 }

\CommentTok{# Calculating the beta0 means}
\NormalTok{mean_beta0_usual02 <-}\StringTok{ }\KeywordTok{mean}\NormalTok{(usual02_samples[ ,}\DecValTok{7}\NormalTok{])}

\CommentTok{# Calculating the beta0 95% CrI }
\NormalTok{CrI_beta0_usual_}\DecValTok{02}\NormalTok{ <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{quantile}\NormalTok{(usual02_samples[ , }\DecValTok{7}\NormalTok{], }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{,}\FloatTok{0.975}\NormalTok{)))}

\CommentTok{# Combining the means and CIs into a dataframe}
\NormalTok{mean_CrI_beta0_usual_}\DecValTok{02}\NormalTok{ <-}\StringTok{ }\KeywordTok{cbind}\NormalTok{(mean_beta0_usual02, CrI_beta0_usual_}\DecValTok{02}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{()}

\CommentTok{# Renaming the columns}
\KeywordTok{colnames}\NormalTok{(mean_CrI_beta0_usual_}\DecValTok{02}\NormalTok{) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Mean"}\NormalTok{, }\StringTok{"95% CrI LL"}\NormalTok{, }\StringTok{"95% CrI UL"}\NormalTok{)}

\CommentTok{# Converting means and CrIs from log to regular scale}
\KeywordTok{exp}\NormalTok{(mean_CrI_beta0_usual_}\DecValTok{02}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##       Mean 95% CrI LL 95% CrI UL
## 1 1.073304  0.9268584   1.250906
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# (11) Fitted values -----------------------------------------------------------------------------}

\CommentTok{# Creating matrix to store fitted values}
\NormalTok{fitted_usual02 =}\StringTok{ }\KeywordTok{matrix}\NormalTok{(}\OtherTok{NA}\NormalTok{, }\DataTypeTok{nrow=}\KeywordTok{nrow}\NormalTok{(usual02_samples), }\DataTypeTok{ncol=} \KeywordTok{nrow}\NormalTok{(data.clean))}

\CommentTok{# Loop to generate fitted values: log(ri)}
\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{nrow}\NormalTok{(data.clean))\{}
\NormalTok{  fitted_usual02[,i] =}\StringTok{ }\NormalTok{usual02_samples[,}\StringTok{"beta0"}\NormalTok{] }\OperatorTok{+}\StringTok{ }\KeywordTok{as.matrix}\NormalTok{(data.clean[i,}\DecValTok{5}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(data.clean)]) }\OperatorTok{%*%}\StringTok{ }
\StringTok{    }\KeywordTok{t}\NormalTok{(usual02_samples[,}\DecValTok{1}\OperatorTok{:}\DecValTok{8}\NormalTok{]) }\OperatorTok{+}\StringTok{ }\NormalTok{usual02_samples[, }\DecValTok{10}\OperatorTok{+}\NormalTok{i}\DecValTok{-1}\NormalTok{] }
\NormalTok{\}}

\CommentTok{# Mean fitted SIR}
\NormalTok{fitted_SIR_usual02 <-}\StringTok{ }\KeywordTok{exp}\NormalTok{(}\KeywordTok{apply}\NormalTok{(fitted_usual02, }\DecValTok{2}\NormalTok{, mean))}

\CommentTok{# 95% CrI SIR}
\NormalTok{fitted_usual02_CrI_SIR <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{exp}\NormalTok{(}\KeywordTok{apply}\NormalTok{(fitted_usual02, }\DecValTok{2}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(x) }\KeywordTok{quantile}\NormalTok{(x, }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{, }\FloatTok{0.975}\NormalTok{)))))}

\CommentTok{# Mean fitted Cases}
\NormalTok{fitted_usual_}\DecValTok{02}\NormalTok{ <-}\StringTok{ }\NormalTok{fitted_SIR_usual02}\OperatorTok{*}\NormalTok{data.clean}\OperatorTok{$}\NormalTok{Expected}

\CommentTok{# 95% CrI Cases}
\NormalTok{fitted_usual02_CrI <-}\StringTok{  }\NormalTok{data.clean}\OperatorTok{$}\NormalTok{Expected }\OperatorTok{*}\NormalTok{fitted_usual02_CrI_SIR}

\CommentTok{# Creating Dataframe to store fitted values and quantiles in regular svale}
\NormalTok{fitted_usual02_df <-}\StringTok{ }\KeywordTok{data.frame}\NormalTok{(}\StringTok{"Observed SIR"}\NormalTok{   =}\StringTok{  }\KeywordTok{round}\NormalTok{(data.clean}\OperatorTok{$}\NormalTok{SIR, }\DecValTok{2}\NormalTok{), }
                                \StringTok{"Fitted SIR"}\NormalTok{     =}\StringTok{  }\KeywordTok{round}\NormalTok{(fitted_SIR_usual02,}\DecValTok{2}\NormalTok{), }
                                \StringTok{"Observed Cases"}\NormalTok{ =}\StringTok{  }\KeywordTok{round}\NormalTok{(data.clean}\OperatorTok{$}\NormalTok{Cases), }
                                \StringTok{"Fitted Cases"}\NormalTok{ =}\StringTok{  }\KeywordTok{round}\NormalTok{(fitted_usual_}\DecValTok{02}\NormalTok{), }
                                \StringTok{"CrI LL"}\NormalTok{    =}\StringTok{  }\KeywordTok{round}\NormalTok{(fitted_usual02_CrI[,}\DecValTok{1}\NormalTok{]),}
                                \StringTok{"CrI UL"}\NormalTok{    =}\StringTok{  }\KeywordTok{round}\NormalTok{(fitted_usual02_CrI[,}\DecValTok{2}\NormalTok{]))}

\CommentTok{# Top 6 rows}
\KeywordTok{head}\NormalTok{(fitted_usual02_df)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   Observed.SIR Fitted.SIR Observed.Cases Fitted.Cases CrI.LL CrI.UL
## 1         3.09       3.09             42           42     31     56
## 2         1.40       1.41             43           43     32     58
## 3         1.00       0.89              9            8      4     14
## 4         0.60       0.63             14           15      9     23
## 5         0.42       0.39             12           11      7     18
## 6         0.54       0.51             20           19     12     29
\end{verbatim}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/iCAR K3  MCMC chains-1} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/iCAR K3  MCMC chains-2} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/iCAR K3  MCMC chains-3} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/iCAR K3  MCMC chains-4} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/iCAR K3  Posterior density curves-1} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/iCAR K3  Posterior density curves-2} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/iCAR K3  Posterior density curves-3} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/iCAR K3  Posterior density curves-4} \end{center}

\textbf{Neighborhood structure 3: Distance-based neighbors (k = 5)}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Defining the data that goes into the model ----------------------------------------------------------------}

\CommentTok{# (1) Define constants that go into CAR prior into a list}
\NormalTok{Consts_usual_}\DecValTok{03}\NormalTok{ =}\StringTok{ }\KeywordTok{list}\NormalTok{(}\DataTypeTok{N =} \KeywordTok{nrow}\NormalTok{(data.clean),                    }\CommentTok{# Number of areas}
                       \DataTypeTok{p =} \KeywordTok{ncol}\NormalTok{(data.clean[}\DecValTok{5}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(data.clean)]),            }\CommentTok{# Number of covariates}
                       \DataTypeTok{X =} \KeywordTok{as.matrix}\NormalTok{(data.clean[, }\KeywordTok{c}\NormalTok{(}\DecValTok{5}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(data.clean))]),  }\CommentTok{# Matrix of covariates}
                       \DataTypeTok{L =} \KeywordTok{length}\NormalTok{(adj}\FloatTok{.5}\NormalTok{),                       }\CommentTok{# Edges (length of adj vector)}
                       \DataTypeTok{E =}\NormalTok{ data.clean}\OperatorTok{$}\NormalTok{Expected,                 }\CommentTok{# Expected cases}
                       \DataTypeTok{adj =}\NormalTok{ adj}\FloatTok{.5}\NormalTok{,                             }\CommentTok{# Adjacency matrix}
                       \DataTypeTok{num =}\NormalTok{ num.nb}\FloatTok{.5}\NormalTok{,                          }\CommentTok{# Number of neighbors per district}
                       \DataTypeTok{weights =} \KeywordTok{rep}\NormalTok{(}\DecValTok{1}\NormalTok{, }\KeywordTok{length}\NormalTok{(adj}\FloatTok{.5}\NormalTok{)))         }\CommentTok{# Giving weight of 1 for neighbors}

\CommentTok{# (2) Define dependent variable (outcome)}
\NormalTok{outcome <-}\StringTok{ }\KeywordTok{list}\NormalTok{(}\DataTypeTok{y =}\NormalTok{ data.clean}\OperatorTok{$}\NormalTok{Cases) }\CommentTok{# Observed cases}

\CommentTok{# (3) Define initial values for the MCMC chain}
\NormalTok{Inits_usual_}\DecValTok{03}\NormalTok{ <-}\StringTok{ }\KeywordTok{list}\NormalTok{(}\DataTypeTok{beta0 =} \DecValTok{0}\NormalTok{,}
                    \DataTypeTok{beta =} \KeywordTok{rep}\NormalTok{(}\DecValTok{0}\NormalTok{, }\KeywordTok{ncol}\NormalTok{(data.clean[}\DecValTok{5}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(data.clean)])), }
                    \DataTypeTok{sigma2 =} \DecValTok{1}\NormalTok{, }
                    \DataTypeTok{s =} \KeywordTok{rnorm}\NormalTok{(num.nb}\FloatTok{.5}\NormalTok{)) }

\CommentTok{# Defining model --------------------------------------------------------------------------------------------}

\CommentTok{# (1) Define the usual fixed prior model for nimble}
\NormalTok{usual03_model <-}\StringTok{ }\KeywordTok{nimbleModel}\NormalTok{(}\DataTypeTok{code =}\NormalTok{ usual_code, }\DataTypeTok{constants =}\NormalTok{ Consts_usual_}\DecValTok{03}\NormalTok{, }\DataTypeTok{data =}\NormalTok{ outcome, }\DataTypeTok{inits =}\NormalTok{ Inits_usual_}\DecValTok{03}\NormalTok{)}

\CommentTok{# (2) Define the compiled nimble model}
\NormalTok{usual03_Cmodel <-}\StringTok{ }\KeywordTok{compileNimble}\NormalTok{(usual03_model, }\DataTypeTok{showCompilerOutput =} \OtherTok{TRUE}\NormalTok{)      }
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## clang++ -std=gnu++11 -I"/Library/Frameworks/R.framework/Resources/include" -DNDEBUG -DR_NO_REMAP   -DEIGEN_MPL2_ONLY=1 -I"/Library/Frameworks/R.framework/Versions/3.6/Resources/library/nimble/include" -Wno-misleading-indentation -Wno-ignored-attributes -Wno-deprecated-declarations  -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk -I/usr/local/include  -fPIC  -Wall -g -O2  -c P_3_usual_code_MID_3.cpp -o P_3_usual_code_MID_3.o
## clang++ -std=gnu++11 -I"/Library/Frameworks/R.framework/Resources/include" -DNDEBUG -DR_NO_REMAP   -DEIGEN_MPL2_ONLY=1 -I"/Library/Frameworks/R.framework/Versions/3.6/Resources/library/nimble/include" -Wno-misleading-indentation -Wno-ignored-attributes -Wno-deprecated-declarations  -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk -I/usr/local/include  -fPIC  -Wall -g -O2  -c P_3_usual_code_MID_3_nfCode.cpp -o P_3_usual_code_MID_3_nfCode.o
## clang++ -std=gnu++11 -dynamiclib -Wl,-headerpad_max_install_names -undefined dynamic_lookup -single_module -multiply_defined suppress -L/Library/Frameworks/R.framework/Resources/lib -L/usr/local/lib -o P_3_usual_code_MID_3_04_24_03_41_38.so P_3_usual_code_MID_3.o P_3_usual_code_MID_3_nfCode.o -L/Library/Frameworks/R.framework/Versions/3.6/Resources/library/nimble/CppCode -lnimble -L/Library/Frameworks/R.framework/Resources/lib -lRlapack -L/Library/Frameworks/R.framework/Resources/lib -lRblas -F/Library/Frameworks/R.framework/.. -framework R -Wl,-framework -Wl,CoreFoundation
## warning: unknown warning option '-Wno-misleading-indentation'; did you mean '-Wno-missing-declarations'? [-Wunknown-warning-option]
## 1 warning generated.
## warning: unknown warning option '-Wno-misleading-indentation'; did you mean '-Wno-missing-declarations'? [-Wunknown-warning-option]
## 1 warning generated.
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# (3) Configure the MCMC chain}
\NormalTok{usual03_conf <-}\StringTok{ }\KeywordTok{configureMCMC}\NormalTok{(usual03_model, }\DataTypeTok{monitors =} \KeywordTok{c}\NormalTok{(}\StringTok{'beta0'}\NormalTok{, }\StringTok{'beta'}\NormalTok{, }\StringTok{'sigma2'}\NormalTok{, }\StringTok{'s'}\NormalTok{))}

\CommentTok{# (4) Print samplers}
\NormalTok{usual03_conf}\OperatorTok{$}\KeywordTok{printSamplers}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1]  RW sampler: beta0
## [2]  RW sampler: beta[1]
## [3]  RW sampler: beta[2]
## [4]  RW sampler: beta[3]
## [5]  RW sampler: beta[4]
## [6]  RW sampler: beta[5]
## [7]  RW sampler: beta[6]
## [8]  RW sampler: beta[7]
## [9]  RW sampler: beta[8]
## [10] RW sampler: sigma2
## [11] CAR_normal sampler: s[1:18]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# (5) Build MCMC object}
\NormalTok{usual03_MCMC <-}\StringTok{ }\KeywordTok{buildMCMC}\NormalTok{(usual03_conf, }\DataTypeTok{enableWAIC =}\NormalTok{ T) }

\CommentTok{# (6) Compile model with MCMC object}
\NormalTok{usual03_CMCMC <-}\StringTok{ }\KeywordTok{compileNimble}\NormalTok{(usual03_MCMC, }\DataTypeTok{project =}\NormalTok{ usual03_Cmodel)  }

\CommentTok{# (7) Run the model}
\NormalTok{usual03_runMCMC <-}\StringTok{ }\KeywordTok{runMCMC}\NormalTok{(usual03_CMCMC, }\DataTypeTok{nburnin =} \DecValTok{50000}\NormalTok{, }\DataTypeTok{niter =} \DecValTok{200000}\NormalTok{, }\DataTypeTok{nchains =} \DecValTok{2}\NormalTok{, }\DataTypeTok{thin =} \DecValTok{5}\NormalTok{, }\DataTypeTok{WAIC =}\NormalTok{ T)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## |-------------|-------------|-------------|-------------|
## |-------------------------------------------------------|
## |-------------|-------------|-------------|-------------|
## |-------------------------------------------------------|
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# (8) Check convergence}
\NormalTok{usual03_samples =}\StringTok{ }\KeywordTok{rbind}\NormalTok{(usual03_runMCMC}\OperatorTok{$}\NormalTok{samples[[}\DecValTok{1}\NormalTok{]], usual03_runMCMC}\OperatorTok{$}\NormalTok{samples[[}\DecValTok{2}\NormalTok{]])}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Results ----------------------------------------------------------------------------------------}

\CommentTok{# (9) WAIC ---------------------------------------------------------------------------------------}
\NormalTok{usual03_runMCMC}\OperatorTok{$}\NormalTok{WAIC}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 117.4307
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# (10) Posterior summaries------------------------------------------------------------------------}

\CommentTok{################### Betas - covariate estimates}

\CommentTok{# Calculating the Beta means}
\NormalTok{means_betas_usual_}\DecValTok{03}\NormalTok{=}\KeywordTok{apply}\NormalTok{(usual03_samples[,}\DecValTok{1}\OperatorTok{:}\DecValTok{8}\NormalTok{],}\DecValTok{2}\NormalTok{, mean)}

\CommentTok{# Calculating the Beta 95% CrI }
\NormalTok{CrI_betas_usual_}\DecValTok{03}\NormalTok{=}\KeywordTok{t}\NormalTok{(}\KeywordTok{apply}\NormalTok{(usual03_samples[ ,}\DecValTok{1}\OperatorTok{:}\DecValTok{8}\NormalTok{],}\DecValTok{2}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(x) }\KeywordTok{quantile}\NormalTok{(x, }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{,}\FloatTok{0.975}\NormalTok{))))}

\CommentTok{# Combining the means and CIs into a dataframe}
\NormalTok{mean_CrI_betas_usual_}\DecValTok{03}\NormalTok{ <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{matrix}\NormalTok{(}\KeywordTok{c}\NormalTok{(means_betas_usual_}\DecValTok{03}\NormalTok{, CrI_betas_usual_}\DecValTok{03}\NormalTok{), }\DataTypeTok{ncol=}\DecValTok{8}\NormalTok{, }\DataTypeTok{byrow=}\NormalTok{T)) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{()}

\CommentTok{# Renaming the columns}
\KeywordTok{colnames}\NormalTok{(mean_CrI_betas_usual_}\DecValTok{03}\NormalTok{) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Mean"}\NormalTok{, }\StringTok{"95% CrI LL"}\NormalTok{, }\StringTok{"95% CrI UL"}\NormalTok{)}

\CommentTok{# Converting means and CrIs from log to regular scale}
\KeywordTok{exp}\NormalTok{(mean_CrI_betas_usual_}\DecValTok{03}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##           Mean   95% CrI LL   95% CrI UL
## 1 1.153902e+00 6.882646e-01 1.937373e+00
## 2 4.800086e+07 1.438052e-05 5.394168e+16
## 3 4.057968e+00 3.271559e-06 9.915043e+06
## 4 3.236021e+02 1.088548e-12 3.697536e+19
## 5 1.471073e+04 2.269388e-06 2.450429e+09
## 6 2.372106e-06 4.733869e-23 7.916372e+11
## 7 9.318802e-01 7.865382e-01 1.121628e+00
## 8 1.000263e+00 9.993495e-01 1.001243e+00
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{################### S : estimates? per region}

\CommentTok{# Calculating the S means}
\NormalTok{means_s_usual_}\DecValTok{03}\NormalTok{ <-}\StringTok{ }\KeywordTok{apply}\NormalTok{(usual03_samples[ ,}\DecValTok{8}\OperatorTok{:}\NormalTok{(}\KeywordTok{ncol}\NormalTok{(usual03_samples)}\OperatorTok{-}\DecValTok{1}\NormalTok{)],}\DecValTok{2}\NormalTok{, mean)}

\CommentTok{# Calculating the Beta 95% CrI }
\NormalTok{CrI_s_usual_}\DecValTok{03}\NormalTok{ <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{apply}\NormalTok{(usual03_samples[ ,}\DecValTok{8}\OperatorTok{:}\NormalTok{(}\KeywordTok{ncol}\NormalTok{(usual03_samples)}\OperatorTok{-}\DecValTok{1}\NormalTok{)],}\DecValTok{2}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(x) }\KeywordTok{quantile}\NormalTok{(x, }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{,}\FloatTok{0.975}\NormalTok{))))}

\CommentTok{# Combining the means and CIs into a dataframe}
\NormalTok{mean_CrI_s_usual_}\DecValTok{03}\NormalTok{ <-}\StringTok{ }\KeywordTok{cbind}\NormalTok{(means_s_usual_}\DecValTok{03}\NormalTok{, CrI_s_usual_}\DecValTok{03}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{()}

\CommentTok{# Renaming the columns}
\KeywordTok{colnames}\NormalTok{(mean_CrI_s_usual_}\DecValTok{03}\NormalTok{) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Mean"}\NormalTok{, }\StringTok{"95% CrI LL"}\NormalTok{, }\StringTok{"95% CrI UL"}\NormalTok{)}

\CommentTok{# Converting means and CrIs from log to regular scale}
\KeywordTok{exp}\NormalTok{(mean_CrI_s_usual_}\DecValTok{03}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                 Mean   95% CrI LL 95% CrI UL
## beta[8] 1.000263e+00 9.993495e-01  1.0012429
## beta0   4.844299e-07 1.427768e-14  9.4941643
## s[1]    1.429386e+00 5.709386e-01  3.3851899
## s[2]    1.198640e+00 3.715978e-01  3.4049723
## s[3]    1.053418e+00 4.076521e-01  2.6714809
## s[4]    6.801652e-01 3.324204e-01  1.3307406
## s[5]    8.386515e-01 4.210817e-01  1.6345615
## s[6]    1.368512e+00 6.241874e-01  3.1633372
## s[7]    1.650106e+00 6.352320e-01  4.8333532
## s[8]    4.399414e-01 2.135614e-01  0.8595859
## s[9]    1.103351e+00 6.236091e-01  1.9096673
## s[10]   6.973551e-01 3.548034e-01  1.3480001
## s[11]   2.884868e+00 1.762522e+00  4.7097348
## s[12]   9.781162e-01 4.915975e-01  1.9650566
## s[13]   4.598694e-01 2.352635e-01  0.8533158
## s[14]   9.511308e-01 3.881527e-01  2.4517623
## s[15]   2.577793e+00 9.801873e-01  7.9395115
## s[16]   6.557047e-01 2.578715e-01  1.6075366
## s[17]   1.887794e+00 8.496976e-01  4.3239334
## s[18]   3.226558e-01 1.216965e-01  0.7503355
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{################## beta0 }

\CommentTok{# Calculating the beta0 means}
\NormalTok{mean_beta0_usual03 <-}\StringTok{ }\KeywordTok{mean}\NormalTok{(usual03_samples[ ,}\DecValTok{7}\NormalTok{])}

\CommentTok{# Calculating the beta0 95% CrI }
\NormalTok{CrI_beta0_usual_}\DecValTok{03}\NormalTok{ <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{quantile}\NormalTok{(usual03_samples[ ,}\DecValTok{7}\NormalTok{], }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{,}\FloatTok{0.975}\NormalTok{)))}

\CommentTok{# Combining the means and CIs into a dataframe}
\NormalTok{mean_CrI_beta0_usual_}\DecValTok{03}\NormalTok{ <-}\StringTok{ }\KeywordTok{cbind}\NormalTok{(mean_beta0_usual03, CrI_beta0_usual_}\DecValTok{03}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{()}

\CommentTok{# Renaming the columns}
\KeywordTok{colnames}\NormalTok{(mean_CrI_beta0_usual_}\DecValTok{03}\NormalTok{) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Mean"}\NormalTok{, }\StringTok{"95% CrI LL"}\NormalTok{, }\StringTok{"95% CrI UL"}\NormalTok{)}

\CommentTok{# Converting means and CrIs from log to regular scale}

\KeywordTok{exp}\NormalTok{(mean_CrI_beta0_usual_}\DecValTok{03}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##        Mean 95% CrI LL 95% CrI UL
## 1 0.9318802  0.7865382   1.121628
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# (11) Fitted values -----------------------------------------------------------------------------}

\CommentTok{# Creating matrix to store fitted values}
\NormalTok{fitted_usual03 =}\StringTok{ }\KeywordTok{matrix}\NormalTok{(}\OtherTok{NA}\NormalTok{, }\DataTypeTok{nrow=}\KeywordTok{nrow}\NormalTok{(usual03_samples), }\DataTypeTok{ncol=} \KeywordTok{nrow}\NormalTok{(data.clean))}

\CommentTok{# Loop to generate fitted values: log(ri)}
\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{nrow}\NormalTok{(data.clean))\{}
\NormalTok{  fitted_usual03[,i] =}\StringTok{ }\NormalTok{usual03_samples[,}\StringTok{"beta0"}\NormalTok{] }\OperatorTok{+}\StringTok{ }\KeywordTok{as.matrix}\NormalTok{(data.clean[i,}\DecValTok{5}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(data.clean)]) }\OperatorTok{%*%}\StringTok{ }
\StringTok{    }\KeywordTok{t}\NormalTok{(usual03_samples[,}\DecValTok{1}\OperatorTok{:}\DecValTok{8}\NormalTok{]) }\OperatorTok{+}\StringTok{ }\NormalTok{usual03_samples[, }\DecValTok{10}\OperatorTok{+}\NormalTok{i}\DecValTok{-1}\NormalTok{] }
\NormalTok{\}}

\CommentTok{# Mean fitted SIR}
\NormalTok{fitted_SIR_usual03 <-}\StringTok{ }\KeywordTok{exp}\NormalTok{(}\KeywordTok{apply}\NormalTok{(fitted_usual03, }\DecValTok{2}\NormalTok{, mean))}

\CommentTok{# 95% CrI SIR}
\NormalTok{fitted_usual03_CrI_SIR <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{exp}\NormalTok{(}\KeywordTok{apply}\NormalTok{(fitted_usual03, }\DecValTok{2}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(x) }\KeywordTok{quantile}\NormalTok{(x, }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{, }\FloatTok{0.975}\NormalTok{)))))}

\CommentTok{# Mean fitted Cases}
\NormalTok{fitted_usual_}\DecValTok{03}\NormalTok{ <-}\StringTok{ }\NormalTok{fitted_SIR_usual03}\OperatorTok{*}\NormalTok{data.clean}\OperatorTok{$}\NormalTok{Expected}

\CommentTok{# 95% CrI Cases}
\NormalTok{fitted_usual03_CrI <-}\StringTok{  }\NormalTok{data.clean}\OperatorTok{$}\NormalTok{Expected }\OperatorTok{*}\NormalTok{fitted_usual03_CrI_SIR}

\CommentTok{# Creating Dataframe to store fitted values and quantiles in regular svale}
\NormalTok{fitted_usual03_df <-}\StringTok{ }\KeywordTok{data.frame}\NormalTok{(}\StringTok{"Observed SIR"}\NormalTok{   =}\StringTok{  }\KeywordTok{round}\NormalTok{(data.clean}\OperatorTok{$}\NormalTok{SIR, }\DecValTok{2}\NormalTok{), }
                                \StringTok{"Fitted SIR"}\NormalTok{     =}\StringTok{  }\KeywordTok{round}\NormalTok{(fitted_SIR_usual03,}\DecValTok{2}\NormalTok{), }
                                \StringTok{"Observed Cases"}\NormalTok{ =}\StringTok{  }\KeywordTok{round}\NormalTok{(data.clean}\OperatorTok{$}\NormalTok{Cases), }
                                \StringTok{"Fitted Cases"}\NormalTok{ =}\StringTok{  }\KeywordTok{round}\NormalTok{(fitted_usual_}\DecValTok{03}\NormalTok{), }
                                \StringTok{"CrI LL"}\NormalTok{    =}\StringTok{  }\KeywordTok{round}\NormalTok{(fitted_usual03_CrI[,}\DecValTok{1}\NormalTok{]),}
                                \StringTok{"CrI UL"}\NormalTok{    =}\StringTok{  }\KeywordTok{round}\NormalTok{(fitted_usual03_CrI[,}\DecValTok{2}\NormalTok{]))}

\CommentTok{# Top 6 rows}
\KeywordTok{head}\NormalTok{(fitted_usual03_df)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   Observed.SIR Fitted.SIR Observed.Cases Fitted.Cases CrI.LL CrI.UL
## 1         3.09       3.05             42           41     30     56
## 2         1.40       1.41             43           43     32     58
## 3         1.00       0.89              9            8      4     14
## 4         0.60       0.66             14           15      9     24
## 5         0.42       0.40             12           12      7     19
## 6         0.54       0.51             20           19     12     29
\end{verbatim}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/iCAR K5  MCMC chains-1} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/iCAR K5  MCMC chains-2} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/iCAR K5  MCMC chains-3} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/iCAR K5  MCMC chains-4} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/iCAR K5  Posterior density curves-1} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/iCAR K5  Posterior density curves-2} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/iCAR K5  Posterior density curves-3} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/iCAR K5  Posterior density curves-4} \end{center}

\hypertarget{bym-car}{%
\subsection{BYM CAR}\label{bym-car}}

\textbf{Nimble: BYMCAR Usual fixed priors model}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Defining the usual fixed priors model ------------------------------------------------------}
\NormalTok{usual_code_bym <-}\StringTok{ }\KeywordTok{nimbleCode}\NormalTok{(\{ }

  \CommentTok{# Defining our priors}
\NormalTok{  beta0 }\OperatorTok{~}\StringTok{ }\KeywordTok{dnorm}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DataTypeTok{sd =} \DecValTok{100}\NormalTok{)}
  \ControlFlowTok{for}\NormalTok{(j }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\NormalTok{p)\{}
\NormalTok{    beta[j] }\OperatorTok{~}\StringTok{ }\KeywordTok{dnorm}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DataTypeTok{sd =} \DecValTok{100}\NormalTok{)  }\CommentTok{# Betas for the covariates}
\NormalTok{  \}}
\NormalTok{  sigma2 }\OperatorTok{~}\StringTok{ }\KeywordTok{dinvgamma}\NormalTok{(}\DecValTok{1}\NormalTok{, }\FloatTok{0.01}\NormalTok{)     }\CommentTok{# Good b/c full conditional is IG --> makes MCMC easier}

  \CommentTok{# Defining transformed parameters}
  \CommentTok{# tauv ~ dinvgamma(1, 0.01) }
\NormalTok{  tau2 <-}\StringTok{ }\DecValTok{1}\OperatorTok{/}\NormalTok{sigma2}
\NormalTok{  s[}\DecValTok{1}\OperatorTok{:}\NormalTok{N] }\OperatorTok{~}\StringTok{ }\KeywordTok{dcar_normal}\NormalTok{(adj[}\DecValTok{1}\OperatorTok{:}\NormalTok{L], weights[}\DecValTok{1}\OperatorTok{:}\NormalTok{L], num[}\DecValTok{1}\OperatorTok{:}\NormalTok{N], tau2, }\DataTypeTok{zero_mean =} \DecValTok{1}\NormalTok{) }\CommentTok{# CAR prior}

  \CommentTok{# Defining likelihood}
  \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\NormalTok{N) \{ }\CommentTok{# inprod (beta1X + beta 2X)?}
    \KeywordTok{log}\NormalTok{(mu[i]) <-}\StringTok{ }\KeywordTok{log}\NormalTok{(E[i]) }\OperatorTok{+}\StringTok{ }\NormalTok{beta0}\OperatorTok{+}\StringTok{ }\KeywordTok{inprod}\NormalTok{(X[i, }\DecValTok{1}\OperatorTok{:}\NormalTok{p], beta[}\DecValTok{1}\OperatorTok{:}\NormalTok{p]) }\OperatorTok{+}\StringTok{ }\NormalTok{s[i] }\OperatorTok{+}\StringTok{ }\NormalTok{v[i] }
\NormalTok{    y[i] }\OperatorTok{~}\StringTok{ }\KeywordTok{dpois}\NormalTok{(mu[i]) }
\NormalTok{    v[i] }\OperatorTok{~}\StringTok{ }\KeywordTok{dnorm}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{100}\NormalTok{) }
\NormalTok{  \}}
\NormalTok{\})}
\end{Highlighting}
\end{Shaded}

\textbf{Neighborhood structure 1: Adjacency-based neighbors}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Defining the data that goes into the model ----------------------------------------------------------------}

\CommentTok{# (1) Define constants that go into CAR prior into a list}
\NormalTok{Consts_usual_bym_}\DecValTok{01}\NormalTok{ =}\StringTok{ }\KeywordTok{list}\NormalTok{(}\DataTypeTok{N =} \KeywordTok{nrow}\NormalTok{(data.clean),              }\CommentTok{# Number of areas}
                       \DataTypeTok{p =} \KeywordTok{ncol}\NormalTok{(data.clean[}\DecValTok{5}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(data.clean)]),            }\CommentTok{# Number of covariates}
                       \DataTypeTok{X =} \KeywordTok{as.matrix}\NormalTok{(data.clean[, }\KeywordTok{c}\NormalTok{(}\DecValTok{5}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(data.clean))]),  }\CommentTok{# Matrix of covariates}
                       \DataTypeTok{L =} \KeywordTok{length}\NormalTok{(adj),                       }\CommentTok{# Edges (length of adj vector)}
                       \DataTypeTok{E =}\NormalTok{ data.clean}\OperatorTok{$}\NormalTok{Expected,               }\CommentTok{# Expected cases}
                       \DataTypeTok{adj =}\NormalTok{ adj,                             }\CommentTok{# Adjacency matrix}
                       \DataTypeTok{num =}\NormalTok{ num.nb,                          }\CommentTok{# Number of neighbors per district}
                       \DataTypeTok{weights =} \KeywordTok{rep}\NormalTok{(}\DecValTok{1}\NormalTok{, }\KeywordTok{length}\NormalTok{(adj)))         }\CommentTok{# Giving weight of 1 for neighbors}

\CommentTok{# (2) Define dependent variable (outcome)}
\NormalTok{outcome <-}\StringTok{ }\KeywordTok{list}\NormalTok{(}\DataTypeTok{y =}\NormalTok{ data.clean}\OperatorTok{$}\NormalTok{Cases) }\CommentTok{# Observed cases}

\CommentTok{# (3) Define initial values for the MCMC chain}
\NormalTok{Inits_usual_bym_}\DecValTok{01}\NormalTok{ <-}\StringTok{ }\KeywordTok{list}\NormalTok{(}\DataTypeTok{beta0 =} \DecValTok{0}\NormalTok{,}
                           \DataTypeTok{beta =} \KeywordTok{rep}\NormalTok{(}\DecValTok{0}\NormalTok{, }\KeywordTok{ncol}\NormalTok{(data.clean[}\DecValTok{5}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(data.clean)])), }
                           \DataTypeTok{sigma2 =} \DecValTok{1}\NormalTok{, }
                           \DataTypeTok{s =} \KeywordTok{rnorm}\NormalTok{(num.nb),}
                           \DataTypeTok{v =}  \KeywordTok{rep}\NormalTok{(}\DecValTok{0}\NormalTok{, }\KeywordTok{nrow}\NormalTok{(data.clean)))}

\CommentTok{# Defining model --------------------------------------------------------------------------------------------}

\CommentTok{# (1) Define the usual fixed prior model for nimble}
\NormalTok{bym_usual01_model <-}\StringTok{ }\KeywordTok{nimbleModel}\NormalTok{(}\DataTypeTok{code =}\NormalTok{ usual_code_bym, }\DataTypeTok{constants =}\NormalTok{ Consts_usual_bym_}\DecValTok{01}\NormalTok{, }
                             \DataTypeTok{data =}\NormalTok{ outcome, }\DataTypeTok{inits =}\NormalTok{ Inits_usual_bym_}\DecValTok{01}\NormalTok{)}

\CommentTok{# (2) Define the compiled nimble model}
\NormalTok{bym_usual01_Cmodel <-}\StringTok{ }\KeywordTok{compileNimble}\NormalTok{(bym_usual01_model, }\DataTypeTok{showCompilerOutput =} \OtherTok{TRUE}\NormalTok{)      }
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## clang++ -std=gnu++11 -I"/Library/Frameworks/R.framework/Resources/include" -DNDEBUG -DR_NO_REMAP   -DEIGEN_MPL2_ONLY=1 -I"/Library/Frameworks/R.framework/Versions/3.6/Resources/library/nimble/include" -Wno-misleading-indentation -Wno-ignored-attributes -Wno-deprecated-declarations  -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk -I/usr/local/include  -fPIC  -Wall -g -O2  -c P_4_usual_code_MID_4.cpp -o P_4_usual_code_MID_4.o
## clang++ -std=gnu++11 -I"/Library/Frameworks/R.framework/Resources/include" -DNDEBUG -DR_NO_REMAP   -DEIGEN_MPL2_ONLY=1 -I"/Library/Frameworks/R.framework/Versions/3.6/Resources/library/nimble/include" -Wno-misleading-indentation -Wno-ignored-attributes -Wno-deprecated-declarations  -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk -I/usr/local/include  -fPIC  -Wall -g -O2  -c P_4_usual_code_MID_4_nfCode.cpp -o P_4_usual_code_MID_4_nfCode.o
## clang++ -std=gnu++11 -dynamiclib -Wl,-headerpad_max_install_names -undefined dynamic_lookup -single_module -multiply_defined suppress -L/Library/Frameworks/R.framework/Resources/lib -L/usr/local/lib -o P_4_usual_code_MID_4_04_24_03_42_52.so P_4_usual_code_MID_4.o P_4_usual_code_MID_4_nfCode.o -L/Library/Frameworks/R.framework/Versions/3.6/Resources/library/nimble/CppCode -lnimble -L/Library/Frameworks/R.framework/Resources/lib -lRlapack -L/Library/Frameworks/R.framework/Resources/lib -lRblas -F/Library/Frameworks/R.framework/.. -framework R -Wl,-framework -Wl,CoreFoundation
## warning: unknown warning option '-Wno-misleading-indentation'; did you mean '-Wno-missing-declarations'? [-Wunknown-warning-option]
## 1 warning generated.
## warning: unknown warning option '-Wno-misleading-indentation'; did you mean '-Wno-missing-declarations'? [-Wunknown-warning-option]
## 1 warning generated.
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# (3) Configure the MCMC chain}
\NormalTok{bym_usual01_conf <-}\StringTok{ }\KeywordTok{configureMCMC}\NormalTok{(bym_usual01_model, }\DataTypeTok{monitors =} \KeywordTok{c}\NormalTok{(}\StringTok{'beta0'}\NormalTok{, }\StringTok{'beta'}\NormalTok{, }\StringTok{'sigma2'}\NormalTok{, }\StringTok{'s'}\NormalTok{, }\StringTok{'v'}\NormalTok{))}

\CommentTok{# (4) Do something}
\NormalTok{bym_usual01_conf}\OperatorTok{$}\KeywordTok{printSamplers}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1]  RW sampler: beta0
## [2]  RW sampler: beta[1]
## [3]  RW sampler: beta[2]
## [4]  RW sampler: beta[3]
## [5]  RW sampler: beta[4]
## [6]  RW sampler: beta[5]
## [7]  RW sampler: beta[6]
## [8]  RW sampler: beta[7]
## [9]  RW sampler: beta[8]
## [10] RW sampler: sigma2
## [11] RW sampler: v[1]
## [12] RW sampler: v[2]
## [13] RW sampler: v[3]
## [14] RW sampler: v[4]
## [15] RW sampler: v[5]
## [16] RW sampler: v[6]
## [17] RW sampler: v[7]
## [18] RW sampler: v[8]
## [19] RW sampler: v[9]
## [20] RW sampler: v[10]
## [21] RW sampler: v[11]
## [22] RW sampler: v[12]
## [23] RW sampler: v[13]
## [24] RW sampler: v[14]
## [25] RW sampler: v[15]
## [26] RW sampler: v[16]
## [27] RW sampler: v[17]
## [28] RW sampler: v[18]
## [29] CAR_normal sampler: s[1:18]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# (5) Build MCMC object}
\NormalTok{bym_usual01_MCMC <-}\StringTok{ }\KeywordTok{buildMCMC}\NormalTok{(bym_usual01_conf, }\DataTypeTok{enableWAIC =}\NormalTok{ T) }

\CommentTok{# (6) Compile model with MCMC object}
\NormalTok{bym_usual01_CMCMC <-}\StringTok{ }\KeywordTok{compileNimble}\NormalTok{(bym_usual01_MCMC, }\DataTypeTok{project =}\NormalTok{ bym_usual01_Cmodel)  }

\CommentTok{# (7) Run the model}
\NormalTok{bym_usual01_runMCMC <-}\StringTok{ }\KeywordTok{runMCMC}\NormalTok{(bym_usual01_CMCMC, }\DataTypeTok{nburnin =} \DecValTok{10000}\NormalTok{, }\DataTypeTok{niter =} \DecValTok{200000}\NormalTok{, }\DataTypeTok{nchains =} \DecValTok{2}\NormalTok{, }\DataTypeTok{thin =} \DecValTok{25}\NormalTok{, }\DataTypeTok{WAIC =}\NormalTok{ T)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## |-------------|-------------|-------------|-------------|
## |-------------------------------------------------------|
## |-------------|-------------|-------------|-------------|
## |-------------------------------------------------------|
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# (8) Check convergence}
\NormalTok{bym_usual01_samples =}\StringTok{ }\KeywordTok{rbind}\NormalTok{(bym_usual01_runMCMC}\OperatorTok{$}\NormalTok{samples[[}\DecValTok{1}\NormalTok{]], bym_usual01_runMCMC}\OperatorTok{$}\NormalTok{samples[[}\DecValTok{2}\NormalTok{]])}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# (10) Posterior summaries--------------------------------------------------------------------}

\CommentTok{################### betas : covariates}

\CommentTok{# Calculating the Beta means}
\NormalTok{means_betas_bym_usual01 <-}\StringTok{ }\KeywordTok{apply}\NormalTok{(bym_usual01_samples[,}\DecValTok{1}\OperatorTok{:}\DecValTok{8}\NormalTok{],}\DecValTok{2}\NormalTok{, mean)}

\CommentTok{# Calculating the Beta 95% CrI }
\NormalTok{CrI_betas_bym_usual01 <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{apply}\NormalTok{(bym_usual01_samples[ ,}\DecValTok{1}\OperatorTok{:}\DecValTok{8}\NormalTok{],}\DecValTok{2}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(x) }\KeywordTok{quantile}\NormalTok{(x, }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{,}\FloatTok{0.975}\NormalTok{))))}

\CommentTok{# Combining the means and CIs into a dataframe}
\NormalTok{mean_CrI_betas_bym_usual01 <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{matrix}\NormalTok{(}\KeywordTok{c}\NormalTok{(means_betas_bym_usual01, CrI_betas_bym_usual01), }\DataTypeTok{ncol=}\DecValTok{8}\NormalTok{, }\DataTypeTok{byrow=}\NormalTok{T)) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{()}

\CommentTok{# Renaming the columns}
\KeywordTok{colnames}\NormalTok{(mean_CrI_betas_bym_usual01) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Mean"}\NormalTok{, }\StringTok{"95% CrI LL"}\NormalTok{, }\StringTok{"95% CrI UL"}\NormalTok{)}

\CommentTok{# Converting means and CrIs from log to regular scale}
\KeywordTok{exp}\NormalTok{(mean_CrI_betas_bym_usual01)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##           Mean   95% CrI LL   95% CrI UL
## 1 1.139114e+00 4.966402e-01 2.504145e+00
## 2 1.551340e-08 2.086481e-17 3.360256e-01
## 3 1.568709e-13 4.567274e-27 5.681658e+04
## 4 6.628852e-18 6.652814e-39 3.834047e+08
## 5 1.234014e+05 1.033096e-07 3.467120e+14
## 6 7.592508e-23 1.046876e-50 1.430766e+08
## 7 9.255069e-01 7.435530e-01 1.131684e+00
## 8 1.000137e+00 9.988630e-01 1.001440e+00
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{################### S : estimates? per region}

\CommentTok{# Calculating the S means}
\NormalTok{means_s_bym_usual01 <-}\StringTok{ }\KeywordTok{apply}\NormalTok{(bym_usual01_samples[ ,}\DecValTok{10}\OperatorTok{:}\DecValTok{27}\NormalTok{],}\DecValTok{2}\NormalTok{, mean)}

\CommentTok{# Calculating the Beta 95% CrI }
\NormalTok{CrI_s_bym_usual01 <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{apply}\NormalTok{(bym_usual01_samples[ ,}\DecValTok{10}\OperatorTok{:}\DecValTok{27}\NormalTok{],}\DecValTok{2}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(x) }\KeywordTok{quantile}\NormalTok{(x, }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{,}\FloatTok{0.975}\NormalTok{))))}

\CommentTok{# Combining the means and CIs into a dataframe}
\NormalTok{mean_CrI_s_bym_usual01 <-}\StringTok{ }\KeywordTok{cbind}\NormalTok{(means_s_bym_usual01, CrI_s_bym_usual01) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{()}

\CommentTok{# Renaming the columns}
\KeywordTok{colnames}\NormalTok{(mean_CrI_s_bym_usual01) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Mean"}\NormalTok{, }\StringTok{"95% CrI LL"}\NormalTok{, }\StringTok{"95% CrI UL"}\NormalTok{)}

\CommentTok{# Converting means and CrIs from log to regular scale}
\KeywordTok{exp}\NormalTok{(mean_CrI_s_bym_usual01)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##            Mean 95% CrI LL 95% CrI UL
## s[1]  5.9961353 1.54952516 21.3926609
## s[2]  1.7104920 0.26775768  8.7875253
## s[3]  2.2450198 0.41459631  8.5430013
## s[4]  0.7020103 0.23497164  1.9244339
## s[5]  0.5974986 0.25110861  1.3649792
## s[6]  1.0090426 0.33154758  3.2214695
## s[7]  0.4707133 0.11036879  2.2172044
## s[8]  0.5323506 0.25032026  1.0796077
## s[9]  0.7765210 0.39696380  1.4936980
## s[10] 0.6148493 0.26108686  1.5180058
## s[11] 5.3663057 2.33325385 11.2055386
## s[12] 0.4420566 0.17930089  1.1635390
## s[13] 0.4128378 0.16298279  1.0818066
## s[14] 0.6059092 0.15520919  2.5802577
## s[15] 6.0139179 1.13144634 29.5487007
## s[16] 0.4526721 0.12725253  1.4387864
## s[17] 2.7603387 0.78143622 12.1192966
## s[18] 0.1923435 0.05304441  0.6513342
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{################### V : estimates? per region}

\CommentTok{# Calculating the V means}
\NormalTok{means_v_bym_usual01 <-}\StringTok{ }\KeywordTok{apply}\NormalTok{(bym_usual01_samples[ ,}\DecValTok{29}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(bym_usual01_samples)],}\DecValTok{2}\NormalTok{, mean)}

\CommentTok{# Calculating the V 95% CrI }
\NormalTok{CrI_v_bym_usual01 <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{apply}\NormalTok{(bym_usual01_samples[ ,}\DecValTok{29}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(bym_usual01_samples)],}\DecValTok{2}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(x) }\KeywordTok{quantile}\NormalTok{(x, }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{,}\FloatTok{0.975}\NormalTok{))))}

\CommentTok{#Combining the means and CIs into a dataframe}
\NormalTok{mean_CrI_v_bym_usual01 <-}\StringTok{ }\KeywordTok{cbind}\NormalTok{(means_v_bym_usual01, CrI_v_bym_usual01) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{()}

\CommentTok{#Renaming the columns}
\KeywordTok{colnames}\NormalTok{(mean_CrI_v_bym_usual01) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Mean"}\NormalTok{, }\StringTok{"95% CrI LL"}\NormalTok{, }\StringTok{"95% CrI UL"}\NormalTok{)}


\CommentTok{################## beta 0 }

\CommentTok{# Calculating the beta0 means}
\NormalTok{mean_beta0_bym_usual01 <-}\StringTok{ }\KeywordTok{mean}\NormalTok{(bym_usual01_samples[ , }\StringTok{"beta0"}\NormalTok{])}

\CommentTok{# Calculating the Beta 95% CrI }
\NormalTok{CrI_beta0_bym_usual01 <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{quantile}\NormalTok{(bym_usual01_samples[ , }\StringTok{"beta0"}\NormalTok{], }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{,}\FloatTok{0.975}\NormalTok{)))}

\CommentTok{# Combining the means and CIs into a dataframe}
\NormalTok{mean_CrI_beta0_bym_usual01 <-}\StringTok{ }\KeywordTok{cbind}\NormalTok{(mean_beta0_bym_usual01, CrI_beta0_bym_usual01) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{()}


\CommentTok{# Renaming the columns}
\KeywordTok{colnames}\NormalTok{(mean_CrI_beta0_bym_usual01) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Mean"}\NormalTok{, }\StringTok{"95% CrI LL"}\NormalTok{, }\StringTok{"95% CrI UL"}\NormalTok{)}

\CommentTok{# Converting means and CrIs from log to regular scale}
\KeywordTok{exp}\NormalTok{(mean_CrI_beta0_bym_usual01)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##           Mean 95% CrI LL   95% CrI UL
## 1 6.874504e+15   6561.904 6.168104e+23
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# (11) Fitted values  ----------------------------------------------------------------------------}

\CommentTok{# Creating matrix to store fitted values}
\NormalTok{fitted_bym_usual01 =}\StringTok{ }\KeywordTok{matrix}\NormalTok{(}\OtherTok{NA}\NormalTok{, }\DataTypeTok{nrow=}\KeywordTok{nrow}\NormalTok{(bym_usual01_samples), }\DataTypeTok{ncol=} \KeywordTok{nrow}\NormalTok{(data.clean))}

\CommentTok{# Loop to generate fitted values: log(ri)}
\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{nrow}\NormalTok{(data.clean))\{}
\NormalTok{  fitted_bym_usual01[,i] =}\StringTok{ }\NormalTok{bym_usual01_samples[,}\StringTok{"beta0"}\NormalTok{] }\OperatorTok{+}\StringTok{ }\KeywordTok{as.matrix}\NormalTok{(data.clean[i,}\DecValTok{5}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(data.clean)]) }\OperatorTok{%*%}\StringTok{ }
\StringTok{    }\KeywordTok{t}\NormalTok{(bym_usual01_samples[,}\DecValTok{1}\OperatorTok{:}\DecValTok{8}\NormalTok{]) }
  \OperatorTok{+}\StringTok{ }\NormalTok{bym_usual01_samples[, }\DecValTok{10}\OperatorTok{+}\NormalTok{i}\DecValTok{-1}\NormalTok{] }
  \OperatorTok{+}\StringTok{ }\NormalTok{bym_usual01_samples[ , }\DecValTok{29}\OperatorTok{+}\NormalTok{i}\DecValTok{-1}\NormalTok{]}
\NormalTok{\}}

\CommentTok{# Mean fitted SIR}
\NormalTok{fitted_SIR_bym_usual01 <-}\StringTok{ }\KeywordTok{exp}\NormalTok{(}\KeywordTok{apply}\NormalTok{(fitted_bym_usual01, }\DecValTok{2}\NormalTok{, mean))}

\CommentTok{# 95% CrI SIR}
\NormalTok{fitted_bym_usual01_CrI_SIR <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{exp}\NormalTok{(}\KeywordTok{apply}\NormalTok{(fitted_bym_usual01, }\DecValTok{2}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(x) }\KeywordTok{quantile}\NormalTok{(x, }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{, }\FloatTok{0.975}\NormalTok{)))))}

\CommentTok{# Mean fitted Cases}
\NormalTok{fitted_bym_usual_}\DecValTok{01}\NormalTok{ <-}\StringTok{ }\NormalTok{fitted_SIR_bym_usual01}\OperatorTok{*}\NormalTok{data.clean}\OperatorTok{$}\NormalTok{Expected}

\CommentTok{# 95% CrI Cases}
\NormalTok{fitted_bym_usual01_CrI <-}\StringTok{  }\NormalTok{data.clean}\OperatorTok{$}\NormalTok{Expected }\OperatorTok{*}\NormalTok{fitted_bym_usual01_CrI_SIR}

\CommentTok{# Creating Dataframe to store fitted values and quantiles in regular svale}
\NormalTok{fitted_bym_usual01_df <-}\StringTok{ }\KeywordTok{data.frame}\NormalTok{(}\StringTok{"Observed SIR"}\NormalTok{   =}\StringTok{  }\KeywordTok{round}\NormalTok{(data.clean}\OperatorTok{$}\NormalTok{SIR, }\DecValTok{2}\NormalTok{), }
                                \StringTok{"Fitted SIR"}\NormalTok{     =}\StringTok{  }\KeywordTok{round}\NormalTok{(fitted_SIR_bym_usual01,}\DecValTok{2}\NormalTok{), }
                                \StringTok{"Observed Cases"}\NormalTok{ =}\StringTok{  }\KeywordTok{round}\NormalTok{(data.clean}\OperatorTok{$}\NormalTok{Cases), }
                                \StringTok{"Fitted Cases"}\NormalTok{ =}\StringTok{  }\KeywordTok{round}\NormalTok{(fitted_bym_usual_}\DecValTok{01}\NormalTok{), }
                                \StringTok{"CrI LL"}\NormalTok{    =}\StringTok{  }\KeywordTok{round}\NormalTok{(fitted_bym_usual01_CrI[,}\DecValTok{1}\NormalTok{]),}
                                \StringTok{"CrI UL"}\NormalTok{    =}\StringTok{  }\KeywordTok{round}\NormalTok{(fitted_bym_usual01_CrI[,}\DecValTok{2}\NormalTok{]))}

\CommentTok{# Top 6 rows}
\KeywordTok{head}\NormalTok{(fitted_bym_usual01_df)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   Observed.SIR Fitted.SIR Observed.Cases Fitted.Cases CrI.LL CrI.UL
## 1         3.09       0.51             42            7      2     27
## 2         1.40       0.86             43           26      5    167
## 3         1.00       0.42              9            4      1     18
## 4         0.60       0.90             14           21      8     63
## 5         0.42       0.67             12           19      9     42
## 6         0.54       0.48             20           18      6     55
\end{verbatim}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/BYM Adjacency MCMC chains-1} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/BYM Adjacency MCMC chains-2} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/BYM Adjacency MCMC chains-3} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/BYM Adjacency MCMC chains-4} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/BYM Adjacency Posterior density curve-1} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/BYM Adjacency Posterior density curve-2} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/BYM Adjacency Posterior density curve-3} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/BYM Adjacency Posterior density curve-4} \end{center}

\textbf{Neighborhood structure 2: Distance-based neighbors (k = 3)}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Defining the data that goes into the model ----------------------------------------------------------------}

\CommentTok{# (1) Define constants that go into CAR prior into a list}
\NormalTok{Consts_usual_bym_}\DecValTok{02}\NormalTok{ =}\StringTok{ }\KeywordTok{list}\NormalTok{(}\DataTypeTok{N =} \KeywordTok{nrow}\NormalTok{(data.clean),                }\CommentTok{# Number of areas}
                       \DataTypeTok{p =} \KeywordTok{ncol}\NormalTok{(data.clean[}\DecValTok{5}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(data.clean)]),            }\CommentTok{# Number of covariates}
                       \DataTypeTok{X =} \KeywordTok{as.matrix}\NormalTok{(data.clean[, }\KeywordTok{c}\NormalTok{(}\DecValTok{5}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(data.clean))]),  }\CommentTok{# Matrix of covariates}
                       \DataTypeTok{L =} \KeywordTok{length}\NormalTok{(adj}\FloatTok{.3}\NormalTok{),                       }\CommentTok{# Edges (length of adj vector)}
                       \DataTypeTok{E =}\NormalTok{ data.clean}\OperatorTok{$}\NormalTok{Expected,                 }\CommentTok{# Expected cases}
                       \DataTypeTok{adj =}\NormalTok{ adj}\FloatTok{.3}\NormalTok{,                             }\CommentTok{# Adjacency matrix}
                       \DataTypeTok{num =}\NormalTok{ num.nb}\FloatTok{.3}\NormalTok{,                          }\CommentTok{# Number of neighbors per district}
                       \DataTypeTok{weights =} \KeywordTok{rep}\NormalTok{(}\DecValTok{1}\NormalTok{, }\KeywordTok{length}\NormalTok{(adj}\FloatTok{.3}\NormalTok{)))         }\CommentTok{# Giving weight of 1 for neighbors}

\CommentTok{# (2) Define dependent variable (outcome)}
\NormalTok{outcome <-}\StringTok{ }\KeywordTok{list}\NormalTok{(}\DataTypeTok{y =}\NormalTok{ data.clean}\OperatorTok{$}\NormalTok{Cases) }\CommentTok{# Observed cases}

\CommentTok{# (3) Define initial values for the MCMC chain}
\NormalTok{Inits_usual_bym_}\DecValTok{02}\NormalTok{ <-}\StringTok{ }\KeywordTok{list}\NormalTok{(}\DataTypeTok{beta0 =} \DecValTok{0}\NormalTok{,}
                           \DataTypeTok{beta =} \KeywordTok{rep}\NormalTok{(}\DecValTok{0}\NormalTok{, }\KeywordTok{ncol}\NormalTok{(data.clean[}\DecValTok{5}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(data.clean)])), }
                           \DataTypeTok{sigma2 =} \DecValTok{1}\NormalTok{, }
                           \DataTypeTok{s =} \KeywordTok{rnorm}\NormalTok{(num.nb}\FloatTok{.3}\NormalTok{),}
                           \DataTypeTok{v =}  \KeywordTok{rep}\NormalTok{(}\DecValTok{0}\NormalTok{, }\KeywordTok{nrow}\NormalTok{(data.clean)))}

\CommentTok{# Defining model --------------------------------------------------------------------------------------------}

\CommentTok{# (1) Define the usual fixed prior model for nimble}
\NormalTok{bym_usual02_model <-}\StringTok{ }\KeywordTok{nimbleModel}\NormalTok{(}\DataTypeTok{code =}\NormalTok{ usual_code_bym, }\DataTypeTok{constants =}\NormalTok{ Consts_usual_bym_}\DecValTok{02}\NormalTok{, }
                                 \DataTypeTok{data =}\NormalTok{ outcome, }\DataTypeTok{inits =}\NormalTok{ Inits_usual_bym_}\DecValTok{02}\NormalTok{)}

\CommentTok{# (2) Define the compiled nimble model}
\NormalTok{bym_usual02_Cmodel <-}\StringTok{ }\KeywordTok{compileNimble}\NormalTok{(bym_usual02_model, }\DataTypeTok{showCompilerOutput =} \OtherTok{TRUE}\NormalTok{)      }
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## clang++ -std=gnu++11 -I"/Library/Frameworks/R.framework/Resources/include" -DNDEBUG -DR_NO_REMAP   -DEIGEN_MPL2_ONLY=1 -I"/Library/Frameworks/R.framework/Versions/3.6/Resources/library/nimble/include" -Wno-misleading-indentation -Wno-ignored-attributes -Wno-deprecated-declarations  -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk -I/usr/local/include  -fPIC  -Wall -g -O2  -c P_5_usual_code_MID_5.cpp -o P_5_usual_code_MID_5.o
## clang++ -std=gnu++11 -I"/Library/Frameworks/R.framework/Resources/include" -DNDEBUG -DR_NO_REMAP   -DEIGEN_MPL2_ONLY=1 -I"/Library/Frameworks/R.framework/Versions/3.6/Resources/library/nimble/include" -Wno-misleading-indentation -Wno-ignored-attributes -Wno-deprecated-declarations  -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk -I/usr/local/include  -fPIC  -Wall -g -O2  -c P_5_usual_code_MID_5_nfCode.cpp -o P_5_usual_code_MID_5_nfCode.o
## clang++ -std=gnu++11 -dynamiclib -Wl,-headerpad_max_install_names -undefined dynamic_lookup -single_module -multiply_defined suppress -L/Library/Frameworks/R.framework/Resources/lib -L/usr/local/lib -o P_5_usual_code_MID_5_04_24_03_44_00.so P_5_usual_code_MID_5.o P_5_usual_code_MID_5_nfCode.o -L/Library/Frameworks/R.framework/Versions/3.6/Resources/library/nimble/CppCode -lnimble -L/Library/Frameworks/R.framework/Resources/lib -lRlapack -L/Library/Frameworks/R.framework/Resources/lib -lRblas -F/Library/Frameworks/R.framework/.. -framework R -Wl,-framework -Wl,CoreFoundation
## warning: unknown warning option '-Wno-misleading-indentation'; did you mean '-Wno-missing-declarations'? [-Wunknown-warning-option]
## 1 warning generated.
## warning: unknown warning option '-Wno-misleading-indentation'; did you mean '-Wno-missing-declarations'? [-Wunknown-warning-option]
## 1 warning generated.
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# (3) Configure the MCMC chain}
\NormalTok{bym_usual02_conf <-}\StringTok{ }\KeywordTok{configureMCMC}\NormalTok{(bym_usual02_model, }\DataTypeTok{monitors =} \KeywordTok{c}\NormalTok{(}\StringTok{'beta0'}\NormalTok{, }\StringTok{'beta'}\NormalTok{, }\StringTok{'sigma2'}\NormalTok{, }\StringTok{'s'}\NormalTok{, }\StringTok{'v'}\NormalTok{))}

\CommentTok{# (4) Print samplers}
\NormalTok{bym_usual02_conf}\OperatorTok{$}\KeywordTok{printSamplers}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1]  RW sampler: beta0
## [2]  RW sampler: beta[1]
## [3]  RW sampler: beta[2]
## [4]  RW sampler: beta[3]
## [5]  RW sampler: beta[4]
## [6]  RW sampler: beta[5]
## [7]  RW sampler: beta[6]
## [8]  RW sampler: beta[7]
## [9]  RW sampler: beta[8]
## [10] RW sampler: sigma2
## [11] RW sampler: v[1]
## [12] RW sampler: v[2]
## [13] RW sampler: v[3]
## [14] RW sampler: v[4]
## [15] RW sampler: v[5]
## [16] RW sampler: v[6]
## [17] RW sampler: v[7]
## [18] RW sampler: v[8]
## [19] RW sampler: v[9]
## [20] RW sampler: v[10]
## [21] RW sampler: v[11]
## [22] RW sampler: v[12]
## [23] RW sampler: v[13]
## [24] RW sampler: v[14]
## [25] RW sampler: v[15]
## [26] RW sampler: v[16]
## [27] RW sampler: v[17]
## [28] RW sampler: v[18]
## [29] CAR_normal sampler: s[1:18]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# (5) Build MCMC object}
\NormalTok{bym_usual02_MCMC <-}\StringTok{ }\KeywordTok{buildMCMC}\NormalTok{(bym_usual02_conf, }\DataTypeTok{enableWAIC =}\NormalTok{ T) }

\CommentTok{# (6) Compile model with MCMC object}
\NormalTok{bym_usual02_CMCMC <-}\StringTok{ }\KeywordTok{compileNimble}\NormalTok{(bym_usual02_MCMC, }\DataTypeTok{project =}\NormalTok{ bym_usual02_Cmodel)  }

\CommentTok{# (7) Run the model}
\NormalTok{bym_usual02_runMCMC <-}\StringTok{ }\KeywordTok{runMCMC}\NormalTok{(bym_usual02_CMCMC, }\DataTypeTok{nburnin =} \DecValTok{10000}\NormalTok{, }\DataTypeTok{niter =} \DecValTok{200000}\NormalTok{, }\DataTypeTok{nchains =} \DecValTok{2}\NormalTok{, }\DataTypeTok{thin =} \DecValTok{25}\NormalTok{, }\DataTypeTok{WAIC =}\NormalTok{ T)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## |-------------|-------------|-------------|-------------|
## |-------------------------------------------------------|
## |-------------|-------------|-------------|-------------|
## |-------------------------------------------------------|
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# (8) Check convergence}
\NormalTok{bym_usual02_samples =}\StringTok{ }\KeywordTok{rbind}\NormalTok{(bym_usual02_runMCMC}\OperatorTok{$}\NormalTok{samples[[}\DecValTok{1}\NormalTok{]], bym_usual02_runMCMC}\OperatorTok{$}\NormalTok{samples[[}\DecValTok{2}\NormalTok{]])}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Results ----------------------------------------------------------------------------------------}

\CommentTok{# (9) WAIC ---------------------------------------------------------------------------------------}
\NormalTok{bym_usual02_runMCMC}\OperatorTok{$}\NormalTok{WAIC}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 116.6764
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# (10) Posterior summaries------------------------------------------------------------------------}

\CommentTok{################### betas : covariates}

\CommentTok{# Calculating the Beta means}
\NormalTok{means_betas_bym_usual02 <-}\StringTok{ }\KeywordTok{apply}\NormalTok{(bym_usual02_samples[,}\DecValTok{1}\OperatorTok{:}\DecValTok{8}\NormalTok{],}\DecValTok{2}\NormalTok{, mean)}

\CommentTok{# Calculating the Beta 95% CrI }
\NormalTok{CrI_betas_bym_usual02 <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{apply}\NormalTok{(bym_usual02_samples[ ,}\DecValTok{1}\OperatorTok{:}\DecValTok{8}\NormalTok{],}\DecValTok{2}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(x) }\KeywordTok{quantile}\NormalTok{(x, }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{,}\FloatTok{0.975}\NormalTok{))))}

\CommentTok{# Combining the means and CIs into a dataframe}
\NormalTok{mean_CrI_betas_bym_usual02 <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{matrix}\NormalTok{(}\KeywordTok{c}\NormalTok{(means_betas_bym_usual02, CrI_betas_bym_usual02), }\DataTypeTok{ncol=}\DecValTok{8}\NormalTok{, }\DataTypeTok{byrow=}\NormalTok{T)) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{()}

\CommentTok{# Renaming the columns}
\KeywordTok{colnames}\NormalTok{(mean_CrI_betas_bym_usual02) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Mean"}\NormalTok{, }\StringTok{"95% CrI LL"}\NormalTok{, }\StringTok{"95% CrI UL"}\NormalTok{)}

\CommentTok{# Converting means and CrIs from log to regular scale}
\KeywordTok{exp}\NormalTok{(mean_CrI_betas_bym_usual02)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##           Mean   95% CrI LL   95% CrI UL
## 1 1.188535e+00 6.593505e-01 2.081119e+00
## 2 1.227101e+05 7.392445e-03 2.535186e+16
## 3 1.810138e+04 8.070823e-13 4.016413e+17
## 4 2.361223e-15 1.473669e-32 5.794589e+01
## 5 8.845501e+08 9.603310e-02 2.651971e+17
## 6 1.823012e-25 1.958255e-47 2.099699e-06
## 7 1.064181e+00 8.576701e-01 1.382078e+00
## 8 1.000257e+00 9.994253e-01 1.001152e+00
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{################### S : estimates? per region}

\CommentTok{# Calculating the S means}
\NormalTok{means_s_bym_usual02 <-}\StringTok{ }\KeywordTok{apply}\NormalTok{(bym_usual02_samples[ , }\DecValTok{8}\OperatorTok{:}\DecValTok{25}\NormalTok{],}\DecValTok{2}\NormalTok{, mean)}

\CommentTok{# Calculating the S 95% CrI }
\NormalTok{CrI_s_bym_usual02 <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{apply}\NormalTok{(bym_usual02_samples[ , }\DecValTok{8}\OperatorTok{:}\DecValTok{25}\NormalTok{],}\DecValTok{2}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(x) }\KeywordTok{quantile}\NormalTok{(x, }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{,}\FloatTok{0.975}\NormalTok{))))}

\CommentTok{# Combining the means and CIs into a dataframe}
\NormalTok{mean_CrI_s_bym_usual02 <-}\StringTok{ }\KeywordTok{cbind}\NormalTok{(means_s_bym_usual02, CrI_s_bym_usual02) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{()}

\CommentTok{# Renaming the columns}
\KeywordTok{colnames}\NormalTok{(mean_CrI_s_bym_usual02) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Mean"}\NormalTok{, }\StringTok{"95% CrI LL"}\NormalTok{, }\StringTok{"95% CrI UL"}\NormalTok{)}

\CommentTok{# Converting means and CrIs from log to regular scale}
\KeywordTok{exp}\NormalTok{(mean_CrI_s_bym_usual02)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                 Mean   95% CrI LL   95% CrI UL
## beta[8] 1.000257e+00 9.994253e-01 1.001152e+00
## beta0   6.313935e-05 3.974345e-18 4.293318e+05
## s[1]    2.507154e+00 1.070631e+00 6.348079e+00
## s[2]    1.689653e+00 5.981805e-01 5.130805e+00
## s[3]    1.324496e+00 4.994292e-01 3.591798e+00
## s[4]    6.528562e-01 2.957751e-01 1.410897e+00
## s[5]    8.222138e-01 4.202375e-01 1.627931e+00
## s[6]    1.036266e+00 4.539204e-01 2.431543e+00
## s[7]    1.237289e+00 4.647046e-01 3.460121e+00
## s[8]    7.125792e-01 3.289281e-01 1.560640e+00
## s[9]    1.256091e+00 7.050544e-01 2.369979e+00
## s[10]   4.874679e-01 2.242528e-01 9.756253e-01
## s[11]   4.068731e+00 2.361095e+00 7.216996e+00
## s[12]   8.219581e-01 3.924765e-01 1.680963e+00
## s[13]   4.194588e-01 1.966025e-01 7.860848e-01
## s[14]   6.172282e-01 2.119480e-01 1.591483e+00
## s[15]   2.164939e+00 8.573146e-01 5.832219e+00
## s[16]   7.070474e-01 2.860915e-01 1.690701e+00
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{################### V : estimates? per region}

\CommentTok{# Calculating the V means}
\NormalTok{means_v_bym_usual02 <-}\StringTok{ }\KeywordTok{apply}\NormalTok{(bym_usual02_samples[ ,}\DecValTok{27}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(bym_usual02_samples)],}\DecValTok{2}\NormalTok{, mean)}

\CommentTok{# Calculating the V 95% CrI }
\NormalTok{CrI_v_bym_usual02 <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{apply}\NormalTok{(bym_usual02_samples[ ,}\DecValTok{27}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(bym_usual02_samples)],}\DecValTok{2}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(x) }\KeywordTok{quantile}\NormalTok{(x, }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{,}\FloatTok{0.975}\NormalTok{))))}

\CommentTok{# Combining the means and CIs into a dataframe}
\NormalTok{mean_CrI_v_bym_usual02 <-}\StringTok{ }\KeywordTok{cbind}\NormalTok{(means_v_bym_usual02, CrI_v_bym_usual02) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{()}

\CommentTok{# Renaming the columns}
\KeywordTok{colnames}\NormalTok{(mean_CrI_v_bym_usual02) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Mean"}\NormalTok{, }\StringTok{"95% CrI LL"}\NormalTok{, }\StringTok{"95% CrI UL"}\NormalTok{)}

\CommentTok{# Converting means and CrIs from log to regular scale}
\KeywordTok{exp}\NormalTok{(mean_CrI_v_bym_usual02)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##             Mean 95% CrI LL 95% CrI UL
## s[18]  0.2787359  0.1030178  0.6540489
## sigma2 4.0836280  1.6050723 28.1696203
## v[1]   1.0069406  0.8302855  1.2249000
## v[2]   0.9939155  0.8199649  1.2019633
## v[3]   1.0057537  0.8285414  1.2199209
## v[4]   0.9847750  0.8091130  1.1973796
## v[5]   1.0101957  0.8304154  1.2270083
## v[6]   1.0058396  0.8285708  1.2197925
## v[7]   1.0136579  0.8344199  1.2310705
## v[8]   0.9924153  0.8175931  1.2088527
## v[9]   1.0195865  0.8388222  1.2395840
## v[10]  0.9843306  0.8111499  1.1957001
## v[11]  1.0169510  0.8353815  1.2381784
## v[12]  0.9988570  0.8240308  1.2135121
## v[13]  0.9743634  0.8050143  1.1814899
## v[14]  1.0046552  0.8282485  1.2238679
## v[15]  0.9987043  0.8238046  1.2192058
## v[16]  0.9896053  0.8135153  1.2043459
## v[17]  1.0257684  0.8446298  1.2481462
## v[18]  0.9800573  0.8060215  1.1897770
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{################## beta 0 }

\CommentTok{# Calculating the beta0 mean}
\NormalTok{mean_beta0_bym_usual02 <-}\StringTok{ }\KeywordTok{mean}\NormalTok{(bym_usual02_samples[ ,}\DecValTok{7}\NormalTok{])}

\CommentTok{# Calculating the beta0 95% CrI }
\NormalTok{CrI_beta0_bym_usual02 <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{quantile}\NormalTok{(bym_usual02_samples[ , }\DecValTok{7}\NormalTok{], }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{,}\FloatTok{0.975}\NormalTok{)))}

\CommentTok{# Combining the means and CIs into a dataframe}
\NormalTok{mean_CrI_beta0_bym_usual02 <-}\StringTok{ }\KeywordTok{cbind}\NormalTok{(mean_beta0_bym_usual02, CrI_beta0_bym_usual02) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{()}

\CommentTok{# Renaming the columns}
\KeywordTok{colnames}\NormalTok{(mean_CrI_beta0_bym_usual02) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Mean"}\NormalTok{, }\StringTok{"95% CrI LL"}\NormalTok{, }\StringTok{"95% CrI UL"}\NormalTok{)}

\CommentTok{# Converting means and CrIs from log to regular scale}
\KeywordTok{exp}\NormalTok{(mean_CrI_beta0_bym_usual02)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##       Mean 95% CrI LL 95% CrI UL
## 1 1.064181  0.8576701   1.382078
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# (11) Fitted values  ----------------------------------------------------------------------------}

\CommentTok{# Creating matrix to store fitted values}
\NormalTok{fitted_bym_usual02 =}\StringTok{ }\KeywordTok{matrix}\NormalTok{(}\OtherTok{NA}\NormalTok{, }\DataTypeTok{nrow=}\KeywordTok{nrow}\NormalTok{(bym_usual02_samples), }\DataTypeTok{ncol=} \KeywordTok{nrow}\NormalTok{(data.clean))}

\CommentTok{# Loop to generate fitted values: log(ri)}
\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{nrow}\NormalTok{(data.clean))\{}
\NormalTok{  fitted_bym_usual02[,i] =}\StringTok{ }\NormalTok{bym_usual02_samples[,}\StringTok{"beta0"}\NormalTok{] }\OperatorTok{+}\StringTok{ }\KeywordTok{as.matrix}\NormalTok{(data.clean[i,}\DecValTok{5}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(data.clean)]) }\OperatorTok{%*%}\StringTok{ }\KeywordTok{t}\NormalTok{(bym_usual02_samples [, }\DecValTok{1}\OperatorTok{:}\DecValTok{8}\NormalTok{]) }
  \OperatorTok{+}\StringTok{ }\NormalTok{bym_usual02_samples[ , }\DecValTok{10}\OperatorTok{+}\NormalTok{i}\DecValTok{-1}\NormalTok{] }
  \OperatorTok{+}\StringTok{ }\NormalTok{bym_usual02_samples[ , }\DecValTok{29}\OperatorTok{+}\NormalTok{i}\DecValTok{-1}\NormalTok{]}
\NormalTok{\}}
\CommentTok{# Fitted values - distribution}
\NormalTok{fitted_bym_usual02_dist <-}\StringTok{ }\NormalTok{data.clean}\OperatorTok{$}\NormalTok{Expected }\OperatorTok{*}\StringTok{ }\KeywordTok{exp}\NormalTok{(fitted_bym_usual02)}

\CommentTok{# Mean fitted SIR}
\NormalTok{fitted_SIR_bym_usual02 <-}\StringTok{ }\KeywordTok{exp}\NormalTok{(}\KeywordTok{apply}\NormalTok{(fitted_bym_usual02, }\DecValTok{2}\NormalTok{, mean))}

\CommentTok{# 95% CrI SIR}
\NormalTok{fitted_bym_usual02_CrI_SIR <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{exp}\NormalTok{(}\KeywordTok{apply}\NormalTok{(fitted_bym_usual02, }\DecValTok{2}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(x) }\KeywordTok{quantile}\NormalTok{(x, }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{, }\FloatTok{0.975}\NormalTok{)))))}

\CommentTok{# Mean fitted Cases}
\NormalTok{fitted_bym_usual_}\DecValTok{02}\NormalTok{ <-}\StringTok{ }\NormalTok{fitted_SIR_bym_usual02}\OperatorTok{*}\NormalTok{data.clean}\OperatorTok{$}\NormalTok{Expected}

\CommentTok{# 95% CrI Cases}
\NormalTok{fitted_bym_usual02_CrI <-}\StringTok{  }\NormalTok{data.clean}\OperatorTok{$}\NormalTok{Expected }\OperatorTok{*}\NormalTok{fitted_bym_usual02_CrI_SIR}

\CommentTok{# Creating Dataframe to store fitted values and quantiles in regular svale}
\NormalTok{fitted_bym_usual02_df <-}\StringTok{ }\KeywordTok{data.frame}\NormalTok{(}\StringTok{"Observed SIR"}\NormalTok{   =}\StringTok{  }\KeywordTok{round}\NormalTok{(data.clean}\OperatorTok{$}\NormalTok{SIR, }\DecValTok{2}\NormalTok{), }
                                \StringTok{"Fitted SIR"}\NormalTok{     =}\StringTok{  }\KeywordTok{round}\NormalTok{(fitted_SIR_bym_usual02,}\DecValTok{2}\NormalTok{), }
                                \StringTok{"Observed Cases"}\NormalTok{ =}\StringTok{  }\KeywordTok{round}\NormalTok{(data.clean}\OperatorTok{$}\NormalTok{Cases), }
                                \StringTok{"Fitted Cases"}\NormalTok{ =}\StringTok{  }\KeywordTok{round}\NormalTok{(fitted_bym_usual_}\DecValTok{02}\NormalTok{), }
                                \StringTok{"CrI LL"}\NormalTok{    =}\StringTok{  }\KeywordTok{round}\NormalTok{(fitted_bym_usual02_CrI[,}\DecValTok{1}\NormalTok{]),}
                                \StringTok{"CrI UL"}\NormalTok{    =}\StringTok{  }\KeywordTok{round}\NormalTok{(fitted_bym_usual02_CrI[,}\DecValTok{2}\NormalTok{]))}

\CommentTok{# Top 6 rows}
\KeywordTok{head}\NormalTok{(fitted_bym_usual02_df)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   Observed.SIR Fitted.SIR Observed.Cases Fitted.Cases CrI.LL CrI.UL
## 1         3.09       1.19             42           16      7     37
## 2         1.40       0.83             43           26      8     73
## 3         1.00       0.67              9            6      2     17
## 4         0.60       1.02             14           24     11     48
## 5         0.42       0.45             12           13      7     24
## 6         0.54       0.48             20           18      8     41
\end{verbatim}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/BYM K3 MCMC chains-1} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/BYM K3 MCMC chains-2} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/BYM K3 MCMC chains-3} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/BYM K3 MCMC chains-4} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/BYM K3 Posterior density curves-1} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/BYM K3 Posterior density curves-2} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/BYM K3 Posterior density curves-3} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/BYM K3 Posterior density curves-4} \end{center}

\textbf{Neighborhood structure 3: Distance-based neighbors (k = 5)}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Defining the data that goes into the model ----------------------------------------------------------------}

\CommentTok{# (1) Define constants that go into CAR prior into a list}
\NormalTok{Consts_usual_bym_}\DecValTok{03}\NormalTok{ =}\StringTok{ }\KeywordTok{list}\NormalTok{(}\DataTypeTok{N =} \KeywordTok{nrow}\NormalTok{(data.clean),                }\CommentTok{# Number of areas}
                       \DataTypeTok{p =} \KeywordTok{ncol}\NormalTok{(data.clean[}\DecValTok{5}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(data.clean)]),            }\CommentTok{# Number of covariates}
                       \DataTypeTok{X =} \KeywordTok{as.matrix}\NormalTok{(data.clean[, }\KeywordTok{c}\NormalTok{(}\DecValTok{5}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(data.clean))]),  }\CommentTok{# Matrix of covariates}
                       \DataTypeTok{L =} \KeywordTok{length}\NormalTok{(adj}\FloatTok{.5}\NormalTok{),                       }\CommentTok{# Edges (length of adj vector)}
                       \DataTypeTok{E =}\NormalTok{ data.clean}\OperatorTok{$}\NormalTok{Expected,                 }\CommentTok{# Expected cases}
                       \DataTypeTok{adj =}\NormalTok{ adj}\FloatTok{.5}\NormalTok{,                             }\CommentTok{# Adjacency matrix}
                       \DataTypeTok{num =}\NormalTok{ num.nb}\FloatTok{.5}\NormalTok{,                          }\CommentTok{# Number of neighbors per district}
                       \DataTypeTok{weights =} \KeywordTok{rep}\NormalTok{(}\DecValTok{1}\NormalTok{, }\KeywordTok{length}\NormalTok{(adj}\FloatTok{.5}\NormalTok{)))         }\CommentTok{# Giving weight of 1 for neighbors}

\CommentTok{# (2) Define dependent variable (outcome)}
\NormalTok{outcome <-}\StringTok{ }\KeywordTok{list}\NormalTok{(}\DataTypeTok{y =}\NormalTok{ data.clean}\OperatorTok{$}\NormalTok{Cases) }\CommentTok{# Observed cases}

\CommentTok{# (3) Define initial values for the MCMC chain}
\NormalTok{Inits_usual_bym_}\DecValTok{03}\NormalTok{ <-}\StringTok{ }\KeywordTok{list}\NormalTok{(}\DataTypeTok{beta0 =} \DecValTok{0}\NormalTok{,}
                           \DataTypeTok{beta =} \KeywordTok{rep}\NormalTok{(}\DecValTok{0}\NormalTok{, }\KeywordTok{ncol}\NormalTok{(data.clean[}\DecValTok{5}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(data.clean)])), }
                           \DataTypeTok{sigma2 =} \DecValTok{1}\NormalTok{, }
                           \DataTypeTok{s =} \KeywordTok{rnorm}\NormalTok{(num.nb}\FloatTok{.5}\NormalTok{),}
                           \DataTypeTok{v =}  \KeywordTok{rep}\NormalTok{(}\DecValTok{0}\NormalTok{, }\KeywordTok{nrow}\NormalTok{(data.clean)))}

\CommentTok{# Defining model --------------------------------------------------------------------------------------------}

\CommentTok{# (1) Define the usual fixed prior model for nimble}
\NormalTok{bym_usual03_model <-}\StringTok{ }\KeywordTok{nimbleModel}\NormalTok{(}\DataTypeTok{code =}\NormalTok{ usual_code_bym, }\DataTypeTok{constants =}\NormalTok{ Consts_usual_bym_}\DecValTok{03}\NormalTok{, }
                             \DataTypeTok{data =}\NormalTok{ outcome, }\DataTypeTok{inits =}\NormalTok{ Inits_usual_bym_}\DecValTok{03}\NormalTok{)}

\CommentTok{# (2) Define the compiled nimble model}
\NormalTok{bym_usual03_Cmodel <-}\StringTok{ }\KeywordTok{compileNimble}\NormalTok{(bym_usual03_model, }\DataTypeTok{showCompilerOutput =} \OtherTok{TRUE}\NormalTok{)      }
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## clang++ -std=gnu++11 -I"/Library/Frameworks/R.framework/Resources/include" -DNDEBUG -DR_NO_REMAP   -DEIGEN_MPL2_ONLY=1 -I"/Library/Frameworks/R.framework/Versions/3.6/Resources/library/nimble/include" -Wno-misleading-indentation -Wno-ignored-attributes -Wno-deprecated-declarations  -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk -I/usr/local/include  -fPIC  -Wall -g -O2  -c P_6_usual_code_MID_6.cpp -o P_6_usual_code_MID_6.o
## clang++ -std=gnu++11 -I"/Library/Frameworks/R.framework/Resources/include" -DNDEBUG -DR_NO_REMAP   -DEIGEN_MPL2_ONLY=1 -I"/Library/Frameworks/R.framework/Versions/3.6/Resources/library/nimble/include" -Wno-misleading-indentation -Wno-ignored-attributes -Wno-deprecated-declarations  -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk -I/usr/local/include  -fPIC  -Wall -g -O2  -c P_6_usual_code_MID_6_nfCode.cpp -o P_6_usual_code_MID_6_nfCode.o
## clang++ -std=gnu++11 -dynamiclib -Wl,-headerpad_max_install_names -undefined dynamic_lookup -single_module -multiply_defined suppress -L/Library/Frameworks/R.framework/Resources/lib -L/usr/local/lib -o P_6_usual_code_MID_6_04_24_03_45_09.so P_6_usual_code_MID_6.o P_6_usual_code_MID_6_nfCode.o -L/Library/Frameworks/R.framework/Versions/3.6/Resources/library/nimble/CppCode -lnimble -L/Library/Frameworks/R.framework/Resources/lib -lRlapack -L/Library/Frameworks/R.framework/Resources/lib -lRblas -F/Library/Frameworks/R.framework/.. -framework R -Wl,-framework -Wl,CoreFoundation
## warning: unknown warning option '-Wno-misleading-indentation'; did you mean '-Wno-missing-declarations'? [-Wunknown-warning-option]
## 1 warning generated.
## warning: unknown warning option '-Wno-misleading-indentation'; did you mean '-Wno-missing-declarations'? [-Wunknown-warning-option]
## 1 warning generated.
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# (3) Configure the MCMC chain}
\NormalTok{bym_usual03_conf <-}\StringTok{ }\KeywordTok{configureMCMC}\NormalTok{(bym_usual03_model, }\DataTypeTok{monitors =} \KeywordTok{c}\NormalTok{(}\StringTok{'beta0'}\NormalTok{, }\StringTok{'beta'}\NormalTok{, }\StringTok{'sigma2'}\NormalTok{, }\StringTok{'s'}\NormalTok{, }\StringTok{'v'}\NormalTok{))}

\CommentTok{# (4) Print samplers}
\NormalTok{bym_usual03_conf}\OperatorTok{$}\KeywordTok{printSamplers}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1]  RW sampler: beta0
## [2]  RW sampler: beta[1]
## [3]  RW sampler: beta[2]
## [4]  RW sampler: beta[3]
## [5]  RW sampler: beta[4]
## [6]  RW sampler: beta[5]
## [7]  RW sampler: beta[6]
## [8]  RW sampler: beta[7]
## [9]  RW sampler: beta[8]
## [10] RW sampler: sigma2
## [11] RW sampler: v[1]
## [12] RW sampler: v[2]
## [13] RW sampler: v[3]
## [14] RW sampler: v[4]
## [15] RW sampler: v[5]
## [16] RW sampler: v[6]
## [17] RW sampler: v[7]
## [18] RW sampler: v[8]
## [19] RW sampler: v[9]
## [20] RW sampler: v[10]
## [21] RW sampler: v[11]
## [22] RW sampler: v[12]
## [23] RW sampler: v[13]
## [24] RW sampler: v[14]
## [25] RW sampler: v[15]
## [26] RW sampler: v[16]
## [27] RW sampler: v[17]
## [28] RW sampler: v[18]
## [29] CAR_normal sampler: s[1:18]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# (5) Build MCMC object}
\NormalTok{bym_usual03_MCMC <-}\StringTok{ }\KeywordTok{buildMCMC}\NormalTok{(bym_usual03_conf, }\DataTypeTok{enableWAIC =}\NormalTok{ T) }

\CommentTok{# (6) Compile model with MCMC object}
\NormalTok{bym_usual03_CMCMC <-}\StringTok{ }\KeywordTok{compileNimble}\NormalTok{(bym_usual03_MCMC, }\DataTypeTok{project =}\NormalTok{ bym_usual03_Cmodel)  }

\CommentTok{# (7) Run the model}
\NormalTok{bym_usual03_runMCMC <-}\StringTok{ }\KeywordTok{runMCMC}\NormalTok{(bym_usual03_CMCMC, }\DataTypeTok{nburnin =} \DecValTok{10000}\NormalTok{, }\DataTypeTok{niter =} \DecValTok{200000}\NormalTok{, }\DataTypeTok{nchains =} \DecValTok{2}\NormalTok{, }\DataTypeTok{thin =} \DecValTok{25}\NormalTok{, }\DataTypeTok{WAIC =}\NormalTok{ T)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## |-------------|-------------|-------------|-------------|
## |-------------------------------------------------------|
## |-------------|-------------|-------------|-------------|
## |-------------------------------------------------------|
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# (8) Check convergence}
\NormalTok{bym_usual03_samples =}\StringTok{ }\KeywordTok{rbind}\NormalTok{(bym_usual03_runMCMC}\OperatorTok{$}\NormalTok{samples[[}\DecValTok{1}\NormalTok{]], bym_usual03_runMCMC}\OperatorTok{$}\NormalTok{samples[[}\DecValTok{2}\NormalTok{]])}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Results ----------------------------------------------------------------------------------------}

\CommentTok{# (9) WAIC ---------------------------------------------------------------------------------------}
\NormalTok{bym_usual03_runMCMC}\OperatorTok{$}\NormalTok{WAIC}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 117.9149
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# (10) Posterior summaries------------------------------------------------------------------------}

\CommentTok{################### betas : covariates}

\CommentTok{# Calculating the Beta means}
\NormalTok{means_betas_bym_usual03 <-}\StringTok{ }\KeywordTok{apply}\NormalTok{(bym_usual03_samples[,}\DecValTok{1}\OperatorTok{:}\DecValTok{8}\NormalTok{],}\DecValTok{2}\NormalTok{, mean)}

\CommentTok{# Calculating the Beta 95% CrI }
\NormalTok{CrI_betas_bym_usual03 <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{apply}\NormalTok{(bym_usual03_samples[ ,}\DecValTok{1}\OperatorTok{:}\DecValTok{8}\NormalTok{],}\DecValTok{2}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(x) }\KeywordTok{quantile}\NormalTok{(x, }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{,}\FloatTok{0.975}\NormalTok{))))}

\CommentTok{# Combining the means and CIs into a dataframe}
\NormalTok{mean_CrI_betas_bym_usual03 <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{matrix}\NormalTok{(}\KeywordTok{c}\NormalTok{(means_betas_bym_usual03, CrI_betas_bym_usual03), }\DataTypeTok{ncol=}\DecValTok{8}\NormalTok{, }\DataTypeTok{byrow=}\NormalTok{T)) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{()}

\CommentTok{# Renaming the columns}
\KeywordTok{colnames}\NormalTok{(mean_CrI_betas_bym_usual03) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Mean"}\NormalTok{, }\StringTok{"95% CrI LL"}\NormalTok{, }\StringTok{"95% CrI UL"}\NormalTok{)}

\CommentTok{# Converting means and CrIs from log to regular scale}
\KeywordTok{exp}\NormalTok{(mean_CrI_betas_bym_usual03)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##           Mean   95% CrI LL   95% CrI UL
## 1 1.053589e+00 6.142949e-01 1.735289e+00
## 2 4.797720e+08 9.778312e-05 3.155463e+18
## 3 6.323326e+01 1.220087e-08 7.253850e+10
## 4 8.526510e-12 8.666577e-34 4.477392e+04
## 5 3.839529e-01 6.876669e-12 1.055238e+08
## 6 3.849367e-16 1.657224e-40 1.780823e+14
## 7 1.002847e+00 7.902166e-01 1.189898e+00
## 8 1.000240e+00 9.993051e-01 1.001149e+00
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{################### S : estimates? per region}

\CommentTok{# Calculating the S means}
\NormalTok{means_s_bym_usual03 <-}\StringTok{ }\KeywordTok{apply}\NormalTok{(bym_usual03_samples[ , }\DecValTok{8}\OperatorTok{:}\DecValTok{25}\NormalTok{],}\DecValTok{2}\NormalTok{, mean)}

\CommentTok{# Calculating the Beta 95% CrI }
\NormalTok{CrI_s_bym_usual03 <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{apply}\NormalTok{(bym_usual03_samples[ , }\DecValTok{8}\OperatorTok{:}\DecValTok{25}\NormalTok{],}\DecValTok{2}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(x) }\KeywordTok{quantile}\NormalTok{(x, }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{,}\FloatTok{0.975}\NormalTok{))))}

\CommentTok{# Combining the means and CIs into a dataframe}
\NormalTok{mean_CrI_s_bym_usual03 <-}\StringTok{ }\KeywordTok{cbind}\NormalTok{(means_s_bym_usual03, CrI_s_bym_usual03) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{()}

\CommentTok{# Renaming the columns}
\KeywordTok{colnames}\NormalTok{(mean_CrI_s_bym_usual03) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Mean"}\NormalTok{, }\StringTok{"95% CrI LL"}\NormalTok{, }\StringTok{"95% CrI UL"}\NormalTok{)}

\CommentTok{# Converting means and CrIs from log to regular scale}
\KeywordTok{exp}\NormalTok{(mean_CrI_s_bym_usual03)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##              Mean   95% CrI LL   95% CrI UL
## beta[8] 1.0002396 9.993051e-01 1.001149e+00
## beta0   0.1728240 1.893371e-11 7.363593e+09
## s[1]    1.5672360 6.456941e-01 4.330710e+00
## s[2]    1.4148014 3.966313e-01 4.750613e+00
## s[3]    1.1296294 4.687595e-01 2.754467e+00
## s[4]    0.7869344 3.742018e-01 1.638487e+00
## s[5]    0.8146305 4.016819e-01 1.557453e+00
## s[6]    1.3129972 5.874557e-01 2.979704e+00
## s[7]    1.4706259 4.999680e-01 4.183666e+00
## s[8]    0.5374988 2.596279e-01 1.048884e+00
## s[9]    1.1221094 5.673841e-01 2.090799e+00
## s[10]   0.6682051 3.324978e-01 1.331677e+00
## s[11]   3.0038405 1.790002e+00 5.135537e+00
## s[12]   0.9516246 4.523842e-01 1.927726e+00
## s[13]   0.4400390 2.057059e-01 8.675179e-01
## s[14]   0.7669440 2.842358e-01 2.138008e+00
## s[15]   1.9650636 6.870918e-01 6.344298e+00
## s[16]   0.6411561 2.232167e-01 1.563008e+00
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{################### V : estimates? per region}

\CommentTok{# Calculating the V means}
\NormalTok{means_v_bym_usual03 <-}\StringTok{ }\KeywordTok{apply}\NormalTok{(bym_usual03_samples[ , }\DecValTok{27}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(bym_usual03_samples)],}\DecValTok{2}\NormalTok{, mean)}

\CommentTok{# Calculating the V 95% CrI }
\NormalTok{CrI_v_bym_usual03 <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{apply}\NormalTok{(bym_usual03_samples[ , }\DecValTok{27}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(bym_usual03_samples)],}\DecValTok{2}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(x) }\KeywordTok{quantile}\NormalTok{(x, }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{,}\FloatTok{0.975}\NormalTok{))))}

\CommentTok{# Combining the means and CIs into a dataframe}
\NormalTok{mean_CrI_v_bym_usual03 <-}\StringTok{ }\KeywordTok{cbind}\NormalTok{(means_v_bym_usual03, CrI_v_bym_usual03) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{()}

\CommentTok{# Renaming the columns}
\KeywordTok{colnames}\NormalTok{(mean_CrI_v_bym_usual03) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Mean"}\NormalTok{, }\StringTok{"95% CrI LL"}\NormalTok{, }\StringTok{"95% CrI UL"}\NormalTok{)}

\CommentTok{# Converting means and CrIs from log to regular scale}
\KeywordTok{exp}\NormalTok{(mean_CrI_v_bym_usual03)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##              Mean 95% CrI LL  95% CrI UL
## s[18]   0.3239647  0.1124011   0.7846353
## sigma2 15.8019214  2.4547903 790.0717305
## v[1]    1.0035874  0.8244147   1.2197674
## v[2]    0.9969286  0.8202165   1.2116079
## v[3]    1.0094764  0.8318866   1.2262084
## v[4]    0.9873654  0.8132656   1.2006698
## v[5]    0.9998774  0.8245333   1.2176812
## v[6]    1.0021718  0.8256093   1.2153458
## v[7]    1.0184974  0.8375525   1.2401700
## v[8]    0.9893455  0.8154845   1.2051793
## v[9]    1.0054391  0.8277852   1.2221494
## v[10]   0.9894709  0.8144206   1.2010951
## v[11]   1.0144089  0.8362920   1.2327688
## v[12]   1.0116221  0.8349106   1.2270326
## v[13]   0.9717108  0.7985008   1.1804924
## v[14]   1.0043286  0.8266861   1.2181460
## v[15]   1.0045052  0.8291663   1.2204307
## v[16]   0.9887369  0.8142758   1.2029136
## v[17]   1.0278571  0.8468329   1.2504658
## v[18]   0.9788040  0.8048293   1.1885110
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{################## beta 0 }

\CommentTok{# Calculating beta0 means}
\NormalTok{mean_beta0_bym_usual03 <-}\StringTok{ }\KeywordTok{mean}\NormalTok{(bym_usual03_samples[ ,}\DecValTok{7}\NormalTok{])}

\CommentTok{# Calculating the beta0 95% CrI }
\NormalTok{CrI_beta0_bym_usual03 <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{quantile}\NormalTok{(bym_usual03_samples[ , }\DecValTok{7}\NormalTok{], }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{,}\FloatTok{0.975}\NormalTok{)))}

\CommentTok{# Combining the means and CIs into a dataframe}
\NormalTok{mean_CrI_beta0_bym_usual03 <-}\StringTok{ }\KeywordTok{cbind}\NormalTok{(mean_beta0_bym_usual03, CrI_beta0_bym_usual03) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{()}

\CommentTok{# Renaming the columns}
\KeywordTok{colnames}\NormalTok{(mean_CrI_beta0_bym_usual03) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Mean"}\NormalTok{, }\StringTok{"95% CrI LL"}\NormalTok{, }\StringTok{"95% CrI UL"}\NormalTok{)}

\CommentTok{# Converting means and CrIs from log to regular scale}
\KeywordTok{exp}\NormalTok{(mean_CrI_beta0_bym_usual03)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##       Mean 95% CrI LL 95% CrI UL
## 1 1.002847  0.7902166   1.189898
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# (11) Fitted values  ----------------------------------------------------------------------------}

\CommentTok{# Creating matrix to store fitted values}
\NormalTok{fitted_bym_usual03 =}\StringTok{ }\KeywordTok{matrix}\NormalTok{(}\OtherTok{NA}\NormalTok{, }\DataTypeTok{nrow=}\KeywordTok{nrow}\NormalTok{(bym_usual03_samples), }\DataTypeTok{ncol=} \KeywordTok{nrow}\NormalTok{(data.clean))}

\CommentTok{# Loop to generate fitted values: log(ri)}
\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{nrow}\NormalTok{(data.clean))\{}
\NormalTok{  fitted_bym_usual03[,i] =}\StringTok{ }\NormalTok{bym_usual03_samples[,}\StringTok{"beta0"}\NormalTok{] }\OperatorTok{+}\StringTok{ }\KeywordTok{as.matrix}\NormalTok{(data.clean[i,}\DecValTok{5}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(data.clean)]) }\OperatorTok{%*%}\StringTok{ }
\StringTok{    }\KeywordTok{t}\NormalTok{(bym_usual03_samples[,}\DecValTok{1}\OperatorTok{:}\DecValTok{8}\NormalTok{])}
  \OperatorTok{+}\StringTok{ }\NormalTok{bym_usual03_samples[, }\DecValTok{10}\OperatorTok{+}\NormalTok{i}\DecValTok{-1}\NormalTok{] }
  \OperatorTok{+}\StringTok{ }\NormalTok{bym_usual03_samples[ , }\DecValTok{29}\OperatorTok{+}\NormalTok{i}\DecValTok{-1}\NormalTok{]}
\NormalTok{\}}

\CommentTok{# Mean fitted SIR}
\NormalTok{fitted_SIR_bym_usual03 <-}\StringTok{ }\KeywordTok{exp}\NormalTok{(}\KeywordTok{apply}\NormalTok{(fitted_bym_usual03, }\DecValTok{2}\NormalTok{, mean))}

\CommentTok{# 95% CrI SIR}
\NormalTok{fitted_bym_usual03_CrI_SIR <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{exp}\NormalTok{(}\KeywordTok{apply}\NormalTok{(fitted_bym_usual03, }\DecValTok{2}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(x) }\KeywordTok{quantile}\NormalTok{(x, }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{, }\FloatTok{0.975}\NormalTok{)))))}

\CommentTok{# Mean fitted Cases}
\NormalTok{fitted_bym_usual_}\DecValTok{03}\NormalTok{ <-}\StringTok{ }\NormalTok{fitted_SIR_bym_usual03}\OperatorTok{*}\NormalTok{data.clean}\OperatorTok{$}\NormalTok{Expected}

\CommentTok{# 95% CrI Cases}
\NormalTok{fitted_bym_usual03_CrI <-}\StringTok{  }\NormalTok{data.clean}\OperatorTok{$}\NormalTok{Expected }\OperatorTok{*}\NormalTok{fitted_bym_usual03_CrI_SIR}

\CommentTok{# Creating Dataframe to store fitted values and quantiles in regular svale}
\NormalTok{fitted_bym_usual03_df <-}\StringTok{ }\KeywordTok{data.frame}\NormalTok{(}\StringTok{"Observed SIR"}\NormalTok{   =}\StringTok{  }\KeywordTok{round}\NormalTok{(data.clean}\OperatorTok{$}\NormalTok{SIR, }\DecValTok{2}\NormalTok{), }
                                \StringTok{"Fitted SIR"}\NormalTok{     =}\StringTok{  }\KeywordTok{round}\NormalTok{(fitted_SIR_bym_usual03,}\DecValTok{2}\NormalTok{), }
                                \StringTok{"Observed Cases"}\NormalTok{ =}\StringTok{  }\KeywordTok{round}\NormalTok{(data.clean}\OperatorTok{$}\NormalTok{Cases), }
                                \StringTok{"Fitted Cases"}\NormalTok{ =}\StringTok{  }\KeywordTok{round}\NormalTok{(fitted_bym_usual_}\DecValTok{03}\NormalTok{), }
                                \StringTok{"CrI LL"}\NormalTok{    =}\StringTok{  }\KeywordTok{round}\NormalTok{(fitted_bym_usual03_CrI[,}\DecValTok{1}\NormalTok{]),}
                                \StringTok{"CrI UL"}\NormalTok{    =}\StringTok{  }\KeywordTok{round}\NormalTok{(fitted_bym_usual03_CrI[,}\DecValTok{2}\NormalTok{]))}

\CommentTok{# Top 6 rows}
\KeywordTok{head}\NormalTok{(fitted_bym_usual03_df)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   Observed.SIR Fitted.SIR Observed.Cases Fitted.Cases CrI.LL CrI.UL
## 1         3.09       1.93             42           26     10     62
## 2         1.40       0.99             43           30      9    109
## 3         1.00       0.76              9            7      3     16
## 4         0.60       0.82             14           19      9     40
## 5         0.42       0.49             12           14      8     27
## 6         0.54       0.39             20           15      7     33
\end{verbatim}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/BYM K5 MCMC chains-1} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/BYM K5 MCMC chains-2} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/BYM K5 MCMC chains-3} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/BYM K5 MCMC chains-4} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/BYM K5 Posterior density curves-1} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/BYM K5 Posterior density curves-2} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/BYM K5 Posterior density curves-3} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/BYM K5 Posterior density curves-4} \end{center}

\hypertarget{ridge-regression-car}{%
\subsection{Ridge Regression: CAR}\label{ridge-regression-car}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{#########################################}
\CommentTok{#    Usual fixed priors model - RIDGE     # }
\CommentTok{#########################################}

\CommentTok{# Defining the usual fixed priors model ------------------------------------------------------}
\NormalTok{ridge_code <-}\StringTok{ }\KeywordTok{nimbleCode}\NormalTok{(\{ }
  
  \CommentTok{# Defining our priors}
\NormalTok{  beta0 }\OperatorTok{~}\StringTok{ }\KeywordTok{dnorm}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DataTypeTok{sd =} \DecValTok{200}\NormalTok{)}
  
  \ControlFlowTok{for}\NormalTok{(j }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\NormalTok{p)\{}
\NormalTok{    beta[j] }\OperatorTok{~}\StringTok{ }\KeywordTok{dnorm}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DataTypeTok{sd=}\DecValTok{1}\OperatorTok{*}\KeywordTok{sqrt}\NormalTok{(}\DecValTok{1}\OperatorTok{/}\NormalTok{lambda))  }\CommentTok{# Betas for the covariates}
\NormalTok{  \}}
  
  \CommentTok{# Half-Cauchy priors for conditional std-dev & tuning param (lambda)}
  \CommentTok{#nu ~ T(dt(0, 1, 1),0,) }
\NormalTok{  sigma }\OperatorTok{~}\StringTok{ }\KeywordTok{T}\NormalTok{(}\KeywordTok{dt}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{),}\DecValTok{0}\NormalTok{,) }
\NormalTok{  lambda }\OperatorTok{~}\StringTok{ }\KeywordTok{T}\NormalTok{(}\KeywordTok{dt}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{),}\DecValTok{0}\NormalTok{,)}

  \CommentTok{# Defining transformed parameters}
\NormalTok{  tau2 <-}\StringTok{ }\DecValTok{1} \OperatorTok{/}\NormalTok{(sigma}\OperatorTok{^}\DecValTok{2}\NormalTok{)}
  
  \CommentTok{# CAR prior}
\NormalTok{  s[}\DecValTok{1}\OperatorTok{:}\NormalTok{N] }\OperatorTok{~}\StringTok{ }\KeywordTok{dcar_normal}\NormalTok{(adj[}\DecValTok{1}\OperatorTok{:}\NormalTok{L], weights[}\DecValTok{1}\OperatorTok{:}\NormalTok{L], num[}\DecValTok{1}\OperatorTok{:}\NormalTok{N], tau2, }\DataTypeTok{zero_mean =} \DecValTok{1}\NormalTok{)}
  
  \CommentTok{# Defining likelihood}
  \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\NormalTok{N) \{ }
    \KeywordTok{log}\NormalTok{(r[i]) <-}\StringTok{ }\NormalTok{beta0 }\OperatorTok{+}\StringTok{ }\KeywordTok{inprod}\NormalTok{(X[i, }\DecValTok{1}\OperatorTok{:}\NormalTok{p], beta[}\DecValTok{1}\OperatorTok{:}\NormalTok{p]) }\OperatorTok{+}\StringTok{ }\KeywordTok{log}\NormalTok{(E[i]) }\OperatorTok{+}\StringTok{ }\NormalTok{s[i]}
\NormalTok{    mu[i] <-}\StringTok{ }\NormalTok{E[i]}\OperatorTok{*}\NormalTok{r[i]}
\NormalTok{    y[i] }\OperatorTok{~}\StringTok{ }\KeywordTok{dpois}\NormalTok{(mu[i])}
\NormalTok{  \}}
\NormalTok{\})}
\end{Highlighting}
\end{Shaded}

\textbf{Ridge : Neighborhood structure 1: Adjacent Neighbors}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Model -> Compile model -> build MCMC object -> Compile MCMC object -> run MCMC}

\CommentTok{# Constants and initial values -------------------------------------------------------------------}

\CommentTok{# (1) Define constants that go into CAR prior into a list}
\NormalTok{Consts_ridge_}\DecValTok{01}\NormalTok{ =}\StringTok{ }\KeywordTok{list}\NormalTok{(}\DataTypeTok{N =} \KeywordTok{nrow}\NormalTok{(data.clean),                              }\CommentTok{# Number of areas}
                     \DataTypeTok{p =} \KeywordTok{ncol}\NormalTok{(data.clean[}\DecValTok{5}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(data.clean)]),            }\CommentTok{# Number of covariates}
                     \DataTypeTok{X =} \KeywordTok{as.matrix}\NormalTok{(data.clean[, }\KeywordTok{c}\NormalTok{(}\DecValTok{5}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(data.clean))]),  }\CommentTok{# Matrix of covariates}
                     \DataTypeTok{L =} \KeywordTok{length}\NormalTok{(adj),                       }\CommentTok{# Edges (length of adj vector)}
                     \DataTypeTok{E =}\NormalTok{ data.clean}\OperatorTok{$}\NormalTok{Expected,}
                     \DataTypeTok{adj =}\NormalTok{ adj,                             }\CommentTok{# Adjacency matrix}
                     \DataTypeTok{num =}\NormalTok{ num.nb,                          }\CommentTok{# Number of neighbors per district}
                     \DataTypeTok{weights =} \KeywordTok{rep}\NormalTok{(}\DecValTok{1}\NormalTok{, }\KeywordTok{length}\NormalTok{(adj)))         }\CommentTok{# Giving weight of 1 for neighbors}

\CommentTok{# (2) Define dependent variable (outcome)}
\NormalTok{outcome <-}\StringTok{ }\KeywordTok{list}\NormalTok{(}\DataTypeTok{y =}\NormalTok{ data.clean}\OperatorTok{$}\NormalTok{Cases) }\CommentTok{# Observed cases}

\CommentTok{# (3) Define initial values for the MCMC chain}
\NormalTok{Inits_ridge <-}\StringTok{ }\KeywordTok{list}\NormalTok{(}\DataTypeTok{beta0=}\DecValTok{0}\NormalTok{, }\DataTypeTok{beta=}\KeywordTok{rep}\NormalTok{(}\DecValTok{0}\NormalTok{, }\KeywordTok{ncol}\NormalTok{(data.clean[}\DecValTok{5}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(data.clean)])),}
                    \DataTypeTok{sigma=}\DecValTok{2}\NormalTok{, }\DataTypeTok{lambda=}\DecValTok{1}\NormalTok{, }\DataTypeTok{s=}\KeywordTok{rnorm}\NormalTok{(}\KeywordTok{nrow}\NormalTok{(data.clean)))}

\CommentTok{# Defining model -----------------------------------------------------------------------------}
\CommentTok{# (1) Define ridge nimble model}
\NormalTok{ridge01_model =}\StringTok{ }\KeywordTok{nimbleModel}\NormalTok{(}\DataTypeTok{code=}\NormalTok{ridge_code, }\DataTypeTok{constants=}\NormalTok{Consts_ridge_}\DecValTok{01}\NormalTok{, }\DataTypeTok{data=}\NormalTok{outcome,}
                            \DataTypeTok{inits=}\NormalTok{Inits_ridge)}

\CommentTok{# (2) Compile ridge model for nimble}
\NormalTok{ridge01_Cmodel=}\KeywordTok{compileNimble}\NormalTok{(ridge01_model)}

\CommentTok{# (3) Configure the MCMC chain}
\NormalTok{ridge01_conf <-}\StringTok{ }\KeywordTok{configureMCMC}\NormalTok{(ridge01_model, }
                              \DataTypeTok{monitors =} \KeywordTok{c}\NormalTok{(}\StringTok{'beta0'}\NormalTok{,}\StringTok{"beta"}\NormalTok{, }\StringTok{'sigma'}\NormalTok{, }\StringTok{"lambda"}\NormalTok{, }\StringTok{'s'}\NormalTok{))}
\CommentTok{# (4) Do something}
\NormalTok{ridge01_conf}\OperatorTok{$}\KeywordTok{printSamplers}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1]  RW sampler: beta0
## [2]  RW sampler: sigma
## [3]  RW sampler: lambda
## [4]  RW sampler: beta[1]
## [5]  RW sampler: beta[2]
## [6]  RW sampler: beta[3]
## [7]  RW sampler: beta[4]
## [8]  RW sampler: beta[5]
## [9]  RW sampler: beta[6]
## [10] RW sampler: beta[7]
## [11] RW sampler: beta[8]
## [12] CAR_normal sampler: s[1:18]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# (5) Build MCMC object}
\NormalTok{ridge01_MCMC=}\KeywordTok{buildMCMC}\NormalTok{(ridge01_conf, }\DataTypeTok{enableWAIC=}\NormalTok{T)}

\CommentTok{# (6) Compile model with MCMC object}
\NormalTok{ridge01_CMCMC=}\KeywordTok{compileNimble}\NormalTok{(ridge01_MCMC, }\DataTypeTok{project=}\NormalTok{ridge01_Cmodel)}

\CommentTok{# (7) Run the model}
\NormalTok{ridge01_runMCMC=}\KeywordTok{runMCMC}\NormalTok{(ridge01_CMCMC, }\DataTypeTok{nburnin=}\DecValTok{10000}\NormalTok{, }\DataTypeTok{niter=}\DecValTok{500000}\NormalTok{, }\DataTypeTok{nchains=}\DecValTok{2}\NormalTok{, }\DataTypeTok{thin=}\DecValTok{25}\NormalTok{, }\DataTypeTok{WAIC=}\NormalTok{T)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## |-------------|-------------|-------------|-------------|
## |-------------------------------------------------------|
## |-------------|-------------|-------------|-------------|
## |-------------------------------------------------------|
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# (8) Check convergence}
\NormalTok{ridge01_samples=}\KeywordTok{rbind}\NormalTok{(ridge01_runMCMC}\OperatorTok{$}\NormalTok{samples[[}\DecValTok{1}\NormalTok{]], ridge01_runMCMC}\OperatorTok{$}\NormalTok{samples[[}\DecValTok{2}\NormalTok{]])}

\CommentTok{# (9) WAIC}
\NormalTok{ridge01_runMCMC}\OperatorTok{$}\NormalTok{WAIC}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 117.1115
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# (10) Posterior summaries: Means and CrI  --------------------------------------------------------}

\CommentTok{#Calculating the Beta means (beta0 included, last variable)}
\NormalTok{means_betas_ridge01 <-}\StringTok{ }\KeywordTok{apply}\NormalTok{(ridge01_samples[,}\DecValTok{1}\OperatorTok{:}\DecValTok{9}\NormalTok{],}\DecValTok{2}\NormalTok{, mean)}

\CommentTok{#Calculating the Beta 95% CrI }
\NormalTok{CrI_betas_ridge01 <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{apply}\NormalTok{(ridge01_samples[ ,}\DecValTok{1}\OperatorTok{:}\DecValTok{9}\NormalTok{],}\DecValTok{2}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(x) }\KeywordTok{quantile}\NormalTok{(x, }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{,}\FloatTok{0.975}\NormalTok{))))}

\CommentTok{#Combining the means and CIs into a dataframe}
\NormalTok{mean_CrI_betas_ridge01 <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{matrix}\NormalTok{(}\KeywordTok{c}\NormalTok{(means_betas_ridge01, CrI_betas_ridge01), }\DataTypeTok{ncol=}\DecValTok{9}\NormalTok{, }\DataTypeTok{nrow =} \DecValTok{3}\NormalTok{, }\DataTypeTok{byrow=}\NormalTok{T)) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{()}

\CommentTok{#Renaming the columns}
\KeywordTok{colnames}\NormalTok{(mean_CrI_betas_ridge01) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Mean"}\NormalTok{, }\StringTok{"95% CrI LL"}\NormalTok{, }\StringTok{"95% CrI UL"}\NormalTok{)}

\CommentTok{# Converting means and CrIs from log to regular scale}
\KeywordTok{exp}\NormalTok{(mean_CrI_betas_ridge01)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##        Mean 95% CrI LL 95% CrI UL
## 1 1.0555071 0.57928951   2.075983
## 2 1.0303408 0.31652990   3.811961
## 3 1.0391085 0.33217064   3.787287
## 4 0.9948399 0.30114105   3.217390
## 5 1.0051623 0.30848253   3.244182
## 6 0.9922122 0.32132615   2.963442
## 7 0.8923630 0.73502150   1.085386
## 8 1.0001405 0.99867313   1.001689
## 9 0.3015853 0.00579721  15.953394
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{################### Spatial effect per region}

\CommentTok{#Calculating the S means}
\NormalTok{means_s_ridge01 <-}\StringTok{ }\KeywordTok{apply}\NormalTok{(ridge01_samples[ ,}\DecValTok{11}\OperatorTok{:}\DecValTok{28}\NormalTok{],}\DecValTok{2}\NormalTok{, mean)}

\CommentTok{#Calculating the Beta 95% CrI }
\NormalTok{CrI_s_ridge01 <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{apply}\NormalTok{(ridge01_samples[ ,}\DecValTok{11}\OperatorTok{:}\DecValTok{28}\NormalTok{],}\DecValTok{2}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(x) }\KeywordTok{quantile}\NormalTok{(x, }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{,}\FloatTok{0.975}\NormalTok{))))}

\CommentTok{#Combining the means and CIs into a dataframe}
\NormalTok{mean_CrI_s_ridge01 <-}\StringTok{ }\KeywordTok{cbind}\NormalTok{(means_s_ridge01, CrI_s_ridge01) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{()}

\CommentTok{#Renaming the columns}
\KeywordTok{colnames}\NormalTok{(mean_CrI_s_ridge01) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Mean"}\NormalTok{, }\StringTok{"95% CrI LL"}\NormalTok{, }\StringTok{"95% CrI UL"}\NormalTok{)}

\CommentTok{# Converting means and CrIs from log to regular scale}
\KeywordTok{exp}\NormalTok{(mean_CrI_s_ridge01)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##            Mean 95% CrI LL 95% CrI UL
## s[1]  3.4748051 1.03243104 11.9356629
## s[2]  0.7516746 0.12997007  3.8157134
## s[3]  3.0091400 0.90754161 10.3536254
## s[4]  0.6268497 0.26389659  1.3714409
## s[5]  0.5196889 0.19734469  1.3363935
## s[6]  0.6893649 0.18593204  2.6535324
## s[7]  1.3178103 0.36261936  5.6169727
## s[8]  0.3486138 0.13633161  0.8702232
## s[9]  0.4415960 0.25944662  0.7578531
## s[10] 0.7453507 0.29475663  1.8485430
## s[11] 4.4381315 2.25561512  8.9565712
## s[12] 0.9914308 0.48649295  1.9917751
## s[13] 0.5603478 0.25904081  1.1479075
## s[14] 0.9174307 0.33789046  2.6468059
## s[15] 7.1897186 2.45726247 21.5243277
## s[16] 0.3298592 0.08780115  1.2213972
## s[17] 4.0261837 1.45062621 10.4350667
## s[18] 0.1734724 0.05721937  0.4822617
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{################### Sigma}

\CommentTok{#Calculating the sigma means}
\NormalTok{means_sigma_ridge01 <-}\StringTok{ }\KeywordTok{mean}\NormalTok{(ridge01_samples[ ,}\DecValTok{29}\NormalTok{])}

\CommentTok{#Calculating the Beta 95% CrI }
\NormalTok{CrI_sigma_ridge01 <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{quantile}\NormalTok{(ridge01_samples[ ,}\DecValTok{29}\NormalTok{], }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{,}\FloatTok{0.975}\NormalTok{)))}

\CommentTok{#Combining the means and CIs into a dataframe}
\NormalTok{mean_CrI_sigma_ridge01 <-}\StringTok{ }\KeywordTok{cbind}\NormalTok{(means_sigma_ridge01, CrI_sigma_ridge01) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{()}

\CommentTok{#Renaming the columns}
\KeywordTok{colnames}\NormalTok{(mean_CrI_sigma_ridge01) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Mean"}\NormalTok{, }\StringTok{"95% CrI LL"}\NormalTok{, }\StringTok{"95% CrI UL"}\NormalTok{)}

\CommentTok{# Consigmaerting means and CrIs from log to regular scale}
\KeywordTok{exp}\NormalTok{(mean_CrI_sigma_ridge01)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##       Mean 95% CrI LL 95% CrI UL
## 1 5.667756    3.05095   15.32311
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{################## Lambda}

\NormalTok{mean_beta0_ridge01 <-}\StringTok{ }\KeywordTok{mean}\NormalTok{(ridge01_samples[ ,}\StringTok{"lambda"}\NormalTok{])}

\CommentTok{#Calculating the Beta 95% CrI }
\NormalTok{CrI_beta0_ridge01 <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{quantile}\NormalTok{(ridge01_samples[ , }\StringTok{"lambda"}\NormalTok{], }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{,}\FloatTok{0.975}\NormalTok{)))}

\CommentTok{#Combining the means and CIs into a dataframe}
\NormalTok{mean_CrI_beta0_ridge01 <-}\StringTok{ }\KeywordTok{cbind}\NormalTok{(mean_beta0_ridge01, CrI_beta0_ridge01) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{()}

\CommentTok{#Renaming the columns}
\KeywordTok{colnames}\NormalTok{(mean_CrI_beta0_ridge01) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Mean"}\NormalTok{, }\StringTok{"95% CrI LL"}\NormalTok{, }\StringTok{"95% CrI UL"}\NormalTok{)}

\CommentTok{# Converting means and CrIs from log to regular scale}
\KeywordTok{exp}\NormalTok{(mean_CrI_beta0_ridge01)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##           Mean 95% CrI LL    95% CrI UL
## 1 1.878765e+18   1.872661 3.915733e+142
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# (11) Fitted values  ----------------------------------------------------------------------------}

\CommentTok{# Creating matrix to store fitted values}
\NormalTok{fitted_ridge01 =}\StringTok{ }\KeywordTok{matrix}\NormalTok{(}\OtherTok{NA}\NormalTok{, }\DataTypeTok{nrow=}\KeywordTok{nrow}\NormalTok{(ridge01_samples), }\DataTypeTok{ncol=} \KeywordTok{nrow}\NormalTok{(data.clean))}

\CommentTok{# Loop to generate fitted values: log(ri)}
\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{nrow}\NormalTok{(data.clean))\{}
\NormalTok{  fitted_ridge01[,i] =}\StringTok{ }\NormalTok{ridge01_samples[,}\StringTok{"beta0"}\NormalTok{] }\OperatorTok{+}\StringTok{ }
\StringTok{    }\KeywordTok{as.matrix}\NormalTok{(data.clean[i,}\DecValTok{5}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(data.clean)]) }\OperatorTok{%*%}\StringTok{ }\KeywordTok{t}\NormalTok{(ridge01_samples[,}\DecValTok{1}\OperatorTok{:}\DecValTok{8}\NormalTok{]) }\OperatorTok{+}\StringTok{ }
\StringTok{    }\NormalTok{ridge01_samples[, }\DecValTok{11}\OperatorTok{+}\NormalTok{i}\DecValTok{-1}\NormalTok{] \}}

\CommentTok{# Fitted values - distribution}
\NormalTok{fitted_ridge_}\DecValTok{01}\NormalTok{_dist <-}\StringTok{ }\NormalTok{data.clean}\OperatorTok{$}\NormalTok{Expected }\OperatorTok{*}\StringTok{ }\KeywordTok{exp}\NormalTok{(fitted_ridge01)}

\CommentTok{# Mean fitted SIR}
\NormalTok{fitted_SIR_ridge01 <-}\StringTok{ }\KeywordTok{exp}\NormalTok{(}\KeywordTok{apply}\NormalTok{(fitted_ridge01, }\DecValTok{2}\NormalTok{, mean))}

\CommentTok{# Mean fitted Cases}
\NormalTok{fitted_ridge_}\DecValTok{01}\NormalTok{ <-}\StringTok{ }\NormalTok{fitted_SIR_ridge01}\OperatorTok{*}\NormalTok{data.clean}\OperatorTok{$}\NormalTok{Expected}

\CommentTok{# 95% CrI SIR}
\NormalTok{fitted_ridge_}\DecValTok{01}\NormalTok{_CrI_SIR <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{exp}\NormalTok{(}\KeywordTok{apply}\NormalTok{(fitted_ridge01, }\DecValTok{2}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(x) }\KeywordTok{quantile}\NormalTok{(x, }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{, }\FloatTok{0.975}\NormalTok{)))))}

\CommentTok{# 95% CrI Cases}
\NormalTok{fitted_ridge_}\DecValTok{01}\NormalTok{_CrI <-}\StringTok{  }\NormalTok{data.clean}\OperatorTok{$}\NormalTok{Expected }\OperatorTok{*}\NormalTok{fitted_ridge_}\DecValTok{01}\NormalTok{_CrI_SIR}

\CommentTok{# Creating Dataframe to store fitted values and quantiles in regular svale}
\NormalTok{fitted_ridge01_df <-}\StringTok{ }\KeywordTok{data.frame}\NormalTok{(}\StringTok{"Observed SIR"}\NormalTok{   =}\StringTok{  }\KeywordTok{round}\NormalTok{(data.clean}\OperatorTok{$}\NormalTok{SIR, }\DecValTok{2}\NormalTok{), }
                                \StringTok{"Fitted SIR"}\NormalTok{     =}\StringTok{  }\KeywordTok{round}\NormalTok{(fitted_SIR_ridge01,}\DecValTok{2}\NormalTok{), }
                                \StringTok{"Observed Cases"}\NormalTok{ =}\StringTok{  }\KeywordTok{round}\NormalTok{(data.clean}\OperatorTok{$}\NormalTok{Cases), }
                                \StringTok{"Fitted Cases"}\NormalTok{ =}\StringTok{  }\KeywordTok{round}\NormalTok{(fitted_ridge_}\DecValTok{01}\NormalTok{), }
                                \StringTok{"CrI LL"}\NormalTok{    =}\StringTok{  }\KeywordTok{round}\NormalTok{(fitted_ridge_}\DecValTok{01}\NormalTok{_CrI[,}\DecValTok{1}\NormalTok{]),}
                                \StringTok{"CrI UL"}\NormalTok{    =}\StringTok{  }\KeywordTok{round}\NormalTok{(fitted_ridge_}\DecValTok{01}\NormalTok{_CrI[,}\DecValTok{2}\NormalTok{]))}

\CommentTok{# Top 6 rows}
\KeywordTok{head}\NormalTok{(fitted_ridge01_df)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   Observed.SIR Fitted.SIR Observed.Cases Fitted.Cases CrI.LL CrI.UL
## 1         3.09       0.23             42            3      2      4
## 2         1.40       0.05             43            1      1      2
## 3         1.00       0.10              9            1      0      2
## 4         0.60       0.03             14            1      0      1
## 5         0.42       0.01             12            0      0      1
## 6         0.54       0.01             20            1      0      1
\end{verbatim}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Ridge Adjacency MCMC chains-1} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Ridge Adjacency MCMC chains-2} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Ridge Adjacency MCMC chains-3} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Ridge Adjacency MCMC chains-4} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Ridge Adjacency MCMC chains-5} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Ridge Adjacency Posterior density curve-1} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Ridge Adjacency Posterior density curve-2} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Ridge Adjacency Posterior density curve-3} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Ridge Adjacency Posterior density curve-4} \end{center}

\textbf{Ridge: Neighborhood structure 2: Distance-based neighbors (k =
3)}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Model -> Compile model -> build MCMC object -> Compile MCMC object -> run MCMC}

\CommentTok{# Constants and initial values --------------------------------------------------------------------------}

\CommentTok{# (1) Define constants that go into CAR prior into a list}
\NormalTok{Consts_ridge_}\DecValTok{02}\NormalTok{ =}\StringTok{ }\KeywordTok{list}\NormalTok{(}\DataTypeTok{N =} \KeywordTok{nrow}\NormalTok{(data.clean),                  }\CommentTok{# Number of areas}
                     \DataTypeTok{p =} \KeywordTok{ncol}\NormalTok{(data.clean[}\DecValTok{5}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(data.clean)]),            }\CommentTok{# Number of covariates}
                     \DataTypeTok{X =} \KeywordTok{as.matrix}\NormalTok{(data.clean[, }\KeywordTok{c}\NormalTok{(}\DecValTok{5}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(data.clean))]),  }\CommentTok{# Matrix of covariates}
                     \DataTypeTok{L =} \KeywordTok{length}\NormalTok{(adj}\FloatTok{.3}\NormalTok{),                       }\CommentTok{# Edges (length of adj vector)}
                     \DataTypeTok{E =}\NormalTok{ data.clean}\OperatorTok{$}\NormalTok{Expected,}
                     \DataTypeTok{adj =}\NormalTok{ adj}\FloatTok{.3}\NormalTok{,                             }\CommentTok{# Adjacency matrix}
                     \DataTypeTok{num =}\NormalTok{ num.nb}\FloatTok{.3}\NormalTok{,                          }\CommentTok{# Number of neighbors per district}
                     \DataTypeTok{weights =} \KeywordTok{rep}\NormalTok{(}\DecValTok{1}\NormalTok{, }\KeywordTok{length}\NormalTok{(adj}\FloatTok{.3}\NormalTok{)))         }\CommentTok{# Giving weight of 1 for neighbors}

\CommentTok{# (2) Define dependent variable (outcome)}
\NormalTok{outcome <-}\StringTok{ }\KeywordTok{list}\NormalTok{(}\DataTypeTok{y =}\NormalTok{ data.clean}\OperatorTok{$}\NormalTok{Cases) }\CommentTok{# Observed cases}

\CommentTok{# (3) Define initial values for the MCMC chain}
\NormalTok{Inits_ridge <-}\StringTok{ }\KeywordTok{list}\NormalTok{(}\DataTypeTok{beta0=}\DecValTok{0}\NormalTok{, }\DataTypeTok{beta=}\KeywordTok{rep}\NormalTok{(}\DecValTok{0}\NormalTok{, }\KeywordTok{ncol}\NormalTok{(data.clean[}\DecValTok{5}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(data.clean)])),}
                    \DataTypeTok{sigma=}\DecValTok{2}\NormalTok{, }\DataTypeTok{lambda=}\DecValTok{1}\NormalTok{, }\DataTypeTok{s=}\KeywordTok{rnorm}\NormalTok{(}\KeywordTok{nrow}\NormalTok{(data.clean)))}

\CommentTok{# Defining model ------------------------------------------------------------------------------}

\CommentTok{# (1) Define ridge nimble model}
\NormalTok{ridge02_model=}\KeywordTok{nimbleModel}\NormalTok{(}\DataTypeTok{code=}\NormalTok{ridge_code, }
                          \DataTypeTok{constants=}\NormalTok{Consts_ridge_}\DecValTok{02}\NormalTok{, }\DataTypeTok{data=}\NormalTok{outcome, }\DataTypeTok{inits=}\NormalTok{Inits_ridge)}

\CommentTok{# (2) Compile ridge model for nimble}
\NormalTok{ridge02_Cmodel=}\KeywordTok{compileNimble}\NormalTok{(ridge02_model)}

\CommentTok{# (3) Configure the MCMC chain}
\NormalTok{ridge02_conf <-}\StringTok{ }\KeywordTok{configureMCMC}\NormalTok{(ridge02_model, }
                              \DataTypeTok{monitors =} \KeywordTok{c}\NormalTok{(}\StringTok{'beta0'}\NormalTok{,}\StringTok{"beta"}\NormalTok{, }\StringTok{'sigma'}\NormalTok{, }\StringTok{"lambda"}\NormalTok{, }\StringTok{'s'}\NormalTok{))}

\CommentTok{# (4) Do something}
\NormalTok{ridge02_conf}\OperatorTok{$}\KeywordTok{printSamplers}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1]  RW sampler: beta0
## [2]  RW sampler: sigma
## [3]  RW sampler: lambda
## [4]  RW sampler: beta[1]
## [5]  RW sampler: beta[2]
## [6]  RW sampler: beta[3]
## [7]  RW sampler: beta[4]
## [8]  RW sampler: beta[5]
## [9]  RW sampler: beta[6]
## [10] RW sampler: beta[7]
## [11] RW sampler: beta[8]
## [12] CAR_normal sampler: s[1:18]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# (5) Build MCMC object}
\NormalTok{ridge02_MCMC=}\KeywordTok{buildMCMC}\NormalTok{(ridge02_conf, }\DataTypeTok{enableWAIC=}\NormalTok{T)}

\CommentTok{# (6) Compile model with MCMC object}
\NormalTok{ridge02_CMCMC=}\KeywordTok{compileNimble}\NormalTok{(ridge02_MCMC, }\DataTypeTok{project=}\NormalTok{ridge02_Cmodel)}

\CommentTok{# (7) Run the model}
\NormalTok{ridge02_runMCMC=}\KeywordTok{runMCMC}\NormalTok{(ridge02_CMCMC, }\DataTypeTok{nburnin=}\DecValTok{10000}\NormalTok{, }\DataTypeTok{niter=}\DecValTok{500000}\NormalTok{, }\DataTypeTok{nchains=}\DecValTok{2}\NormalTok{, }\DataTypeTok{thin=}\DecValTok{25}\NormalTok{, }\DataTypeTok{WAIC=}\NormalTok{T)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## |-------------|-------------|-------------|-------------|
## |-------------------------------------------------------|
## |-------------|-------------|-------------|-------------|
## |-------------------------------------------------------|
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# (8) Check convergence}
\NormalTok{ridge02_samples=}\KeywordTok{rbind}\NormalTok{(ridge02_runMCMC}\OperatorTok{$}\NormalTok{samples[[}\DecValTok{1}\NormalTok{]], ridge02_runMCMC}\OperatorTok{$}\NormalTok{samples[[}\DecValTok{2}\NormalTok{]])}

\CommentTok{# (9) WAIC ---------}
\NormalTok{ridge02_runMCMC}\OperatorTok{$}\NormalTok{WAIC}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 115.7871
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# (10) Posterior summaries: Means and CrI  --------------------------------------------------------}

\CommentTok{#Betas}
\CommentTok{#Calculating the Beta means}
\NormalTok{means_betas_ridge02 <-}\StringTok{ }\KeywordTok{apply}\NormalTok{(ridge02_samples[,}\DecValTok{1}\OperatorTok{:}\DecValTok{9}\NormalTok{],}\DecValTok{2}\NormalTok{, mean)}

\CommentTok{#Calculating the Beta 95% CrI }
\NormalTok{CrI_betas_ridge02 <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{apply}\NormalTok{(ridge02_samples[ ,}\DecValTok{1}\OperatorTok{:}\DecValTok{9}\NormalTok{],}\DecValTok{2}\NormalTok{, }
                             \ControlFlowTok{function}\NormalTok{(x) }\KeywordTok{quantile}\NormalTok{(x, }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{,}\FloatTok{0.975}\NormalTok{))))}

\CommentTok{#Combining the means and CIs into a dataframe}
\NormalTok{mean_CrI_betas_ridge02 <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{matrix}\NormalTok{(}\KeywordTok{c}\NormalTok{(means_betas_ridge02, CrI_betas_ridge02), }
                                   \DataTypeTok{ncol=}\DecValTok{9}\NormalTok{, }\DataTypeTok{nrow =} \DecValTok{3}\NormalTok{, }\DataTypeTok{byrow=}\NormalTok{T)) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{()}

\CommentTok{#Renaming the columns}
\KeywordTok{colnames}\NormalTok{(mean_CrI_betas_ridge02) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Mean"}\NormalTok{, }\StringTok{"95% CrI LL"}\NormalTok{, }\StringTok{"95% CrI UL"}\NormalTok{)}

\CommentTok{# Converting means and CrIs from log to regular scale}
\KeywordTok{exp}\NormalTok{(mean_CrI_betas_ridge02)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##        Mean 95% CrI LL 95% CrI UL
## 1 1.1342712 0.69277068   2.190589
## 2 0.9926328 0.21379935   3.820476
## 3 0.9840621 0.25072944   3.554764
## 4 0.9840009 0.24211662   3.519115
## 5 0.9744791 0.19957825   3.784923
## 6 0.9712831 0.25752330   3.372106
## 7 0.8774299 0.72625109   1.029565
## 8 0.9999828 0.99883113   1.001140
## 9 0.5168876 0.01704225  47.437130
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{################### Spatial effect per region}

\CommentTok{#Calculating the S means}
\NormalTok{means_s_ridge02 <-}\StringTok{ }\KeywordTok{apply}\NormalTok{(ridge02_samples[ ,}\DecValTok{11}\OperatorTok{:}\DecValTok{28}\NormalTok{],}\DecValTok{2}\NormalTok{, mean)}

\CommentTok{#Calculating the Beta 95% CrI }
\NormalTok{CrI_s_ridge02 <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{apply}\NormalTok{(ridge02_samples[ ,}\DecValTok{11}\OperatorTok{:}\DecValTok{28}\NormalTok{],}\DecValTok{2}\NormalTok{, }
                         \ControlFlowTok{function}\NormalTok{(x) }\KeywordTok{quantile}\NormalTok{(x, }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{,}\FloatTok{0.975}\NormalTok{))))}

\CommentTok{#Combining the means and CIs into a dataframe}
\NormalTok{mean_CrI_s_ridge02 <-}\StringTok{ }\KeywordTok{cbind}\NormalTok{(means_s_ridge02, CrI_s_ridge02) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{()}

\CommentTok{#Renaming the columns}
\KeywordTok{colnames}\NormalTok{(mean_CrI_s_ridge02) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Mean"}\NormalTok{, }\StringTok{"95% CrI LL"}\NormalTok{, }\StringTok{"95% CrI UL"}\NormalTok{)}

\CommentTok{# Converting means and CrIs from log to regular scale}
\KeywordTok{exp}\NormalTok{(mean_CrI_s_ridge02)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##            Mean 95% CrI LL 95% CrI UL
## s[1]  2.9160106 0.92227935  8.3255146
## s[2]  0.7911559 0.20960088  2.9261051
## s[3]  2.6285192 0.99675780  7.2123918
## s[4]  0.5827297 0.25038462  1.1696823
## s[5]  0.6193972 0.26245633  1.4507041
## s[6]  0.7390515 0.23460900  2.3653771
## s[7]  1.4665738 0.48238329  5.5856951
## s[8]  0.3190027 0.13546504  0.7326729
## s[9]  0.4475039 0.26483175  0.7629895
## s[10] 0.7781395 0.33039312  1.7828348
## s[11] 4.1382603 2.24299205  7.7463268
## s[12] 1.0959452 0.56721229  2.0882841
## s[13] 0.6009560 0.30130561  1.1537812
## s[14] 1.0789215 0.44814496  3.0026913
## s[15] 6.2246902 2.20571146 16.0342615
## s[16] 0.3534021 0.11662910  0.9905104
## s[17] 3.7680722 1.47866217  8.2977531
## s[18] 0.1556785 0.05339987  0.4378003
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{################### Sigma}

\CommentTok{#Calculating the sigma means}
\NormalTok{means_sigma_ridge02 <-}\StringTok{ }\KeywordTok{mean}\NormalTok{(ridge02_samples[ ,}\DecValTok{29}\NormalTok{])}

\CommentTok{#Calculating the Beta 95% CrI }
\NormalTok{CrI_sigma_ridge02 <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{quantile}\NormalTok{(ridge02_samples[ ,}\DecValTok{29}\NormalTok{], }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{,}\FloatTok{0.975}\NormalTok{)))}

\CommentTok{#Combining the means and CIs into a dataframe}
\NormalTok{mean_CrI_sigma_ridge02 <-}\StringTok{ }\KeywordTok{cbind}\NormalTok{(means_sigma_ridge02, CrI_sigma_ridge02) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{()}

\CommentTok{#Renaming the columns}
\KeywordTok{colnames}\NormalTok{(mean_CrI_sigma_ridge02) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Mean"}\NormalTok{, }\StringTok{"95% CrI LL"}\NormalTok{, }\StringTok{"95% CrI UL"}\NormalTok{)}

\CommentTok{# Consigmaerting means and CrIs from log to regular scale}
\KeywordTok{exp}\NormalTok{(mean_CrI_sigma_ridge02)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##       Mean 95% CrI LL 95% CrI UL
## 1 6.073577   3.354047   15.22718
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{################## Lambda}

\NormalTok{mean_beta0_ridge02 <-}\StringTok{ }\KeywordTok{mean}\NormalTok{(ridge02_samples[ ,}\StringTok{"lambda"}\NormalTok{])}

\CommentTok{# Calculating the Beta 95% CrI }
\NormalTok{CrI_beta0_ridge02 <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{quantile}\NormalTok{(ridge02_samples[ , }\StringTok{"lambda"}\NormalTok{], }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{,}\FloatTok{0.975}\NormalTok{)))}

\CommentTok{# Combining the means and CIs into a dataframe}
\NormalTok{mean_CrI_beta0_ridge02 <-}\StringTok{ }\KeywordTok{cbind}\NormalTok{(mean_beta0_ridge02, CrI_beta0_ridge02) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{()}

\CommentTok{# Renaming the columns}
\KeywordTok{colnames}\NormalTok{(mean_CrI_beta0_ridge02) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Mean"}\NormalTok{, }\StringTok{"95% CrI LL"}\NormalTok{, }\StringTok{"95% CrI UL"}\NormalTok{)}

\CommentTok{# Converting means and CrIs from log to regular scale}
\KeywordTok{exp}\NormalTok{(mean_CrI_beta0_ridge02)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##           Mean 95% CrI LL    95% CrI UL
## 1 1.174679e+23   1.500026 5.115461e+215
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# (11) Fitted values ---------------------------------------------------------------------------}

\CommentTok{# Creating matrix to store fitted values}
\NormalTok{fitted_ridge02 =}\StringTok{ }\KeywordTok{matrix}\NormalTok{(}\OtherTok{NA}\NormalTok{, }\DataTypeTok{nrow=}\KeywordTok{nrow}\NormalTok{(ridge02_samples), }\DataTypeTok{ncol=} \KeywordTok{nrow}\NormalTok{(data.clean))}

\CommentTok{# Loop to generate fitted values: log(ri)}
\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{nrow}\NormalTok{(data.clean))\{}
\NormalTok{  fitted_ridge02[,i] =}\StringTok{ }\NormalTok{ridge02_samples[,}\StringTok{"beta0"}\NormalTok{] }
                      \OperatorTok{+}\StringTok{ }\KeywordTok{as.matrix}\NormalTok{(data.clean[i,}\DecValTok{5}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(data.clean)]) }\OperatorTok{%*%}\StringTok{ }\KeywordTok{t}\NormalTok{(ridge02_samples[,}\DecValTok{1}\OperatorTok{:}\DecValTok{8}\NormalTok{])}
                      \OperatorTok{+}\StringTok{ }\NormalTok{ridge02_samples[, }\DecValTok{11}\OperatorTok{+}\NormalTok{i}\DecValTok{-1}\NormalTok{] \}}

\CommentTok{# Mean fitted SIR}
\NormalTok{fitted_SIR_ridge02 <-}\StringTok{ }\KeywordTok{exp}\NormalTok{(}\KeywordTok{apply}\NormalTok{(fitted_ridge02, }\DecValTok{2}\NormalTok{, mean))}

\CommentTok{# Mean fitted Cases}
\NormalTok{fitted_ridge_}\DecValTok{02}\NormalTok{ <-}\StringTok{ }\NormalTok{fitted_SIR_ridge02}\OperatorTok{*}\NormalTok{data.clean}\OperatorTok{$}\NormalTok{Expected}

\CommentTok{# 95% CrI SIR}
\NormalTok{fitted_ridge_}\DecValTok{02}\NormalTok{_CrI_SIR <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{exp}\NormalTok{(}\KeywordTok{apply}\NormalTok{(fitted_ridge02, }\DecValTok{2}\NormalTok{, }
                                       \ControlFlowTok{function}\NormalTok{(x) }\KeywordTok{quantile}\NormalTok{(x, }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{, }\FloatTok{0.975}\NormalTok{)))))}

\CommentTok{# Creating Dataframe to store fitted values and quantiles in regular svale}
\CommentTok{# fitted_ridge02_df <- cbind(fitted_SIR_ridge02, fitted_car_ridge_02_CrI)}

\CommentTok{# 95% CrI Cases}
\NormalTok{fitted_ridge_}\DecValTok{02}\NormalTok{_CrI <-}\StringTok{  }\NormalTok{data.clean}\OperatorTok{$}\NormalTok{Expected }\OperatorTok{*}\NormalTok{fitted_ridge_}\DecValTok{02}\NormalTok{_CrI_SIR}

\CommentTok{# Creating Dataframe to store fitted values and quantiles in regular svale}
\NormalTok{fitted_ridge02_df <-}\StringTok{ }\KeywordTok{data.frame}\NormalTok{(}\StringTok{"Observed SIR"}\NormalTok{   =}\StringTok{  }\KeywordTok{round}\NormalTok{(data.clean}\OperatorTok{$}\NormalTok{SIR, }\DecValTok{2}\NormalTok{), }
                                \StringTok{"Fitted SIR"}\NormalTok{     =}\StringTok{  }\KeywordTok{round}\NormalTok{(fitted_SIR_ridge02,}\DecValTok{2}\NormalTok{), }
                                \StringTok{"Observed Cases"}\NormalTok{ =}\StringTok{  }\KeywordTok{round}\NormalTok{(data.clean}\OperatorTok{$}\NormalTok{Cases), }
                                \StringTok{"Fitted Cases"}\NormalTok{ =}\StringTok{  }\KeywordTok{round}\NormalTok{(fitted_ridge_}\DecValTok{02}\NormalTok{), }
                                \StringTok{"CrI LL"}\NormalTok{    =}\StringTok{  }\KeywordTok{round}\NormalTok{(fitted_ridge_}\DecValTok{02}\NormalTok{_CrI[,}\DecValTok{1}\NormalTok{]),}
                                \StringTok{"CrI UL"}\NormalTok{    =}\StringTok{  }\KeywordTok{round}\NormalTok{(fitted_ridge_}\DecValTok{02}\NormalTok{_CrI[,}\DecValTok{2}\NormalTok{]))}

\CommentTok{# Top 6 rows}
\KeywordTok{head}\NormalTok{(fitted_ridge02_df)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   Observed.SIR Fitted.SIR Observed.Cases Fitted.Cases CrI.LL CrI.UL
## 1         3.09       0.52             42            7      0    645
## 2         1.40       0.52             43           16      1   1458
## 3         1.00       0.52              9            5      0    428
## 4         0.60       0.52             14           12      0   1099
## 5         0.42       0.52             12           15      0   1354
## 6         0.54       0.52             20           19      1   1772
\end{verbatim}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Ridge K3 MCMC chains-1} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Ridge K3 MCMC chains-2} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Ridge K3 MCMC chains-3} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Ridge K3 MCMC chains-4} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Ridge K3 MCMC chains-5} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Ridge K3 Posterior density curve-1} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Ridge K3 Posterior density curve-2} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Ridge K3 Posterior density curve-3} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Ridge K3 Posterior density curve-4} \end{center}

\textbf{Ridge: Neighborhood structure 3: Distance-based neighbors (k =
5)}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Model -> Compile model -> build MCMC object -> Compile MCMC object -> run MCMC}

\CommentTok{# Constants and initial values --------------------------------------------------------------------------}

\CommentTok{# (1) Define constants that go into CAR prior into a list}
\NormalTok{Consts_ridge_}\DecValTok{03}\NormalTok{ =}\StringTok{ }\KeywordTok{list}\NormalTok{(}\DataTypeTok{N =} \KeywordTok{nrow}\NormalTok{(data.clean),                              }\CommentTok{# Number of areas}
                     \DataTypeTok{p =} \KeywordTok{ncol}\NormalTok{(data.clean[}\DecValTok{5}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(data.clean)]),            }\CommentTok{# Number of covariates}
                     \DataTypeTok{X =} \KeywordTok{as.matrix}\NormalTok{(data.clean[, }\KeywordTok{c}\NormalTok{(}\DecValTok{5}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(data.clean))]),  }\CommentTok{# Matrix of covariates}
                     \DataTypeTok{L =} \KeywordTok{length}\NormalTok{(adj}\FloatTok{.5}\NormalTok{),                       }\CommentTok{# Edges (length of adj vector)}
                     \DataTypeTok{E =}\NormalTok{ data.clean}\OperatorTok{$}\NormalTok{Expected,}
                     \DataTypeTok{adj =}\NormalTok{ adj}\FloatTok{.5}\NormalTok{,                             }\CommentTok{# Adjacency matrix}
                     \DataTypeTok{num =}\NormalTok{ num.nb}\FloatTok{.5}\NormalTok{,                          }\CommentTok{# Number of neighbors per district}
                     \DataTypeTok{weights =} \KeywordTok{rep}\NormalTok{(}\DecValTok{1}\NormalTok{, }\KeywordTok{length}\NormalTok{(adj}\FloatTok{.5}\NormalTok{)))         }\CommentTok{# Giving weight of 1 for neighbors}

\CommentTok{# (2) Define dependent variable (outcome)}
\NormalTok{outcome <-}\StringTok{ }\KeywordTok{list}\NormalTok{(}\DataTypeTok{y =}\NormalTok{ data.clean}\OperatorTok{$}\NormalTok{Cases) }\CommentTok{# Observed cases}

\CommentTok{# (3) Define initial values for the MCMC chain}
\NormalTok{Inits_ridge <-}\StringTok{ }\KeywordTok{list}\NormalTok{(}\DataTypeTok{beta0=}\DecValTok{0}\NormalTok{, }\DataTypeTok{beta=}\KeywordTok{rep}\NormalTok{(}\DecValTok{0}\NormalTok{, }\KeywordTok{ncol}\NormalTok{(data.clean[}\DecValTok{5}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(data.clean)])),}
                    \DataTypeTok{sigma=}\DecValTok{2}\NormalTok{, }\DataTypeTok{lambda=}\DecValTok{1}\NormalTok{, }\DataTypeTok{s=}\KeywordTok{rnorm}\NormalTok{(}\KeywordTok{nrow}\NormalTok{(data.clean)))}


\CommentTok{# Defining model ------------------------------------------------------------------------------}

\CommentTok{# (1) Define ridge nimble model}
\NormalTok{ridge03_model=}\KeywordTok{nimbleModel}\NormalTok{(}\DataTypeTok{code=}\NormalTok{ridge_code, }\DataTypeTok{constants=}\NormalTok{Consts_ridge_}\DecValTok{03}\NormalTok{, }\DataTypeTok{data=}\NormalTok{outcome, }\DataTypeTok{inits=}\NormalTok{Inits_ridge)}

\CommentTok{# (2) Compile ridge model for nimble}
\NormalTok{ridge03_Cmodel=}\KeywordTok{compileNimble}\NormalTok{(ridge03_model)}

\CommentTok{# (3) Configure the MCMC chain}
\NormalTok{ridge03_conf <-}\StringTok{ }\KeywordTok{configureMCMC}\NormalTok{(ridge03_model, }
                              \DataTypeTok{monitors =} \KeywordTok{c}\NormalTok{(}\StringTok{'beta0'}\NormalTok{,}\StringTok{"beta"}\NormalTok{,}\StringTok{'sigma'}\NormalTok{, }\StringTok{"lambda"}\NormalTok{, }\StringTok{'s'}\NormalTok{))}

\CommentTok{# (4) Do something}
\NormalTok{ridge03_conf}\OperatorTok{$}\KeywordTok{printSamplers}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1]  RW sampler: beta0
## [2]  RW sampler: sigma
## [3]  RW sampler: lambda
## [4]  RW sampler: beta[1]
## [5]  RW sampler: beta[2]
## [6]  RW sampler: beta[3]
## [7]  RW sampler: beta[4]
## [8]  RW sampler: beta[5]
## [9]  RW sampler: beta[6]
## [10] RW sampler: beta[7]
## [11] RW sampler: beta[8]
## [12] CAR_normal sampler: s[1:18]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# (5) Build MCMC object}
\NormalTok{ridge03_MCMC=}\KeywordTok{buildMCMC}\NormalTok{(ridge03_conf, }\DataTypeTok{enableWAIC=}\NormalTok{T)}

\CommentTok{# (6) Compile model with MCMC object}
\NormalTok{ridge03_CMCMC=}\KeywordTok{compileNimble}\NormalTok{(ridge03_MCMC, }\DataTypeTok{project=}\NormalTok{ridge03_Cmodel)}

\CommentTok{# (7) Run the model}
\NormalTok{ridge03_runMCMC=}\KeywordTok{runMCMC}\NormalTok{(ridge03_CMCMC, }\DataTypeTok{nburnin=}\DecValTok{10000}\NormalTok{, }\DataTypeTok{niter=}\DecValTok{200000}\NormalTok{, }\DataTypeTok{nchains=}\DecValTok{2}\NormalTok{, }\DataTypeTok{thin=}\DecValTok{25}\NormalTok{, }\DataTypeTok{WAIC=}\NormalTok{T)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## |-------------|-------------|-------------|-------------|
## |-------------------------------------------------------|
## |-------------|-------------|-------------|-------------|
## |-------------------------------------------------------|
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# (8) Check convergence}
\NormalTok{ridge03_samples=}\KeywordTok{rbind}\NormalTok{(ridge03_runMCMC}\OperatorTok{$}\NormalTok{samples[[}\DecValTok{1}\NormalTok{]], ridge03_runMCMC}\OperatorTok{$}\NormalTok{samples[[}\DecValTok{2}\NormalTok{]])}

\CommentTok{# (9) WAIC ---------}
\NormalTok{ridge03_runMCMC}\OperatorTok{$}\NormalTok{WAIC}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 116.0453
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# (10) Posterior summaries: Means and CrI  -------------------------------------------------------}

\CommentTok{#Calculating the Beta means}
\NormalTok{means_betas_ridge03 <-}\StringTok{ }\KeywordTok{apply}\NormalTok{(ridge03_samples[,}\DecValTok{1}\OperatorTok{:}\DecValTok{9}\NormalTok{],}\DecValTok{2}\NormalTok{, mean)}

\CommentTok{#Calculating the Beta 95% CrI }
\NormalTok{CrI_betas_ridge03 <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{apply}\NormalTok{(ridge03_samples[ ,}\DecValTok{1}\OperatorTok{:}\DecValTok{9}\NormalTok{],}\DecValTok{2}\NormalTok{, }
                             \ControlFlowTok{function}\NormalTok{(x) }\KeywordTok{quantile}\NormalTok{(x, }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{,}\FloatTok{0.975}\NormalTok{))))}

\CommentTok{#Combining the means and CIs into a dataframe}
\NormalTok{mean_CrI_betas_ridge03 <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{matrix}\NormalTok{(}\KeywordTok{c}\NormalTok{(means_betas_ridge03, CrI_betas_ridge03), }
                                   \DataTypeTok{ncol=}\DecValTok{9}\NormalTok{, }\DataTypeTok{nrow =} \DecValTok{3}\NormalTok{, }\DataTypeTok{byrow=}\NormalTok{T)) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{()}

\CommentTok{#Renaming the columns}
\KeywordTok{colnames}\NormalTok{(mean_CrI_betas_ridge03) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Mean"}\NormalTok{, }\StringTok{"95% CrI LL"}\NormalTok{, }\StringTok{"95% CrI UL"}\NormalTok{)}

\CommentTok{# Converting means and CrIs from log to regular scale}
\KeywordTok{exp}\NormalTok{(mean_CrI_betas_ridge03)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##        Mean 95% CrI LL 95% CrI UL
## 1 1.0501559 0.61931671   1.811923
## 2 1.0875747 0.36814076   4.949485
## 3 1.0204977 0.30431317   3.836183
## 4 1.0090910 0.29597473   3.627500
## 5 1.0393260 0.30516894   4.257361
## 6 1.0107659 0.30267746   3.707805
## 7 0.8631946 0.73652743   1.015601
## 8 0.9998103 0.99862020   1.001132
## 9 0.7257376 0.02304081  22.560453
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{################### Spatial effects per region}

\CommentTok{#Calculating the S means}
\NormalTok{means_s_ridge03 <-}\StringTok{ }\KeywordTok{apply}\NormalTok{(ridge03_samples[ ,}\DecValTok{11}\OperatorTok{:}\DecValTok{28}\NormalTok{],}\DecValTok{2}\NormalTok{, mean)}

\CommentTok{#Calculating the Beta 95% CrI }
\NormalTok{CrI_s_ridge03 <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{apply}\NormalTok{(ridge03_samples[ ,}\DecValTok{11}\OperatorTok{:}\DecValTok{28}\NormalTok{],}\DecValTok{2}\NormalTok{, }
                         \ControlFlowTok{function}\NormalTok{(x) }\KeywordTok{quantile}\NormalTok{(x, }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{,}\FloatTok{0.975}\NormalTok{))))}

\CommentTok{#Combining the means and CIs into a dataframe}
\NormalTok{mean_CrI_s_ridge03 <-}\StringTok{ }\KeywordTok{cbind}\NormalTok{(means_s_ridge03, CrI_s_ridge03) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{()}

\CommentTok{#Renaming the columns}
\KeywordTok{colnames}\NormalTok{(mean_CrI_s_ridge03) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Mean"}\NormalTok{, }\StringTok{"95% CrI LL"}\NormalTok{, }\StringTok{"95% CrI UL"}\NormalTok{)}

\CommentTok{# Converting means and CrIs from log to regular scale}
\KeywordTok{exp}\NormalTok{(mean_CrI_s_ridge03)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##            Mean 95% CrI LL 95% CrI UL
## s[1]  2.3787632 0.85859469  7.2275737
## s[2]  0.9058152 0.22916675  3.5291417
## s[3]  2.1615110 0.81391557  5.9451446
## s[4]  0.6506769 0.31747399  1.2989153
## s[5]  0.7029871 0.28951873  1.5536041
## s[6]  1.1129616 0.34972290  3.1477252
## s[7]  1.3854074 0.45176608  4.4935803
## s[8]  0.2672569 0.11973849  0.6325566
## s[9]  0.4176420 0.24820250  0.6943069
## s[10] 0.9701363 0.42028809  2.0922148
## s[11] 3.4791884 1.98492271  6.6494606
## s[12] 0.9426816 0.49555274  1.7645294
## s[13] 0.5898213 0.29769487  1.1063253
## s[14] 1.1367688 0.45732490  2.8132359
## s[15] 5.2682957 2.15269878 14.1012084
## s[16] 0.3722370 0.11934422  1.0980478
## s[17] 4.4853376 1.99158255  9.9117536
## s[18] 0.1453433 0.04929723  0.3863764
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{################### Sigma}

\CommentTok{#Calculating the sigma means}
\NormalTok{means_sigma_ridge03 <-}\StringTok{ }\KeywordTok{mean}\NormalTok{(ridge03_samples[ ,}\DecValTok{29}\NormalTok{])}

\CommentTok{#Calculating the Beta 95% CrI }
\NormalTok{CrI_sigma_ridge03 <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{quantile}\NormalTok{(ridge03_samples[ ,}\DecValTok{29}\NormalTok{], }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{,}\FloatTok{0.975}\NormalTok{)))}

\CommentTok{#Combining the means and CIs into a dataframe}
\NormalTok{mean_CrI_sigma_ridge03 <-}\StringTok{ }\KeywordTok{cbind}\NormalTok{(means_sigma_ridge03, CrI_sigma_ridge03) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{()}

\CommentTok{#Renaming the columns}
\KeywordTok{colnames}\NormalTok{(mean_CrI_sigma_ridge03) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Mean"}\NormalTok{, }\StringTok{"95% CrI LL"}\NormalTok{, }\StringTok{"95% CrI UL"}\NormalTok{)}

\CommentTok{# Consigmaerting means and CrIs from log to regular scale}
\KeywordTok{exp}\NormalTok{(mean_CrI_sigma_ridge03)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##       Mean 95% CrI LL 95% CrI UL
## 1 11.99697   5.355155   42.06398
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{################## Lambda}

\NormalTok{mean_beta0_ridge03 <-}\StringTok{ }\KeywordTok{mean}\NormalTok{(ridge03_samples[ ,}\StringTok{"lambda"}\NormalTok{])}

\CommentTok{#Calculating the Beta 95% CrI }
\NormalTok{CrI_beta0_ridge03 <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{quantile}\NormalTok{(ridge03_samples[ , }\StringTok{"lambda"}\NormalTok{], }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{,}\FloatTok{0.975}\NormalTok{)))}

\CommentTok{#Combining the means and CIs into a dataframe}
\NormalTok{mean_CrI_beta0_ridge03 <-}\StringTok{ }\KeywordTok{cbind}\NormalTok{(mean_beta0_ridge03, CrI_beta0_ridge03) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{()}

\CommentTok{#Renaming the columns}
\KeywordTok{colnames}\NormalTok{(mean_CrI_beta0_ridge03) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Mean"}\NormalTok{, }\StringTok{"95% CrI LL"}\NormalTok{, }\StringTok{"95% CrI UL"}\NormalTok{)}

\CommentTok{# Converting means and CrIs from log to regular scale}
\KeywordTok{exp}\NormalTok{(mean_CrI_beta0_ridge03)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##           Mean 95% CrI LL    95% CrI UL
## 1 6.503253e+19   1.729285 9.348545e+113
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# (11) Fitted values  -----------------------------------------------------------------------------}

\CommentTok{# Creating matrix to store fitted values}
\NormalTok{fitted_ridge03 =}\StringTok{ }\KeywordTok{matrix}\NormalTok{(}\OtherTok{NA}\NormalTok{, }\DataTypeTok{nrow=}\KeywordTok{nrow}\NormalTok{(ridge03_samples), }\DataTypeTok{ncol=} \KeywordTok{nrow}\NormalTok{(data.clean))}

\CommentTok{# Loop to generate fitted values: log(ri)}
\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{nrow}\NormalTok{(data.clean))\{}
\NormalTok{  fitted_ridge03[,i] =}\StringTok{ }\NormalTok{ridge03_samples[,}\StringTok{"beta0"}\NormalTok{] }
                      \OperatorTok{+}\StringTok{ }\KeywordTok{as.matrix}\NormalTok{(data.clean[i,}\DecValTok{5}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(data.clean)]) }\OperatorTok{%*%}\StringTok{ }\KeywordTok{t}\NormalTok{(ridge03_samples[,}\DecValTok{1}\OperatorTok{:}\DecValTok{8}\NormalTok{])}
                      \OperatorTok{+}\StringTok{ }\NormalTok{ridge03_samples[, }\DecValTok{7}\OperatorTok{+}\NormalTok{i}\DecValTok{-1}\NormalTok{] \}}

\CommentTok{# Mean fitted SIR}
\NormalTok{fitted_SIR_ridge03 <-}\StringTok{ }\KeywordTok{exp}\NormalTok{(}\KeywordTok{apply}\NormalTok{(fitted_ridge03, }\DecValTok{2}\NormalTok{, mean))}

\CommentTok{# Mean fitted Cases}
\NormalTok{fitted_ridge_}\DecValTok{03}\NormalTok{ <-}\StringTok{ }\NormalTok{fitted_SIR_ridge03}\OperatorTok{*}\NormalTok{data.clean}\OperatorTok{$}\NormalTok{Expected}

\CommentTok{# 95% CrI SIR}
\NormalTok{fitted_ridge_}\DecValTok{03}\NormalTok{_CrI_SIR <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{exp}\NormalTok{(}\KeywordTok{apply}\NormalTok{(fitted_ridge03, }\DecValTok{2}\NormalTok{, }
                                       \ControlFlowTok{function}\NormalTok{(x) }\KeywordTok{quantile}\NormalTok{(x, }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{, }\FloatTok{0.975}\NormalTok{)))))}

\CommentTok{# Creating Dataframe to store fitted values and quantiles in regular svale}
\CommentTok{# fitted_ridge03_df <- cbind(fitted_car_ridge_03_mean, fitted_car_ridge_03_CrI)}

\CommentTok{# 95% CrI Cases}
\NormalTok{fitted_ridge_}\DecValTok{03}\NormalTok{_CrI <-}\StringTok{  }\NormalTok{data.clean}\OperatorTok{$}\NormalTok{Expected }\OperatorTok{*}\NormalTok{fitted_ridge_}\DecValTok{03}\NormalTok{_CrI_SIR}

\CommentTok{# Creating Dataframe to store fitted values and quantiles in regular svale}
\NormalTok{fitted_ridge03_df <-}\StringTok{ }\KeywordTok{data.frame}\NormalTok{(}\StringTok{"Observed SIR"}\NormalTok{   =}\StringTok{  }\KeywordTok{round}\NormalTok{(data.clean}\OperatorTok{$}\NormalTok{SIR, }\DecValTok{2}\NormalTok{), }
                                \StringTok{"Fitted SIR"}\NormalTok{     =}\StringTok{  }\KeywordTok{round}\NormalTok{(fitted_SIR_ridge03,}\DecValTok{2}\NormalTok{), }
                                \StringTok{"Observed Cases"}\NormalTok{ =}\StringTok{  }\KeywordTok{round}\NormalTok{(data.clean}\OperatorTok{$}\NormalTok{Cases), }
                                \StringTok{"Fitted Cases"}\NormalTok{ =}\StringTok{  }\KeywordTok{round}\NormalTok{(fitted_ridge_}\DecValTok{03}\NormalTok{), }
                                \StringTok{"CrI LL"}\NormalTok{    =}\StringTok{  }\KeywordTok{round}\NormalTok{(fitted_ridge_}\DecValTok{03}\NormalTok{_CrI[,}\DecValTok{1}\NormalTok{]),}
                                \StringTok{"CrI UL"}\NormalTok{    =}\StringTok{  }\KeywordTok{round}\NormalTok{(fitted_ridge_}\DecValTok{03}\NormalTok{_CrI[,}\DecValTok{2}\NormalTok{]))}

\CommentTok{# Top 6 rows}
\KeywordTok{head}\NormalTok{(fitted_ridge03_df)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   Observed.SIR Fitted.SIR Observed.Cases Fitted.Cases CrI.LL CrI.UL
## 1         3.09       0.73             42           10      0    307
## 2         1.40       0.73             43           22      1    693
## 3         1.00       0.73              9            7      0    203
## 4         0.60       0.73             14           17      1    523
## 5         0.42       0.73             12           21      1    644
## 6         0.54       0.73             20           27      1    843
\end{verbatim}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Ridge K5 MCMC chains-1} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Ridge K5 MCMC chains-2} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Ridge K5 MCMC chains-3} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Ridge K5 MCMC chains-4} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Ridge K5 MCMC chains-5} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Ridge K5 Posterior density curves-1} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Ridge K5 Posterior density curves-2} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Ridge K5 Posterior density curves-3} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Ridge K5 Posterior density curves-4} \end{center}

\hypertarget{ridge-regression-bym-model}{%
\subsection{Ridge regression BYM
model}\label{ridge-regression-bym-model}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{#########################################}
\CommentTok{#    Usual fixed priors model - RIDGE   # }
\CommentTok{#########################################}

\CommentTok{# Defining the usual fixed priors model ------------------------------------------------------}
\NormalTok{ridge_code_bym <-}\StringTok{ }\KeywordTok{nimbleCode}\NormalTok{(\{ }
  
  \CommentTok{# Defining our priors}
\NormalTok{  beta0 }\OperatorTok{~}\StringTok{ }\KeywordTok{dnorm}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DataTypeTok{sd =} \DecValTok{200}\NormalTok{)}
  
  \ControlFlowTok{for}\NormalTok{(j }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\NormalTok{p)\{}
\NormalTok{    beta[j] }\OperatorTok{~}\StringTok{ }\KeywordTok{dnorm}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DataTypeTok{sd=}\DecValTok{1}\OperatorTok{*}\KeywordTok{sqrt}\NormalTok{(}\DecValTok{1}\OperatorTok{/}\NormalTok{lambda))  }\CommentTok{# Betas for the covariates}
\NormalTok{  \}}
  
  \CommentTok{# Half-Cauchy priors for conditional std-dev & tuning param (lambda)}
  \CommentTok{#nu ~ T(dt(0, 1, 1),0,) }
\NormalTok{  sigma }\OperatorTok{~}\StringTok{ }\KeywordTok{T}\NormalTok{(}\KeywordTok{dt}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{),}\DecValTok{0}\NormalTok{,) }
\NormalTok{  lambda }\OperatorTok{~}\StringTok{ }\KeywordTok{T}\NormalTok{(}\KeywordTok{dt}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{),}\DecValTok{0}\NormalTok{,)}

  \CommentTok{# Defining transformed parameters}
\NormalTok{  tau2 <-}\StringTok{ }\DecValTok{1}\OperatorTok{/}\NormalTok{(sigma}\OperatorTok{^}\DecValTok{2}\NormalTok{)}
  
  \CommentTok{# CAR prior}
\NormalTok{  s[}\DecValTok{1}\OperatorTok{:}\NormalTok{N] }\OperatorTok{~}\StringTok{ }\KeywordTok{dcar_normal}\NormalTok{(adj[}\DecValTok{1}\OperatorTok{:}\NormalTok{L], weights[}\DecValTok{1}\OperatorTok{:}\NormalTok{L], num[}\DecValTok{1}\OperatorTok{:}\NormalTok{N], tau2, }\DataTypeTok{zero_mean =} \DecValTok{1}\NormalTok{)}
  
  \CommentTok{# Defining likelihood}
  \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\NormalTok{N) \{ }
    \KeywordTok{log}\NormalTok{(mu[i]) <-}\StringTok{ }\NormalTok{beta0 }\OperatorTok{+}\StringTok{ }\KeywordTok{inprod}\NormalTok{(X[i, }\DecValTok{1}\OperatorTok{:}\NormalTok{p], beta[}\DecValTok{1}\OperatorTok{:}\NormalTok{p]) }\OperatorTok{+}\StringTok{ }\KeywordTok{log}\NormalTok{(E[i])}\OperatorTok{+}\StringTok{ }\NormalTok{s[i] }\OperatorTok{+}\StringTok{ }\NormalTok{v[i]}
    \CommentTok{#mu[i] <- E[i]*r[i]}
\NormalTok{    y[i] }\OperatorTok{~}\StringTok{ }\KeywordTok{dpois}\NormalTok{(mu[i])}
\NormalTok{    v[i] }\OperatorTok{~}\StringTok{ }\KeywordTok{dnorm}\NormalTok{(}\DecValTok{0}\NormalTok{, sigma)}
\NormalTok{  \}}
\NormalTok{\})}
\end{Highlighting}
\end{Shaded}

\textbf{Ridge : Neighborhood structure 1: Adjacent Neighbors}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Model -> Compile model -> build MCMC object -> Compile MCMC object -> run MCMC}

\CommentTok{# Constants and initial values --------------------------------------------------------------------------}

\CommentTok{# (1) Define constants that go into CAR prior into a list}
\NormalTok{Consts_ridge_}\DecValTok{01}\NormalTok{ =}\StringTok{ }\KeywordTok{list}\NormalTok{(}\DataTypeTok{N =} \KeywordTok{nrow}\NormalTok{(data.clean),                              }\CommentTok{# Number of areas}
                     \DataTypeTok{p =} \KeywordTok{ncol}\NormalTok{(data.clean[}\DecValTok{5}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(data.clean)]),            }\CommentTok{# Number of covariates}
                     \DataTypeTok{X =} \KeywordTok{as.matrix}\NormalTok{(data.clean[, }\KeywordTok{c}\NormalTok{(}\DecValTok{5}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(data.clean))]),  }\CommentTok{# Matrix of covariates}
                     \DataTypeTok{L =} \KeywordTok{length}\NormalTok{(adj),                       }\CommentTok{# Edges (length of adj vector)}
                     \DataTypeTok{E =}\NormalTok{ data.clean}\OperatorTok{$}\NormalTok{Expected,}
                     \DataTypeTok{adj =}\NormalTok{ adj,                             }\CommentTok{# Adjacency matrix}
                     \DataTypeTok{num =}\NormalTok{ num.nb,                          }\CommentTok{# Number of neighbors per district}
                     \DataTypeTok{weights =} \KeywordTok{rep}\NormalTok{(}\DecValTok{1}\NormalTok{, }\KeywordTok{length}\NormalTok{(adj)))         }\CommentTok{# Giving weight of 1 for neighbors}

\CommentTok{# (2) Define dependent variable (outcome)}
\NormalTok{outcome <-}\StringTok{ }\KeywordTok{list}\NormalTok{(}\DataTypeTok{y =}\NormalTok{ data.clean}\OperatorTok{$}\NormalTok{Cases) }\CommentTok{# Observed cases}

\CommentTok{# (3) Define initial values for the MCMC chain}
\NormalTok{Inits_ridge <-}\StringTok{ }\KeywordTok{list}\NormalTok{(}\DataTypeTok{beta0=}\DecValTok{0}\NormalTok{, }\DataTypeTok{beta=}\KeywordTok{rep}\NormalTok{(}\DecValTok{0}\NormalTok{, }\KeywordTok{ncol}\NormalTok{(data.clean[}\DecValTok{5}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(data.clean)])),}
                    \DataTypeTok{sigma=}\DecValTok{2}\NormalTok{, }\DataTypeTok{lambda=}\DecValTok{1}\NormalTok{, }\DataTypeTok{s=}\KeywordTok{rnorm}\NormalTok{(}\KeywordTok{nrow}\NormalTok{(data.clean)))}

\CommentTok{# Defining model -----------------------------------------------------------------------------}
\CommentTok{# (1) Define ridge nimble model}
\NormalTok{ridge01_model =}\StringTok{ }\KeywordTok{nimbleModel}\NormalTok{(}\DataTypeTok{code=}\NormalTok{ridge_code_bym, }\DataTypeTok{constants=}\NormalTok{Consts_ridge_}\DecValTok{01}\NormalTok{, }\DataTypeTok{data=}\NormalTok{outcome,}
                            \DataTypeTok{inits=}\NormalTok{Inits_ridge)}

\CommentTok{# (2) Compile ridge model for nimble}
\NormalTok{ridge01_Cmodel=}\KeywordTok{compileNimble}\NormalTok{(ridge01_model)}

\CommentTok{# (3) Configure the MCMC chain}
\NormalTok{ridge01_conf <-}\StringTok{ }\KeywordTok{configureMCMC}\NormalTok{(ridge01_model, }
                              \DataTypeTok{monitors =} \KeywordTok{c}\NormalTok{(}\StringTok{'beta0'}\NormalTok{,}\StringTok{"beta"}\NormalTok{, }\StringTok{'sigma'}\NormalTok{, }\StringTok{"lambda"}\NormalTok{, }\StringTok{'s'}\NormalTok{))}
\CommentTok{# (4) Do something}
\NormalTok{ridge01_conf}\OperatorTok{$}\KeywordTok{printSamplers}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1]  RW sampler: beta0
## [2]  RW sampler: sigma
## [3]  RW sampler: lambda
## [4]  RW sampler: v[1]
## [5]  RW sampler: v[2]
## [6]  RW sampler: v[3]
## [7]  RW sampler: v[4]
## [8]  RW sampler: v[5]
## [9]  RW sampler: v[6]
## [10] RW sampler: v[7]
## [11] RW sampler: v[8]
## [12] RW sampler: v[9]
## [13] RW sampler: v[10]
## [14] RW sampler: v[11]
## [15] RW sampler: v[12]
## [16] RW sampler: v[13]
## [17] RW sampler: v[14]
## [18] RW sampler: v[15]
## [19] RW sampler: v[16]
## [20] RW sampler: v[17]
## [21] RW sampler: v[18]
## [22] RW sampler: beta[1]
## [23] RW sampler: beta[2]
## [24] RW sampler: beta[3]
## [25] RW sampler: beta[4]
## [26] RW sampler: beta[5]
## [27] RW sampler: beta[6]
## [28] RW sampler: beta[7]
## [29] RW sampler: beta[8]
## [30] CAR_normal sampler: s[1:18]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# (5) Build MCMC object}
\NormalTok{ridge01_MCMC=}\KeywordTok{buildMCMC}\NormalTok{(ridge01_conf, }\DataTypeTok{enableWAIC=}\NormalTok{T)}

\CommentTok{# (6) Compile model with MCMC object}
\NormalTok{ridge01_CMCMC=}\KeywordTok{compileNimble}\NormalTok{(ridge01_MCMC, }\DataTypeTok{project=}\NormalTok{ridge01_Cmodel)}

\CommentTok{# (7) Run the model}
\NormalTok{ridge01_runMCMC=}\KeywordTok{runMCMC}\NormalTok{(ridge01_CMCMC, }\DataTypeTok{nburnin=}\DecValTok{10000}\NormalTok{, }\DataTypeTok{niter=}\DecValTok{500000}\NormalTok{, }\DataTypeTok{nchains=}\DecValTok{2}\NormalTok{, }\DataTypeTok{thin=}\DecValTok{25}\NormalTok{, }\DataTypeTok{WAIC=}\NormalTok{T)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## |-------------|-------------|-------------|-------------|
## |-------------------------------------------------------|
## |-------------|-------------|-------------|-------------|
## |-------------------------------------------------------|
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# (8) Check convergence}
\NormalTok{ridge01_samples=}\KeywordTok{rbind}\NormalTok{(ridge01_runMCMC}\OperatorTok{$}\NormalTok{samples[[}\DecValTok{1}\NormalTok{]], ridge01_runMCMC}\OperatorTok{$}\NormalTok{samples[[}\DecValTok{2}\NormalTok{]])}

\CommentTok{# (9) WAIC}
\NormalTok{ridge01_runMCMC}\OperatorTok{$}\NormalTok{WAIC}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 2833381
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# (10) Posterior summaries: Means and CrI  --------------------------------------------------------}

\CommentTok{#Calculating the Beta means (beta0 included, last variable)}
\NormalTok{means_betas_ridge01_bym <-}\StringTok{ }\KeywordTok{apply}\NormalTok{(ridge01_samples[,}\DecValTok{1}\OperatorTok{:}\DecValTok{9}\NormalTok{],}\DecValTok{2}\NormalTok{, mean)}

\CommentTok{#Calculating the Beta 95% CrI }
\NormalTok{CrI_betas_ridge01_bym <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{apply}\NormalTok{(ridge01_samples[ ,}\DecValTok{1}\OperatorTok{:}\DecValTok{9}\NormalTok{],}\DecValTok{2}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(x) }\KeywordTok{quantile}\NormalTok{(x, }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{,}\FloatTok{0.975}\NormalTok{))))}

\CommentTok{#Combining the means and CIs into a dataframe}
\NormalTok{mean_CrI_betas_ridge01_bym <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{matrix}\NormalTok{(}\KeywordTok{c}\NormalTok{(means_betas_ridge01_bym, CrI_betas_ridge01_bym), }\DataTypeTok{ncol=}\DecValTok{9}\NormalTok{, }\DataTypeTok{nrow =} \DecValTok{3}\NormalTok{, }\DataTypeTok{byrow=}\NormalTok{T)) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{()}

\CommentTok{#Renaming the columns}
\KeywordTok{colnames}\NormalTok{(mean_CrI_betas_ridge01_bym) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Mean"}\NormalTok{, }\StringTok{"95% CrI LL"}\NormalTok{, }\StringTok{"95% CrI UL"}\NormalTok{)}

\CommentTok{# Converting means and CrIs from log to regular scale}
\KeywordTok{exp}\NormalTok{(mean_CrI_betas_ridge01_bym)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##        Mean 95% CrI LL 95% CrI UL
## 1 1.0442090 0.61380600   1.956846
## 2 0.9983824 0.33135534   2.851319
## 3 0.9878526 0.35218067   2.633152
## 4 0.9918094 0.34585073   2.727509
## 5 0.9868977 0.32782539   2.644012
## 6 1.0032108 0.37672005   2.775616
## 7 0.9200885 0.72965622   1.125244
## 8 1.0003403 0.99868372   1.002063
## 9 3.0965246 0.04481844 310.384179
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{################### Spatial effect per region}

\CommentTok{#Calculating the S means}
\NormalTok{means_s_ridge01_bym <-}\StringTok{ }\KeywordTok{apply}\NormalTok{(ridge01_samples[ ,}\DecValTok{11}\OperatorTok{:}\DecValTok{28}\NormalTok{],}\DecValTok{2}\NormalTok{, mean)}

\CommentTok{#Calculating the Beta 95% CrI }
\NormalTok{CrI_s_ridge01_bym <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{apply}\NormalTok{(ridge01_samples[ ,}\DecValTok{11}\OperatorTok{:}\DecValTok{28}\NormalTok{],}\DecValTok{2}\NormalTok{, }
                             \ControlFlowTok{function}\NormalTok{(x) }\KeywordTok{quantile}\NormalTok{(x, }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{,}\FloatTok{0.975}\NormalTok{))))}

\CommentTok{#Combining the means and CIs into a dataframe}
\NormalTok{mean_CrI_s_ridge01_bym <-}\StringTok{ }\KeywordTok{cbind}\NormalTok{(means_s_ridge01_bym, CrI_s_ridge01_bym) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{()}

\CommentTok{#Renaming the columns}
\KeywordTok{colnames}\NormalTok{(mean_CrI_s_ridge01_bym) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Mean"}\NormalTok{, }\StringTok{"95% CrI LL"}\NormalTok{, }\StringTok{"95% CrI UL"}\NormalTok{)}

\CommentTok{# Converting means and CrIs from log to regular scale}
\KeywordTok{exp}\NormalTok{(mean_CrI_s_ridge01_bym)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##            Mean 95% CrI LL 95% CrI UL
## s[1]  2.9996515  0.5845395  14.921332
## s[2]  1.8422885  0.2815150   9.793733
## s[3]  1.4981202  0.1467582  14.718332
## s[4]  0.7646840  0.2816665   2.106795
## s[5]  0.6487737  0.1936968   2.051168
## s[6]  0.7376096  0.2049601   2.738111
## s[7]  0.7704451  0.1953780   3.378051
## s[8]  0.6269142  0.2189170   1.704209
## s[9]  0.6999968  0.3018207   1.615955
## s[10] 0.7727284  0.2494980   2.371437
## s[11] 2.9788977  0.6842519  12.256392
## s[12] 0.7079963  0.2721953   1.849265
## s[13] 0.6162554  0.2225316   1.640017
## s[14] 0.7460634  0.1975922   2.881918
## s[15] 3.1403848  0.6609276  14.265137
## s[16] 0.5796840  0.1647073   1.798958
## s[17] 1.4387958  0.3713465   7.050531
## s[18] 0.4974552  0.1306192   1.563750
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{################### Sigma}

\CommentTok{#Calculating the sigma means}
\NormalTok{means_sigma_ridge01_bym <-}\StringTok{ }\KeywordTok{mean}\NormalTok{(ridge01_samples[ ,}\DecValTok{29}\NormalTok{])}

\CommentTok{#Calculating the Beta 95% CrI }
\NormalTok{CrI_sigma_ridge01_bym <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{quantile}\NormalTok{(ridge01_samples[ ,}\DecValTok{29}\NormalTok{], }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{,}\FloatTok{0.975}\NormalTok{)))}

\CommentTok{#Combining the means and CIs into a dataframe}
\NormalTok{mean_CrI_sigma_ridge01_bym <-}\StringTok{ }\KeywordTok{cbind}\NormalTok{(means_sigma_ridge01_bym, CrI_sigma_ridge01_bym) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{as.data.frame}\NormalTok{()}

\CommentTok{#Renaming the columns}
\KeywordTok{colnames}\NormalTok{(mean_CrI_sigma_ridge01_bym) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Mean"}\NormalTok{, }\StringTok{"95% CrI LL"}\NormalTok{, }\StringTok{"95% CrI UL"}\NormalTok{)}

\CommentTok{# Consigmaerting means and CrIs from log to regular scale}
\KeywordTok{exp}\NormalTok{(mean_CrI_sigma_ridge01_bym)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##       Mean 95% CrI LL 95% CrI UL
## 1 3.237179   1.655916   8.867296
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{################## Lambda}

\NormalTok{mean_beta0_ridge01_bym <-}\StringTok{ }\KeywordTok{mean}\NormalTok{(ridge01_samples[ ,}\StringTok{"lambda"}\NormalTok{])}

\CommentTok{#Calculating the Beta 95% CrI }
\NormalTok{CrI_beta0_ridge01_bym <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{quantile}\NormalTok{(ridge01_samples[ , }\StringTok{"lambda"}\NormalTok{], }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{,}\FloatTok{0.975}\NormalTok{)))}

\CommentTok{#Combining the means and CIs into a dataframe}
\NormalTok{mean_CrI_beta0_ridge01_bym <-}\StringTok{ }\KeywordTok{cbind}\NormalTok{(mean_beta0_ridge01_bym, CrI_beta0_ridge01_bym) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{()}

\CommentTok{#Renaming the columns}
\KeywordTok{colnames}\NormalTok{(mean_CrI_beta0_ridge01_bym) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Mean"}\NormalTok{, }\StringTok{"95% CrI LL"}\NormalTok{, }\StringTok{"95% CrI UL"}\NormalTok{)}

\CommentTok{# Converting means and CrIs from log to regular scale}
\KeywordTok{exp}\NormalTok{(mean_CrI_beta0_ridge01_bym)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##           Mean 95% CrI LL 95% CrI UL
## 1 2.581377e+44    2.08137        Inf
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# (11) Fitted values  -----------------------------------------------------------------------------}

\CommentTok{#Creating matrix to store fitted values}
\NormalTok{fitted_ridge01_bym =}\StringTok{ }\KeywordTok{matrix}\NormalTok{(}\OtherTok{NA}\NormalTok{, }\DataTypeTok{nrow=}\KeywordTok{nrow}\NormalTok{(ridge01_samples), }\DataTypeTok{ncol=} \KeywordTok{nrow}\NormalTok{(data.clean))}

\CommentTok{#Loop to generate fitted values: log(ri)}
\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{nrow}\NormalTok{(data.clean))\{}
\NormalTok{  fitted_ridge01_bym[,i] =}\StringTok{ }\NormalTok{ridge01_samples[,}\StringTok{"beta0"}\NormalTok{] }
                      \OperatorTok{+}\StringTok{ }\KeywordTok{as.matrix}\NormalTok{(data.clean[i,}\DecValTok{5}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(data.clean)]) }\OperatorTok{%*%}\StringTok{ }\KeywordTok{t}\NormalTok{(ridge01_samples[,}\DecValTok{1}\OperatorTok{:}\DecValTok{8}\NormalTok{])}
                      \OperatorTok{+}\StringTok{ }\KeywordTok{log}\NormalTok{(data.clean}\OperatorTok{$}\NormalTok{Expected[i]) }\OperatorTok{+}
\StringTok{                      }\OperatorTok{+}\StringTok{ }\NormalTok{ridge01_samples[, }\DecValTok{11}\OperatorTok{+}\NormalTok{i}\DecValTok{-1}\NormalTok{] \}}

\CommentTok{# Fitted values - distribution}
\NormalTok{fitted_bym_ridge_}\DecValTok{01}\NormalTok{_dist <-}\StringTok{ }\KeywordTok{exp}\NormalTok{(fitted_ridge01)}

\CommentTok{# Mean fitted values}
\NormalTok{fitted_bym_ridge_}\DecValTok{01}\NormalTok{_mean <-}\StringTok{ }\KeywordTok{apply}\NormalTok{(fitted_bym_ridge_}\DecValTok{01}\NormalTok{_dist, }\DecValTok{2}\NormalTok{, mean)}

\CommentTok{# 95% CrI}
\NormalTok{fitted_bym_ridge_}\DecValTok{01}\NormalTok{_CrI <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{apply}\NormalTok{(fitted_bym_ridge_}\DecValTok{01}\NormalTok{_dist, }\DecValTok{2}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(x) }\KeywordTok{quantile}\NormalTok{(x, }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{, }\FloatTok{0.975}\NormalTok{))))}

\CommentTok{# Creating Dataframe to store fitted values and quantiles in regular svale}
\NormalTok{fitted_ridge01_df_bym <-}\StringTok{ }\KeywordTok{cbind}\NormalTok{(fitted_bym_ridge_}\DecValTok{01}\NormalTok{_mean, fitted_bym_ridge_}\DecValTok{01}\NormalTok{_CrI)}

\CommentTok{# Renaming columns}
\KeywordTok{colnames}\NormalTok{(fitted_ridge01_df_bym) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"fitted_mean_ridge01"}\NormalTok{, }\StringTok{"fitted_lower_ridge01"}\NormalTok{ , }\StringTok{"fitted_upper_ridge01"}\NormalTok{)}

\CommentTok{# Top 6 rows}
\KeywordTok{head}\NormalTok{(fitted_ridge01_df_bym)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      fitted_mean_ridge01 fitted_lower_ridge01 fitted_upper_ridge01
## [1,]          0.22958223          0.163912112           0.30678689
## [2,]          0.04717718          0.033985343           0.06281298
## [3,]          0.11028972          0.050795946           0.19225992
## [4,]          0.02690843          0.015411264           0.04191154
## [5,]          0.01489455          0.007964400           0.02400653
## [6,]          0.01391932          0.008422489           0.02079135
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Predicted vs observed cases}
\KeywordTok{cbind}\NormalTok{(data.clean}\OperatorTok{$}\NormalTok{Cases, fitted_ridge01_df_bym) }\CommentTok{#similar fitted values}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##          fitted_mean_ridge01 fitted_lower_ridge01 fitted_upper_ridge01
##  [1,] 42         0.229582232          0.163912112          0.306786893
##  [2,] 43         0.047177176          0.033985343          0.062812977
##  [3,]  9         0.110289721          0.050795946          0.192259925
##  [4,] 14         0.026908427          0.015411264          0.041911542
##  [5,] 12         0.014894553          0.007964400          0.024006533
##  [6,] 20         0.013919318          0.008422489          0.020791349
##  [7,] 10         0.029484307          0.014252785          0.050537964
##  [8,] 15         0.023095908          0.013286038          0.035686230
##  [9,] 22         0.015567097          0.009988238          0.022387713
## [10,] 10         0.020235830          0.010459986          0.033509245
## [11,] 50         0.224759792          0.164315455          0.296063133
## [12,] 15         0.046386326          0.026131433          0.073151628
## [13,]  8         0.025253516          0.012002777          0.043862591
## [14,] 21         0.027620862          0.016863194          0.040893662
## [15,] 50         0.479306692          0.349524123          0.632140379
## [16,]  4         0.008306930          0.002923538          0.016515196
## [17,] 62         0.172472402          0.129673342          0.221352223
## [18,]  4         0.005219054          0.002070691          0.009780825
\end{verbatim}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Ridge BYM Adjacency MCMC chains-1} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Ridge BYM Adjacency MCMC chains-2} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Ridge BYM Adjacency MCMC chains-3} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Ridge BYM Adjacency MCMC chains-4} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Ridge BYM Adjacency MCMC chains-5} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Ridge BYM Adjacency Posterior density curves-1} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Ridge BYM Adjacency Posterior density curves-2} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Ridge BYM Adjacency Posterior density curves-3} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Ridge BYM Adjacency Posterior density curves-4} \end{center}

\textbf{Ridge: Neighborhood structure 2: Distance-based neighbors (k =
3)}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Model -> Compile model -> build MCMC object -> Compile MCMC object -> run MCMC}

\CommentTok{# Constants and initial values --------------------------------------------------------------------------}

\CommentTok{# (1) Define constants that go into CAR prior into a list}
\NormalTok{Consts_ridge_}\DecValTok{02}\NormalTok{ =}\StringTok{ }\KeywordTok{list}\NormalTok{(}\DataTypeTok{N =} \KeywordTok{nrow}\NormalTok{(data.clean),                  }\CommentTok{# Number of areas}
                     \DataTypeTok{p =} \KeywordTok{ncol}\NormalTok{(data.clean[}\DecValTok{5}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(data.clean)]),            }\CommentTok{# Number of covariates}
                     \DataTypeTok{X =} \KeywordTok{as.matrix}\NormalTok{(data.clean[, }\KeywordTok{c}\NormalTok{(}\DecValTok{5}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(data.clean))]),  }\CommentTok{# Matrix of covariates}
                     \DataTypeTok{L =} \KeywordTok{length}\NormalTok{(adj}\FloatTok{.3}\NormalTok{),                       }\CommentTok{# Edges (length of adj vector)}
                     \DataTypeTok{E =}\NormalTok{ data.clean}\OperatorTok{$}\NormalTok{Expected,}
                     \DataTypeTok{adj =}\NormalTok{ adj}\FloatTok{.3}\NormalTok{,                             }\CommentTok{# Adjacency matrix}
                     \DataTypeTok{num =}\NormalTok{ num.nb}\FloatTok{.3}\NormalTok{,                          }\CommentTok{# Number of neighbors per district}
                     \DataTypeTok{weights =} \KeywordTok{rep}\NormalTok{(}\DecValTok{1}\NormalTok{, }\KeywordTok{length}\NormalTok{(adj}\FloatTok{.3}\NormalTok{)))         }\CommentTok{# Giving weight of 1 for neighbors}

\CommentTok{# (2) Define dependent variable (outcome)}
\NormalTok{outcome <-}\StringTok{ }\KeywordTok{list}\NormalTok{(}\DataTypeTok{y =}\NormalTok{ data.clean}\OperatorTok{$}\NormalTok{Cases) }\CommentTok{# Observed cases}

\CommentTok{# (3) Define initial values for the MCMC chain}
\NormalTok{Inits_ridge <-}\StringTok{ }\KeywordTok{list}\NormalTok{(}\DataTypeTok{beta0=}\DecValTok{0}\NormalTok{, }\DataTypeTok{beta=}\KeywordTok{rep}\NormalTok{(}\DecValTok{0}\NormalTok{, }\KeywordTok{ncol}\NormalTok{(data.clean[}\DecValTok{5}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(data.clean)])),}
                    \DataTypeTok{sigma=}\DecValTok{2}\NormalTok{, }\DataTypeTok{lambda=}\DecValTok{50}\NormalTok{, }\DataTypeTok{s=}\KeywordTok{rnorm}\NormalTok{(}\KeywordTok{nrow}\NormalTok{(data.clean)))}


\CommentTok{# Defining model ------------------------------------------------------------------------------}

\CommentTok{# (1) Define ridge nimble model}
\NormalTok{ridge02_model=}\KeywordTok{nimbleModel}\NormalTok{(}\DataTypeTok{code=}\NormalTok{ridge_code_bym, }
                          \DataTypeTok{constants=}\NormalTok{Consts_ridge_}\DecValTok{02}\NormalTok{, }\DataTypeTok{data=}\NormalTok{outcome, }\DataTypeTok{inits=}\NormalTok{Inits_ridge)}

\CommentTok{# (2) Compile ridge model for nimble}
\NormalTok{ridge02_Cmodel=}\KeywordTok{compileNimble}\NormalTok{(ridge02_model)}

\CommentTok{# (3) Configure the MCMC chain}
\NormalTok{ridge02_conf <-}\StringTok{ }\KeywordTok{configureMCMC}\NormalTok{(ridge02_model, }
                              \DataTypeTok{monitors =} \KeywordTok{c}\NormalTok{(}\StringTok{'beta0'}\NormalTok{,}\StringTok{"beta"}\NormalTok{, }\StringTok{'sigma'}\NormalTok{, }\StringTok{"lambda"}\NormalTok{, }\StringTok{'s'}\NormalTok{))}

\CommentTok{# (4) Do something}
\NormalTok{ridge02_conf}\OperatorTok{$}\KeywordTok{printSamplers}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1]  RW sampler: beta0
## [2]  RW sampler: sigma
## [3]  RW sampler: lambda
## [4]  RW sampler: v[1]
## [5]  RW sampler: v[2]
## [6]  RW sampler: v[3]
## [7]  RW sampler: v[4]
## [8]  RW sampler: v[5]
## [9]  RW sampler: v[6]
## [10] RW sampler: v[7]
## [11] RW sampler: v[8]
## [12] RW sampler: v[9]
## [13] RW sampler: v[10]
## [14] RW sampler: v[11]
## [15] RW sampler: v[12]
## [16] RW sampler: v[13]
## [17] RW sampler: v[14]
## [18] RW sampler: v[15]
## [19] RW sampler: v[16]
## [20] RW sampler: v[17]
## [21] RW sampler: v[18]
## [22] RW sampler: beta[1]
## [23] RW sampler: beta[2]
## [24] RW sampler: beta[3]
## [25] RW sampler: beta[4]
## [26] RW sampler: beta[5]
## [27] RW sampler: beta[6]
## [28] RW sampler: beta[7]
## [29] RW sampler: beta[8]
## [30] CAR_normal sampler: s[1:18]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# (5) Build MCMC object}
\NormalTok{ridge02_MCMC=}\KeywordTok{buildMCMC}\NormalTok{(ridge02_conf, }\DataTypeTok{enableWAIC=}\NormalTok{T)}

\CommentTok{# (6) Compile model with MCMC object}
\NormalTok{ridge02_CMCMC=}\KeywordTok{compileNimble}\NormalTok{(ridge02_MCMC, }\DataTypeTok{project=}\NormalTok{ridge02_Cmodel)}

\CommentTok{# (7) Run the model}
\NormalTok{ridge02_runMCMC=}\KeywordTok{runMCMC}\NormalTok{(ridge02_CMCMC, }\DataTypeTok{nburnin=}\DecValTok{10000}\NormalTok{, }\DataTypeTok{niter=}\DecValTok{500000}\NormalTok{, }\DataTypeTok{nchains=}\DecValTok{2}\NormalTok{, }\DataTypeTok{thin=}\DecValTok{25}\NormalTok{, }\DataTypeTok{WAIC=}\NormalTok{T)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## |-------------|-------------|-------------|-------------|
## |-------------------------------------------------------|
## |-------------|-------------|-------------|-------------|
## |-------------------------------------------------------|
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# (8) Check convergence}
\NormalTok{ridge02_samples=}\KeywordTok{rbind}\NormalTok{(ridge02_runMCMC}\OperatorTok{$}\NormalTok{samples[[}\DecValTok{1}\NormalTok{]], ridge02_runMCMC}\OperatorTok{$}\NormalTok{samples[[}\DecValTok{2}\NormalTok{]])}

\CommentTok{# (9) WAIC ---------}
\NormalTok{ridge02_runMCMC}\OperatorTok{$}\NormalTok{WAIC}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 809882.2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# (10) Posterior summaries: Means and CrI  --------------------------------------------------------}

\CommentTok{#Betas}
\CommentTok{#Calculating the Beta means}
\NormalTok{means_betas_ridge02_bym <-}\StringTok{ }\KeywordTok{apply}\NormalTok{(ridge02_samples[,}\DecValTok{1}\OperatorTok{:}\DecValTok{9}\NormalTok{],}\DecValTok{2}\NormalTok{, mean)}

\CommentTok{#Calculating the Beta 95% CrI }
\NormalTok{CrI_betas_ridge02_bym <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{apply}\NormalTok{(ridge02_samples[ ,}\DecValTok{1}\OperatorTok{:}\DecValTok{9}\NormalTok{],}\DecValTok{2}\NormalTok{, }
                             \ControlFlowTok{function}\NormalTok{(x) }\KeywordTok{quantile}\NormalTok{(x, }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{,}\FloatTok{0.975}\NormalTok{))))}

\CommentTok{#Combining the means and CIs into a dataframe}
\NormalTok{mean_CrI_betas_ridge02_bym <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{matrix}\NormalTok{(}\KeywordTok{c}\NormalTok{(means_betas_ridge02_bym, CrI_betas_ridge02_bym), }
                                   \DataTypeTok{ncol=}\DecValTok{9}\NormalTok{, }\DataTypeTok{nrow =} \DecValTok{3}\NormalTok{, }\DataTypeTok{byrow=}\NormalTok{T)) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{()}

\CommentTok{#Renaming the columns}
\KeywordTok{colnames}\NormalTok{(mean_CrI_betas_ridge02_bym) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Mean"}\NormalTok{, }\StringTok{"95% CrI LL"}\NormalTok{, }\StringTok{"95% CrI UL"}\NormalTok{)}

\CommentTok{# Converting means and CrIs from log to regular scale}
\KeywordTok{exp}\NormalTok{(mean_CrI_betas_ridge02_bym)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##        Mean 95% CrI LL  95% CrI UL
## 1 1.1014201  0.6778161    2.089342
## 2 0.9905328  0.2997067    3.363573
## 3 0.9960194  0.3310438    3.099672
## 4 0.9961586  0.3215488    2.995387
## 5 1.0113257  0.3238097    3.291598
## 6 0.9936821  0.3212943    2.999599
## 7 0.8720859  0.7048891    1.038411
## 8 1.0003330  0.9989031    1.001781
## 9 8.8333377  0.2421579 1416.750951
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{################### Spatial effect per region}

\CommentTok{#Calculating the S means}
\NormalTok{means_s_ridge02_bym <-}\StringTok{ }\KeywordTok{apply}\NormalTok{(ridge02_samples[ ,}\DecValTok{11}\OperatorTok{:}\DecValTok{28}\NormalTok{],}\DecValTok{2}\NormalTok{, mean)}

\CommentTok{#Calculating the Beta 95% CrI }
\NormalTok{CrI_s_ridge02_bym <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{apply}\NormalTok{(ridge02_samples[ ,}\DecValTok{11}\OperatorTok{:}\DecValTok{28}\NormalTok{],}\DecValTok{2}\NormalTok{, }
                         \ControlFlowTok{function}\NormalTok{(x) }\KeywordTok{quantile}\NormalTok{(x, }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{,}\FloatTok{0.975}\NormalTok{))))}

\CommentTok{#Combining the means and CIs into a dataframe}
\NormalTok{mean_CrI_s_ridge02_bym <-}\StringTok{ }\KeywordTok{cbind}\NormalTok{(means_s_ridge02_bym, CrI_s_ridge02_bym) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{()}

\CommentTok{#Renaming the columns}
\KeywordTok{colnames}\NormalTok{(mean_CrI_s_ridge02_bym) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Mean"}\NormalTok{, }\StringTok{"95% CrI LL"}\NormalTok{, }\StringTok{"95% CrI UL"}\NormalTok{)}

\CommentTok{# Converting means and CrIs from log to regular scale}
\KeywordTok{exp}\NormalTok{(mean_CrI_s_ridge02_bym)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##            Mean 95% CrI LL 95% CrI UL
## s[1]  1.7704288  0.5643359   6.771417
## s[2]  1.1929463  0.2982369   4.642992
## s[3]  1.2342845  0.3888034   4.297304
## s[4]  0.8308466  0.2976760   2.139579
## s[5]  0.8270874  0.2877965   2.151911
## s[6]  0.9362179  0.2906215   2.896711
## s[7]  0.9956457  0.2888459   3.639119
## s[8]  0.6474494  0.1900839   1.925607
## s[9]  0.8214595  0.3122968   2.087304
## s[10] 0.8594011  0.2839430   2.418882
## s[11] 2.0533684  0.6130628   8.025638
## s[12] 0.8750552  0.2822866   2.651212
## s[13] 0.7310648  0.2745238   1.676568
## s[14] 0.9452280  0.2939113   3.134767
## s[15] 2.0162159  0.6133514   8.228292
## s[16] 0.7166370  0.2342917   1.801684
## s[17] 1.4161450  0.5686708   4.342436
## s[18] 0.5157090  0.1195065   1.736323
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{################### Sigma}

\CommentTok{#Calculating the sigma means}
\NormalTok{means_sigma_ridge02_bym <-}\StringTok{ }\KeywordTok{mean}\NormalTok{(ridge02_samples[ ,}\DecValTok{29}\NormalTok{])}

\CommentTok{#Calculating the Beta 95% CrI }
\NormalTok{CrI_sigma_ridge02_bym <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{quantile}\NormalTok{(ridge02_samples[ ,}\DecValTok{29}\NormalTok{], }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{,}\FloatTok{0.975}\NormalTok{)))}

\CommentTok{#Combining the means and CIs into a dataframe}
\NormalTok{mean_CrI_sigma_ridge02_bym <-}\StringTok{ }\KeywordTok{cbind}\NormalTok{(means_sigma_ridge02_bym, CrI_sigma_ridge02_bym) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{()}

\CommentTok{#Renaming the columns}
\KeywordTok{colnames}\NormalTok{(mean_CrI_sigma_ridge02_bym) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Mean"}\NormalTok{, }\StringTok{"95% CrI LL"}\NormalTok{, }\StringTok{"95% CrI UL"}\NormalTok{)}

\CommentTok{# Consigmaerting means and CrIs from log to regular scale}
\KeywordTok{exp}\NormalTok{(mean_CrI_sigma_ridge02_bym)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##       Mean 95% CrI LL 95% CrI UL
## 1 3.534544   1.745844   9.369891
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{################## Lambda}

\NormalTok{mean_beta0_ridge02_bym <-}\StringTok{ }\KeywordTok{mean}\NormalTok{(ridge02_samples[ ,}\StringTok{"lambda"}\NormalTok{])}

\CommentTok{#Calculating the Beta 95% CrI }
\NormalTok{CrI_beta0_ridge02_bym <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{quantile}\NormalTok{(ridge02_samples[ , }\StringTok{"lambda"}\NormalTok{], }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{,}\FloatTok{0.975}\NormalTok{)))}

\CommentTok{#Combining the means and CIs into a dataframe}
\NormalTok{mean_CrI_beta0_ridge02_bym <-}\StringTok{ }\KeywordTok{cbind}\NormalTok{(mean_beta0_ridge02_bym, CrI_beta0_ridge02_bym) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{()}

\CommentTok{#Renaming the columns}
\KeywordTok{colnames}\NormalTok{(mean_CrI_beta0_ridge02_bym) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Mean"}\NormalTok{, }\StringTok{"95% CrI LL"}\NormalTok{, }\StringTok{"95% CrI UL"}\NormalTok{)}

\CommentTok{# Converting means and CrIs from log to regular scale}
\KeywordTok{exp}\NormalTok{(mean_CrI_beta0_ridge02_bym)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##           Mean 95% CrI LL    95% CrI UL
## 1 1.333206e+25    1.81917 2.362957e+203
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# (11) Fitted values  -----------------------------------------------------------------------------}

\CommentTok{#Creating matrix to store fitted values}
\NormalTok{fitted_ridge02_bym =}\StringTok{ }\KeywordTok{matrix}\NormalTok{(}\OtherTok{NA}\NormalTok{, }\DataTypeTok{nrow=}\KeywordTok{nrow}\NormalTok{(ridge02_samples), }\DataTypeTok{ncol=} \KeywordTok{nrow}\NormalTok{(data.clean))}

\CommentTok{#Loop to generate fitted values: log(ri)}
\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{nrow}\NormalTok{(data.clean))\{}
\NormalTok{  fitted_ridge02_bym[,i] =}\StringTok{ }\NormalTok{ridge02_samples[,}\StringTok{"beta0"}\NormalTok{] }
                      \OperatorTok{+}\StringTok{ }\KeywordTok{as.matrix}\NormalTok{(data.clean[i,}\DecValTok{5}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(data.clean)]) }\OperatorTok{%*%}\StringTok{ }\KeywordTok{t}\NormalTok{(ridge02_samples[,}\DecValTok{1}\OperatorTok{:}\DecValTok{8}\NormalTok{])}
                      \OperatorTok{+}\StringTok{ }\KeywordTok{log}\NormalTok{(data.clean}\OperatorTok{$}\NormalTok{Expected[i])}
                      \OperatorTok{+}\StringTok{ }\NormalTok{ridge02_samples[, }\DecValTok{11}\OperatorTok{+}\NormalTok{i}\DecValTok{-1}\NormalTok{] \}}

\CommentTok{# Fitted values - distribution}
\NormalTok{fitted_bym_ridge_}\DecValTok{02}\NormalTok{_dist <-}\StringTok{ }\KeywordTok{exp}\NormalTok{(fitted_ridge02_bym)}

\CommentTok{# Mean fitted values}
\NormalTok{fitted_bym_ridge_}\DecValTok{02}\NormalTok{_mean <-}\StringTok{ }\KeywordTok{apply}\NormalTok{(fitted_bym_ridge_}\DecValTok{02}\NormalTok{_dist, }\DecValTok{2}\NormalTok{, mean)}

\CommentTok{# 95% CrI}
\NormalTok{fitted_bym_ridge_}\DecValTok{02}\NormalTok{_CrI <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{apply}\NormalTok{(fitted_bym_ridge_}\DecValTok{02}\NormalTok{_dist, }\DecValTok{2}\NormalTok{, }
                                   \ControlFlowTok{function}\NormalTok{(x) }\KeywordTok{quantile}\NormalTok{(x, }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{, }\FloatTok{0.975}\NormalTok{))))}

\CommentTok{# Creating Dataframe to store fitted values and quantiles in regular svale}
\NormalTok{fitted_ridge02_df_bym <-}\StringTok{ }\KeywordTok{cbind}\NormalTok{(fitted_bym_ridge_}\DecValTok{02}\NormalTok{_mean, fitted_bym_ridge_}\DecValTok{02}\NormalTok{_CrI)}

\CommentTok{# Renaming columns}
\KeywordTok{colnames}\NormalTok{(fitted_ridge02_df_bym) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"fitted_mean_ridge02"}\NormalTok{, }\StringTok{"fitted_lower_ridge02"}\NormalTok{ , }\StringTok{"fitted_upper_ridge02"}\NormalTok{)}

\CommentTok{# Top 6 rows}
\KeywordTok{head}\NormalTok{(fitted_ridge02_df_bym)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      fitted_mean_ridge02 fitted_lower_ridge02 fitted_upper_ridge02
## [1,]            188.2941            0.2421579             1416.751
## [2,]            188.2941            0.2421579             1416.751
## [3,]            188.2941            0.2421579             1416.751
## [4,]            188.2941            0.2421579             1416.751
## [5,]            188.2941            0.2421579             1416.751
## [6,]            188.2941            0.2421579             1416.751
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Predicted vs observed cases}
\KeywordTok{cbind}\NormalTok{(data.clean}\OperatorTok{$}\NormalTok{Cases,fitted_ridge02_df_bym)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##          fitted_mean_ridge02 fitted_lower_ridge02 fitted_upper_ridge02
##  [1,] 42            188.2941            0.2421579             1416.751
##  [2,] 43            188.2941            0.2421579             1416.751
##  [3,]  9            188.2941            0.2421579             1416.751
##  [4,] 14            188.2941            0.2421579             1416.751
##  [5,] 12            188.2941            0.2421579             1416.751
##  [6,] 20            188.2941            0.2421579             1416.751
##  [7,] 10            188.2941            0.2421579             1416.751
##  [8,] 15            188.2941            0.2421579             1416.751
##  [9,] 22            188.2941            0.2421579             1416.751
## [10,] 10            188.2941            0.2421579             1416.751
## [11,] 50            188.2941            0.2421579             1416.751
## [12,] 15            188.2941            0.2421579             1416.751
## [13,]  8            188.2941            0.2421579             1416.751
## [14,] 21            188.2941            0.2421579             1416.751
## [15,] 50            188.2941            0.2421579             1416.751
## [16,]  4            188.2941            0.2421579             1416.751
## [17,] 62            188.2941            0.2421579             1416.751
## [18,]  4            188.2941            0.2421579             1416.751
\end{verbatim}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Ridge BYM K3 MCMC chains-1} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Ridge BYM K3 MCMC chains-2} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Ridge BYM K3 MCMC chains-3} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Ridge BYM K3 MCMC chains-4} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Ridge BYM K3 MCMC chains-5} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Ridge BYM K3 Posterior distributions-1} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Ridge BYM K3 Posterior distributions-2} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Ridge BYM K3 Posterior distributions-3} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Ridge BYM K3 Posterior distributions-4} \end{center}

\textbf{Ridge: Neighborhood structure 3: Distance-based neighbors (k =
5)}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Model -> Compile model -> build MCMC object -> Compile MCMC object -> run MCMC}

\CommentTok{# Constants and initial values --------------------------------------------------------------------------}

\CommentTok{# (1) Define constants that go into CAR prior into a list}
\NormalTok{Consts_ridge_}\DecValTok{03}\NormalTok{ =}\StringTok{ }\KeywordTok{list}\NormalTok{(}\DataTypeTok{N =} \KeywordTok{nrow}\NormalTok{(data.clean),                              }\CommentTok{# Number of areas}
                     \DataTypeTok{p =} \KeywordTok{ncol}\NormalTok{(data.clean[}\DecValTok{5}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(data.clean)]),            }\CommentTok{# Number of covariates}
                     \DataTypeTok{X =} \KeywordTok{as.matrix}\NormalTok{(data.clean[, }\KeywordTok{c}\NormalTok{(}\DecValTok{5}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(data.clean))]),  }\CommentTok{# Matrix of covariates}
                     \DataTypeTok{L =} \KeywordTok{length}\NormalTok{(adj}\FloatTok{.5}\NormalTok{),                       }\CommentTok{# Edges (length of adj vector)}
                     \DataTypeTok{E =}\NormalTok{ data.clean}\OperatorTok{$}\NormalTok{Expected,}
                     \DataTypeTok{adj =}\NormalTok{ adj}\FloatTok{.5}\NormalTok{,                             }\CommentTok{# Adjacency matrix}
                     \DataTypeTok{num =}\NormalTok{ num.nb}\FloatTok{.5}\NormalTok{,                          }\CommentTok{# Number of neighbors per district}
                     \DataTypeTok{weights =} \KeywordTok{rep}\NormalTok{(}\DecValTok{1}\NormalTok{, }\KeywordTok{length}\NormalTok{(adj}\FloatTok{.5}\NormalTok{)))         }\CommentTok{# Giving weight of 1 for neighbors}

\CommentTok{# (2) Define dependent variable (outcome)}
\NormalTok{outcome <-}\StringTok{ }\KeywordTok{list}\NormalTok{(}\DataTypeTok{y =}\NormalTok{ data.clean}\OperatorTok{$}\NormalTok{Cases) }\CommentTok{# Observed cases}

\CommentTok{# (3) Define initial values for the MCMC chain}
\NormalTok{Inits_ridge <-}\StringTok{ }\KeywordTok{list}\NormalTok{(}\DataTypeTok{beta0=}\DecValTok{0}\NormalTok{, }\DataTypeTok{beta=}\KeywordTok{rep}\NormalTok{(}\DecValTok{0}\NormalTok{, }\KeywordTok{ncol}\NormalTok{(data.clean[}\DecValTok{5}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(data.clean)])),}
                    \DataTypeTok{sigma=}\DecValTok{2}\NormalTok{, }\DataTypeTok{lambda=}\DecValTok{1}\NormalTok{, }\DataTypeTok{s=}\KeywordTok{rnorm}\NormalTok{(}\KeywordTok{nrow}\NormalTok{(data.clean)))}


\CommentTok{# Defining model ------------------------------------------------------------------------------}

\CommentTok{# (1) Define ridge nimble model}
\NormalTok{ridge03_model=}\KeywordTok{nimbleModel}\NormalTok{(}\DataTypeTok{code=}\NormalTok{ridge_code_bym, }\DataTypeTok{constants=}\NormalTok{Consts_ridge_}\DecValTok{03}\NormalTok{, }\DataTypeTok{data=}\NormalTok{outcome, }\DataTypeTok{inits=}\NormalTok{Inits_ridge)}

\CommentTok{# (2) Compile ridge model for nimble}
\NormalTok{ridge03_Cmodel=}\KeywordTok{compileNimble}\NormalTok{(ridge03_model)}

\CommentTok{# (3) Configure the MCMC chain}
\NormalTok{ridge03_conf <-}\StringTok{ }\KeywordTok{configureMCMC}\NormalTok{(ridge03_model, }
                              \DataTypeTok{monitors =} \KeywordTok{c}\NormalTok{(}\StringTok{'beta0'}\NormalTok{,}\StringTok{"beta"}\NormalTok{,}\StringTok{'sigma'}\NormalTok{, }\StringTok{"lambda"}\NormalTok{, }\StringTok{'s'}\NormalTok{))}

\CommentTok{# (4) Do something}
\NormalTok{ridge03_conf}\OperatorTok{$}\KeywordTok{printSamplers}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1]  RW sampler: beta0
## [2]  RW sampler: sigma
## [3]  RW sampler: lambda
## [4]  RW sampler: v[1]
## [5]  RW sampler: v[2]
## [6]  RW sampler: v[3]
## [7]  RW sampler: v[4]
## [8]  RW sampler: v[5]
## [9]  RW sampler: v[6]
## [10] RW sampler: v[7]
## [11] RW sampler: v[8]
## [12] RW sampler: v[9]
## [13] RW sampler: v[10]
## [14] RW sampler: v[11]
## [15] RW sampler: v[12]
## [16] RW sampler: v[13]
## [17] RW sampler: v[14]
## [18] RW sampler: v[15]
## [19] RW sampler: v[16]
## [20] RW sampler: v[17]
## [21] RW sampler: v[18]
## [22] RW sampler: beta[1]
## [23] RW sampler: beta[2]
## [24] RW sampler: beta[3]
## [25] RW sampler: beta[4]
## [26] RW sampler: beta[5]
## [27] RW sampler: beta[6]
## [28] RW sampler: beta[7]
## [29] RW sampler: beta[8]
## [30] CAR_normal sampler: s[1:18]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# (5) Build MCMC object}
\NormalTok{ridge03_MCMC=}\KeywordTok{buildMCMC}\NormalTok{(ridge03_conf, }\DataTypeTok{enableWAIC=}\NormalTok{T)}

\CommentTok{# (6) Compile model with MCMC object}
\NormalTok{ridge03_CMCMC=}\KeywordTok{compileNimble}\NormalTok{(ridge03_MCMC, }\DataTypeTok{project=}\NormalTok{ridge03_Cmodel)}

\CommentTok{# (7) Run the model}
\NormalTok{ridge03_runMCMC=}\KeywordTok{runMCMC}\NormalTok{(ridge03_CMCMC, }\DataTypeTok{nburnin=}\DecValTok{10000}\NormalTok{, }\DataTypeTok{niter=}\DecValTok{500000}\NormalTok{, }\DataTypeTok{nchains=}\DecValTok{2}\NormalTok{, }\DataTypeTok{thin=}\DecValTok{25}\NormalTok{, }\DataTypeTok{WAIC=}\NormalTok{T)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## |-------------|-------------|-------------|-------------|
## |-------------------------------------------------------|
## |-------------|-------------|-------------|-------------|
## |-------------------------------------------------------|
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# (8) Check convergence}
\NormalTok{ridge03_samples=}\KeywordTok{rbind}\NormalTok{(ridge03_runMCMC}\OperatorTok{$}\NormalTok{samples[[}\DecValTok{1}\NormalTok{]], ridge03_runMCMC}\OperatorTok{$}\NormalTok{samples[[}\DecValTok{2}\NormalTok{]])}

\CommentTok{# (9) WAIC ---------}
\NormalTok{ridge03_runMCMC}\OperatorTok{$}\NormalTok{WAIC}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 2086225
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# (10) Posterior summaries: Means and CrI  --------------------------------------------------------}

\CommentTok{#Betas}
\CommentTok{#Calculating the Beta means}
\NormalTok{means_betas_ridge03_bym <-}\StringTok{ }\KeywordTok{apply}\NormalTok{(ridge03_samples[,}\DecValTok{1}\OperatorTok{:}\DecValTok{9}\NormalTok{],}\DecValTok{2}\NormalTok{, mean)}

\CommentTok{#Calculating the Beta 95% CrI }
\NormalTok{CrI_betas_ridge03_bym <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{apply}\NormalTok{(ridge03_samples[ ,}\DecValTok{1}\OperatorTok{:}\DecValTok{9}\NormalTok{],}\DecValTok{2}\NormalTok{, }
                             \ControlFlowTok{function}\NormalTok{(x) }\KeywordTok{quantile}\NormalTok{(x, }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{,}\FloatTok{0.975}\NormalTok{))))}

\CommentTok{#Combining the means and CIs into a dataframe}
\NormalTok{mean_CrI_betas_ridge03_bym <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{matrix}\NormalTok{(}\KeywordTok{c}\NormalTok{(means_betas_ridge03_bym, CrI_betas_ridge03_bym), }
                                   \DataTypeTok{ncol=}\DecValTok{9}\NormalTok{, }\DataTypeTok{nrow =} \DecValTok{3}\NormalTok{, }\DataTypeTok{byrow=}\NormalTok{T)) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{()}

\CommentTok{#Renaming the columns}
\KeywordTok{colnames}\NormalTok{(mean_CrI_betas_ridge03_bym) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Mean"}\NormalTok{, }\StringTok{"95% CrI LL"}\NormalTok{, }\StringTok{"95% CrI UL"}\NormalTok{)}

\CommentTok{# Converting means and CrIs from log to regular scale}
\KeywordTok{exp}\NormalTok{(mean_CrI_betas_ridge03_bym)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##        Mean 95% CrI LL 95% CrI UL
## 1 1.0737051  0.6892273   1.837755
## 2 1.0185369  0.3865993   2.935563
## 3 1.0279481  0.4069723   2.998977
## 4 0.9990122  0.3631777   2.780924
## 5 1.0153718  0.3861020   2.915735
## 6 1.0003693  0.3687238   2.737666
## 7 0.8722744  0.7414272   1.012057
## 8 1.0002371  0.9988869   1.001631
## 9 9.1523620  0.4167006 240.977884
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{################### Spatial effects per region}

\CommentTok{#Calculating the S means}
\NormalTok{means_s_ridge03_bym <-}\StringTok{ }\KeywordTok{apply}\NormalTok{(ridge03_samples[ ,}\DecValTok{11}\OperatorTok{:}\DecValTok{28}\NormalTok{],}\DecValTok{2}\NormalTok{, mean)}

\CommentTok{#Calculating the Beta 95% CrI }
\NormalTok{CrI_s_ridge03_bym <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{apply}\NormalTok{(ridge03_samples[ ,}\DecValTok{11}\OperatorTok{:}\DecValTok{28}\NormalTok{],}\DecValTok{2}\NormalTok{, }
                         \ControlFlowTok{function}\NormalTok{(x) }\KeywordTok{quantile}\NormalTok{(x, }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{,}\FloatTok{0.975}\NormalTok{))))}

\CommentTok{#Combining the means and CIs into a dataframe}
\NormalTok{mean_CrI_s_ridge03_bym <-}\StringTok{ }\KeywordTok{cbind}\NormalTok{(means_s_ridge03_bym, CrI_s_ridge03_bym) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{()}

\CommentTok{#Renaming the columns}
\KeywordTok{colnames}\NormalTok{(mean_CrI_s_ridge03_bym) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Mean"}\NormalTok{, }\StringTok{"95% CrI LL"}\NormalTok{, }\StringTok{"95% CrI UL"}\NormalTok{)}

\CommentTok{# Converting means and CrIs from log to regular scale}
\KeywordTok{exp}\NormalTok{(mean_CrI_s_ridge03_bym)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##            Mean 95% CrI LL 95% CrI UL
## s[1]  1.5111925  0.5660522   4.962888
## s[2]  1.1606309  0.3398435   4.034461
## s[3]  1.1141096  0.3836966   3.412446
## s[4]  0.9224249  0.3958551   1.980658
## s[5]  0.8431160  0.3379724   1.909096
## s[6]  1.1583941  0.4601869   3.140584
## s[7]  0.9465564  0.3066193   3.014457
## s[8]  0.6501361  0.2042977   1.767610
## s[9]  0.8465299  0.3197035   2.117235
## s[10] 0.9444615  0.3712046   2.286117
## s[11] 1.8433162  0.6542995   6.199880
## s[12] 0.8016633  0.3120131   1.950336
## s[13] 0.7719807  0.3075384   1.670695
## s[14] 0.9811158  0.3395334   2.869373
## s[15] 1.8043838  0.6469190   6.391305
## s[16] 0.7300618  0.2449882   1.723329
## s[17] 1.5105003  0.6627595   4.493016
## s[18] 0.5184158  0.1282381   1.568925
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{################### Sigma}

\CommentTok{#Calculating the sigma means}
\NormalTok{means_sigma_ridge03_bym <-}\StringTok{ }\KeywordTok{mean}\NormalTok{(ridge03_samples[ ,}\DecValTok{29}\NormalTok{])}

\CommentTok{#Calculating the Beta 95% CrI }
\NormalTok{CrI_sigma_ridge03_bym <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{quantile}\NormalTok{(ridge03_samples[ ,}\DecValTok{29}\NormalTok{], }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{,}\FloatTok{0.975}\NormalTok{)))}

\CommentTok{#Combining the means and CIs into a dataframe}
\NormalTok{mean_CrI_sigma_ridge03_bym <-}\StringTok{ }\KeywordTok{cbind}\NormalTok{(means_sigma_ridge03_bym, CrI_sigma_ridge03_bym) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{()}

\CommentTok{#Renaming the columns}
\KeywordTok{colnames}\NormalTok{(mean_CrI_sigma_ridge03_bym) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Mean"}\NormalTok{, }\StringTok{"95% CrI LL"}\NormalTok{, }\StringTok{"95% CrI UL"}\NormalTok{)}

\CommentTok{# Consigmaerting means and CrIs from log to regular scale}
\KeywordTok{exp}\NormalTok{(mean_CrI_sigma_ridge03_bym)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##       Mean 95% CrI LL 95% CrI UL
## 1 4.636551   1.886356   16.53053
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{################## Lambda}

\NormalTok{mean_beta0_ridge03_bym <-}\StringTok{ }\KeywordTok{mean}\NormalTok{(ridge03_samples[ ,}\StringTok{"lambda"}\NormalTok{])}

\CommentTok{#Calculating the Beta 95% CrI }
\NormalTok{CrI_beta0_ridge03_bym <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{quantile}\NormalTok{(ridge03_samples[ , }\StringTok{"lambda"}\NormalTok{], }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{,}\FloatTok{0.975}\NormalTok{)))}

\CommentTok{#Combining the means and CIs into a dataframe}
\NormalTok{mean_CrI_beta0_ridge03_bym <-}\StringTok{ }\KeywordTok{cbind}\NormalTok{(mean_beta0_ridge03_bym, CrI_beta0_ridge03_bym) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{()}

\CommentTok{#Renaming the columns}
\KeywordTok{colnames}\NormalTok{(mean_CrI_beta0_ridge03_bym) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Mean"}\NormalTok{, }\StringTok{"95% CrI LL"}\NormalTok{, }\StringTok{"95% CrI UL"}\NormalTok{)}

\CommentTok{# Converting means and CrIs from log to regular scale}
\KeywordTok{exp}\NormalTok{(mean_CrI_beta0_ridge03_bym)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##           Mean 95% CrI LL 95% CrI UL
## 1 2.776118e+39   2.247978        Inf
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# (11) Fitted values -----------------------------------------------------------------------------}

\CommentTok{#Creating matrix to store fitted values}
\NormalTok{fitted_ridge03_bym =}\StringTok{ }\KeywordTok{matrix}\NormalTok{(}\OtherTok{NA}\NormalTok{, }\DataTypeTok{nrow=}\KeywordTok{nrow}\NormalTok{(ridge03_samples), }\DataTypeTok{ncol=} \KeywordTok{nrow}\NormalTok{(data.clean))}

\CommentTok{# Creating matrix to store fitted values}
\NormalTok{fitted_ridge03 =}\StringTok{ }\KeywordTok{matrix}\NormalTok{(}\OtherTok{NA}\NormalTok{, }\DataTypeTok{nrow=}\KeywordTok{nrow}\NormalTok{(ridge03_samples), }\DataTypeTok{ncol=} \KeywordTok{nrow}\NormalTok{(data.clean))}

\CommentTok{# Loop to generate fitted values: log(ri)}
\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{nrow}\NormalTok{(data.clean))\{}
\NormalTok{  fitted_ridge03_bym[,i] =}\StringTok{ }\NormalTok{ridge03_samples[,}\StringTok{"beta0"}\NormalTok{] }
                      \OperatorTok{+}\StringTok{ }\KeywordTok{as.matrix}\NormalTok{(data.clean[i,}\DecValTok{5}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(data.clean)]) }\OperatorTok{%*%}\StringTok{ }\KeywordTok{t}\NormalTok{(ridge03_samples[,}\DecValTok{1}\OperatorTok{:}\DecValTok{8}\NormalTok{])}
                      \OperatorTok{+}\StringTok{ }\KeywordTok{log}\NormalTok{(data.clean}\OperatorTok{$}\NormalTok{Expected[i])}
                      \OperatorTok{+}\StringTok{ }\NormalTok{ridge03_samples[, }\DecValTok{7}\OperatorTok{+}\NormalTok{i}\DecValTok{-1}\NormalTok{] \}}

\CommentTok{# Fitted values - distribution}
\NormalTok{fitted_car_ridge_}\DecValTok{03}\NormalTok{_dist_bym <-}\StringTok{ }\KeywordTok{exp}\NormalTok{(fitted_ridge03_bym)}

\CommentTok{# Mean fitted values}
\NormalTok{fitted_car_ridge_}\DecValTok{03}\NormalTok{_mean_bym <-}\StringTok{ }\KeywordTok{apply}\NormalTok{(fitted_car_ridge_}\DecValTok{03}\NormalTok{_dist_bym, }\DecValTok{2}\NormalTok{, mean)}

\CommentTok{# 95% CrI}
\NormalTok{fitted_bym_ridge_}\DecValTok{03}\NormalTok{_CrI <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{apply}\NormalTok{(fitted_car_ridge_}\DecValTok{03}\NormalTok{_dist_bym, }\DecValTok{2}\NormalTok{, }
                                   \ControlFlowTok{function}\NormalTok{(x) }\KeywordTok{quantile}\NormalTok{(x, }\DataTypeTok{probs=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{, }\FloatTok{0.975}\NormalTok{))))}

\CommentTok{# Fitted values - distribution}
\NormalTok{fitted_bym_ridge_}\DecValTok{03}\NormalTok{_dist <-}\StringTok{ }\NormalTok{data.clean}\OperatorTok{$}\NormalTok{Expected }\OperatorTok{*}\StringTok{ }\KeywordTok{exp}\NormalTok{(fitted_ridge03)}

\CommentTok{# Mean fitted SIR}
\NormalTok{fitted_SIR_ridge03 <-}\StringTok{ }\KeywordTok{exp}\NormalTok{(}\KeywordTok{apply}\NormalTok{(fitted_ridge03, }\DecValTok{2}\NormalTok{, mean))}

\CommentTok{# Mean fitted Cases}
\NormalTok{fitted_ridge_}\DecValTok{03}\NormalTok{ <-}\StringTok{ }\NormalTok{fitted_SIR_ridge03}\OperatorTok{*}\NormalTok{data.clean}\OperatorTok{$}\NormalTok{Expected}

\CommentTok{# Creating Dataframe to store fitted values and quantiles in regular svale}
\NormalTok{fitted_ridge03_df_bym <-}\StringTok{ }\KeywordTok{cbind}\NormalTok{(fitted_car_ridge_}\DecValTok{03}\NormalTok{_mean_bym, fitted_bym_ridge_}\DecValTok{03}\NormalTok{_CrI)}

\CommentTok{# Renaming columns}
\KeywordTok{colnames}\NormalTok{(fitted_ridge03_df_bym) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"fitted_mean_ridge03"}\NormalTok{, }\StringTok{"fitted_lower_ridge03"}\NormalTok{ , }\StringTok{"fitted_upper_ridge03"}\NormalTok{)}

\CommentTok{# Top 6 rows}
\KeywordTok{head}\NormalTok{(fitted_ridge03_df_bym)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      fitted_mean_ridge03 fitted_lower_ridge03 fitted_upper_ridge03
## [1,]            38.28856            0.4167006             240.9779
## [2,]            38.28856            0.4167006             240.9779
## [3,]            38.28856            0.4167006             240.9779
## [4,]            38.28856            0.4167006             240.9779
## [5,]            38.28856            0.4167006             240.9779
## [6,]            38.28856            0.4167006             240.9779
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Predicted vs observed cases}
\KeywordTok{cbind}\NormalTok{(data.clean}\OperatorTok{$}\NormalTok{Cases,fitted_ridge03_df_bym)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##          fitted_mean_ridge03 fitted_lower_ridge03 fitted_upper_ridge03
##  [1,] 42            38.28856            0.4167006             240.9779
##  [2,] 43            38.28856            0.4167006             240.9779
##  [3,]  9            38.28856            0.4167006             240.9779
##  [4,] 14            38.28856            0.4167006             240.9779
##  [5,] 12            38.28856            0.4167006             240.9779
##  [6,] 20            38.28856            0.4167006             240.9779
##  [7,] 10            38.28856            0.4167006             240.9779
##  [8,] 15            38.28856            0.4167006             240.9779
##  [9,] 22            38.28856            0.4167006             240.9779
## [10,] 10            38.28856            0.4167006             240.9779
## [11,] 50            38.28856            0.4167006             240.9779
## [12,] 15            38.28856            0.4167006             240.9779
## [13,]  8            38.28856            0.4167006             240.9779
## [14,] 21            38.28856            0.4167006             240.9779
## [15,] 50            38.28856            0.4167006             240.9779
## [16,]  4            38.28856            0.4167006             240.9779
## [17,] 62            38.28856            0.4167006             240.9779
## [18,]  4            38.28856            0.4167006             240.9779
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# 95% CrI SIR}
\CommentTok{# fitted_ridge_03_CrI_SIR <- t(exp(apply(fitted_ridge03, 2, }
\CommentTok{#                                       function(x) quantile(x, probs=c(0.025, 0.975)))))}

\CommentTok{# 95% CrI Cases}
\CommentTok{# fitted_ridge_03_CrI <-  data.clean$Expected *fitted_ridge_03_CrI_SIR}

\CommentTok{# Creating Dataframe to store fitted values and quantiles in regular svale}
\CommentTok{# fitted_ridge03_df <- data.frame("Observed SIR"   =  round(data.clean$SIR, 2), }
\CommentTok{#                                 "Fitted SIR"     =  round(fitted_SIR_ridge03,2), }
\CommentTok{#                                 "Observed Cases" =  round(data.clean$Cases), }
\CommentTok{#                                 "Fitted Cases" =  round(fitted_ridge_03), }
\CommentTok{#                                 "CrI LL"    =  round(fitted_ridge_03_CrI[,1]),}
\CommentTok{#                                 "CrI UL"    =  round(fitted_ridge_03_CrI[,2]))}
\CommentTok{# Top 6 rows}
\CommentTok{# head(fitted_ridge03_df)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Ridge BYM K5 MCMC chains-1} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Ridge BYM K5 MCMC chains-2} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Ridge BYM K5 MCMC chains-3} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Ridge BYM K5 MCMC chains-4} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Ridge BYM K5 MCMC chains-5} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Ridge BYM K5 Posterior density curves-1} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Ridge BYM K5 Posterior density curves-2} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Ridge BYM K5 Posterior density curves-3} \end{center}

\begin{center}\includegraphics{Spatial-Epi-Final-Project_files/figure-latex/Ridge BYM K5 Posterior density curves-4} \end{center}

\hypertarget{summary-of-inferential-results---icar-bymcar-ridge-3-pages}{%
\section{Summary of Inferential Results - iCAR, BYMCAR, Ridge (3
pages)}\label{summary-of-inferential-results---icar-bymcar-ridge-3-pages}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# WAIC by ICAR model}
\NormalTok{WAIC.iCAR <-}\StringTok{ }\KeywordTok{cbind}\NormalTok{(}\DataTypeTok{Adjescent=}\NormalTok{ usual01_runMCMC}\OperatorTok{$}\NormalTok{WAIC, }\DataTypeTok{K3=}\NormalTok{ usual02_runMCMC}\OperatorTok{$}\NormalTok{WAIC,}\DataTypeTok{K5=}\NormalTok{ usual03_runMCMC}\OperatorTok{$}\NormalTok{WAIC)}
\NormalTok{WAIC.iCAR}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      Adjescent       K3       K5
## [1,]  117.9545 116.3871 117.4307
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# WAIC by BYM CAR model}
\NormalTok{WAIC.bymCAR <-}\StringTok{ }\KeywordTok{cbind}\NormalTok{(}\DataTypeTok{Adjescent=}\NormalTok{ bym_usual01_runMCMC}\OperatorTok{$}\NormalTok{WAIC, }\DataTypeTok{K3=}\NormalTok{ bym_usual02_runMCMC}\OperatorTok{$}\NormalTok{WAIC,}\DataTypeTok{K5=}\NormalTok{ bym_usual03_runMCMC}\OperatorTok{$}\NormalTok{WAIC)}
\NormalTok{WAIC.bymCAR}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      Adjescent       K3       K5
## [1,]  118.0836 116.6764 117.9149
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# WAIC by Ridge model}
\NormalTok{WAIC.Ridge <-}\StringTok{ }\KeywordTok{cbind}\NormalTok{(}\DataTypeTok{Adjescent =}\NormalTok{ ridge01_runMCMC}\OperatorTok{$}\NormalTok{WAIC,  }\DataTypeTok{K3=}\NormalTok{ ridge02_runMCMC}\OperatorTok{$}\NormalTok{WAIC,  }\DataTypeTok{K5 =}\NormalTok{ ridge03_runMCMC}\OperatorTok{$}\NormalTok{WAIC)}
\NormalTok{WAIC.Ridge}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      Adjescent       K3      K5
## [1,]   2833381 809882.2 2086225
\end{verbatim}

\hypertarget{conclusion-1-page}{%
\section{Conclusion (1 page)}\label{conclusion-1-page}}

\hypertarget{appendix}{%
\section{Appendix}\label{appendix}}

\hypertarget{archive}{%
\section{Archive}\label{archive}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Poisson regression}
\CommentTok{#poi.fit <- glm(Cases ~ Pop_density + Prop_labor + Prop_0.24 + Prop_25.64 + Prop_65 + Prop_female +  Log_postsec +  beds_per_hosp  + household_poverty_rate + offset(log(Expected)), data = data.clean, family = poisson(link="log"))}
\end{Highlighting}
\end{Shaded}

\end{document}
